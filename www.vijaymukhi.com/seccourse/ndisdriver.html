<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">


<!-- Mirrored from www.vijaymukhi.com/seccourse/ndisdriver.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:42:10 GMT -->
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 9">
<meta name=Originator content="Microsoft Word 9">
<link rel=File-List href="ndisdriver_files/filelist.html">
<title>NDIS Driver</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Vijay Mukhi</o:Author>
  <o:Template>Normal</o:Template>
  <o:LastAuthor>Vijay Mukhi</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>2</o:TotalTime>
  <o:Created>2005-06-28T10:12:00Z</o:Created>
  <o:LastSaved>2005-06-28T10:12:00Z</o:LastSaved>
  <o:Pages>5</o:Pages>
  <o:Words>941</o:Words>
  <o:Characters>5367</o:Characters>
  <o:Company>VMCI</o:Company>
  <o:Lines>44</o:Lines>
  <o:Paragraphs>10</o:Paragraphs>
  <o:CharactersWithSpaces>6591</o:CharactersWithSpaces>
  <o:Version>9.2720</o:Version>
 </o:DocumentProperties>
</xml><![endif]-->
<style>
<!--
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.0in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
</head>

<body lang=EN-US style='tab-interval:.5in'>

<div class=Section1>

<p class=MsoNormal>NDIS Driver</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>In C:\driver2</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>b.bat</p>

<p class=MsoNormal>del c:\winnt\system32\drivers\npf.sys</p>

<p class=MsoNormal>del *.obj</p>

<p class=MsoNormal>del *.res</p>

<p class=MsoNormal>del *.sys</p>

<p class=MsoNormal>cl -nologo -Ii386\ -I. -IC:\WINDDK\2600~1.110\inc\mfc42
-I..\..\common -Iobjchk_wxp_x86\i386 -IC:\WINDDK\2600~1.110\inc\wxp
-IC:\WINDDK\2600~1.110\inc\wxp -IC:\WINDDK\2600~1.110\inc\ddk\wxp
-IC:\WINDDK\2600~1.110\inc\ddk\wdm\wxp -IC:\WINDDK\2600~1.110\inc\crt -D_X86_=1
-Di386=1<span style="mso-spacerun: yes">  </span>-DSTD_CALL
-DCONDITION_HANDLING=1<span style="mso-spacerun: yes">   </span>-DNT_INST=0 -DWIN32=100
-D_NT1X_=100 -DWINNT=1 -D_WIN32_WINNT=0x0501 /DWINVER=0x0501 -D_WIN32_IE=0x0600<span
style="mso-spacerun: yes">    </span>-DWIN32_LEAN_AND_MEAN=1 -DDBG=1 -DDEVL=1
-D__BUILDMACHINE__=WinDDK -DFPO=0<span style="mso-spacerun: yes"> 
</span>-DNDEBUG -D_DLL=1<span style="mso-spacerun: yes">  </span>-DNDIS50
-DWIN_NT_DRIVER -DWIN32_EXT -DKQPC_TS /c /Zel /Zp8 /Gy -cbstring /W3 /WX
/Gz<span style="mso-spacerun: yes">  </span>/QIfdiv- /QIf /G6 /Gi- /Gm-
/GX-<span style="mso-spacerun: yes">  </span>/GR- /GF<span style="mso-spacerun:
yes">  </span>-Z7 /Od /Oi /Oy- <span style="mso-spacerun:
yes">  </span>-FIC:\WINDDK\2600~1.110\inc\wxp\warning.h<span
style="mso-spacerun: yes">   </span>r.c</p>

<p class=MsoNormal>link -out:npf.sys -machine:ix86 -MERGE:_PAGE=PAGE
-MERGE:_TEXT=.text -SECTION:INIT,d -OPT:REF -OPT:ICF
-IGNORE:4010,4037,4039,4065,4070,4078,4087,4089,4198,4221 -INCREMENTAL:NO
-FULLBUILD /release -NODEFAULTLIB /WX -debug:FULL -debugtype:cv -version:5.1
-osversion:5.1 /opt:nowin98 -STACK:0x40000,0x1000 -driver -base:0x10000
-align:0x80 -subsystem:native,5.01 -entry:DriverEntry@8 -out:npf.sys r.obj
C:\WINDDK\2600~1.110\lib\wxp\i386\ntoskrnl.lib C:\WINDDK\2600~1.110\lib\wxp\i386\hal.lib
C:\WINDDK\2600~1.110\lib\wxp\i386\wmilib.lib
C:\WINDDK\2600~1.110\lib\wxp\i386\ndis.lib </p>

<p class=MsoNormal>copy npf.sys c:\winnt\system32\drivers\</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>r.c</p>

<p class=MsoNormal>#include &lt;ntddk.h&gt;</p>

<p class=MsoNormal>#include &lt;ndis.h&gt;</p>

<p class=MsoNormal>NDIS_MEDIUM MediumArray[] = { NdisMedium802_3 };</p>

<p class=MsoNormal>NDIS_HANDLE NdisProtocolHandle,AdapterHandle;</p>

<p class=MsoNormal>NDIS_PROTOCOL_CHARACTERISTICS<span style="mso-spacerun:
yes">  </span>pchar;</p>

<p class=MsoNormal>NTSTATUS Status;</p>

<p class=MsoNormal>PDEVICE_OBJECT devObjP;</p>

<p class=MsoNormal>UNICODE_STRING deviceName,deviceSymLink,pname,a;</p>

<p class=MsoNormal>PIRP Irp1;</p>

<p class=MsoNormal>UINT Medium,MaxFrameSize,i=32;</p>

<p class=MsoNormal>NDIS_REQUEST Request; </p>

<p class=MsoNormal>NTSTATUS NPF_Open(PDEVICE_OBJECT DeviceObject,PIRP Irp)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>Irp1 = Irp;</p>

<p class=MsoNormal>IoMarkIrpPending(Irp);</p>

<p class=MsoNormal>RtlInitUnicodeString(&amp;a,
L&quot;\\Device\\{4CF02894-1CD0-420D-B69B-36983F508F1C}&quot;);</p>

<p class=MsoNormal>NdisOpenAdapter(&amp;Status,&amp;Status,&amp;AdapterHandle,&amp;Medium,MediumArray,1,NdisProtocolHandle,0,&amp;a,0,0);</p>

<p class=MsoNormal>DbgPrint(&quot;NPF_Open Status=%d
%d&quot;,Status,STATUS_PENDING);</p>

<p class=MsoNormal>return(STATUS_PENDING);</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>VOID NPF_OpenAdapterComplete(NDIS_HANDLE<span
style="mso-spacerun: yes">  </span>ProtocolBindingContext,NDIS_STATUS<span
style="mso-spacerun: yes">  </span>Status,NDIS_STATUS<span style="mso-spacerun:
yes">  </span>OpenErrorStatus)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>Request.RequestType = NdisRequestQueryInformation;</p>

<p class=MsoNormal>Request.DATA.QUERY_INFORMATION.Oid =
OID_GEN_MAXIMUM_TOTAL_SIZE;</p>

<p class=MsoNormal>Request.DATA.QUERY_INFORMATION.InformationBuffer =
&amp;MaxFrameSize;</p>

<p class=MsoNormal>Request.DATA.QUERY_INFORMATION.InformationBufferLength = 4;</p>

<p class=MsoNormal>NdisRequest(&amp;Status,AdapterHandle,&amp;Request);</p>

<p class=MsoNormal>Request.RequestType=NdisRequestSetInformation;</p>

<p class=MsoNormal>Request.DATA.SET_INFORMATION.Oid=OID_GEN_CURRENT_PACKET_FILTER;</p>

<p class=MsoNormal>Request.DATA.SET_INFORMATION.InformationBuffer=&amp;i;</p>

<p class=MsoNormal>Request.DATA.SET_INFORMATION.InformationBufferLength=4;</p>

<p class=MsoNormal>NdisRequest(&amp;Status,AdapterHandle,&amp;Request);</p>

<p class=MsoNormal>DbgPrint(&quot;NPF_OpenAdapterComplete MaxFrameSize=%d
i=%d&quot;,MaxFrameSize,i);</p>

<p class=MsoNormal>return;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>VOID NPF_RequestComplete(NDIS_HANDLE
ProtocolBindingContext,PNDIS_REQUEST NdisRequest,NDIS_STATUS Status)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>DbgPrint(&quot;NPF_RequestComplete&quot;);</p>

<p class=MsoNormal>IoCompleteRequest(Irp1, IO_NO_INCREMENT);</p>

<p class=MsoNormal>return;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>NTSTATUS NPF_IoControl(PDEVICE_OBJECT DeviceObject,PIRP Irp)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>DbgPrint(&quot;NPF_IoControl&quot;);</p>

<p class=MsoNormal>return STATUS_SUCCESS;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>NDIS_STATUS NPF_tap (NDIS_HANDLE
ProtocolBindingContext,NDIS_HANDLE MacReceiveContext,PVOID HeaderBuffer,UINT
HeaderBufferSize,PVOID LookaheadBuffer,UINT LookaheadBufferSize,UINT
PacketSize)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>unsigned char *p;</p>

<p class=MsoNormal>p = HeaderBuffer;</p>

<p class=MsoNormal>DbgPrint(&quot;%02x:%02x:%02x:%02x:%02x:%02x --&gt;
%02x:%02x:%02x:%02x:%02x:%02x
Type:%02x%02x\n&quot;,p[6],p[7],p[8],p[9],p[10],p[11],p[0],p[1],p[2],p[3],p[4],p[5],p[12],p[13]);</p>

<p class=MsoNormal>DbgPrint(&quot;%02x %d.%d.%d.%d --&gt; %d.%d.%d.%d
Len=%d\n&quot;,p[14],p[26],p[27],p[28],p[29],p[30],p[31],p[32],p[33],p[16]*256+p[17]);</p>

<p class=MsoNormal>return NDIS_STATUS_NOT_ACCEPTED;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>VOID NPF_ReceiveComplete(NDIS_HANDLE ProtocolBindingContext)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>DbgPrint(&quot;NPF_ReceiveComplete&quot;);</p>

<p class=MsoNormal>return;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal>NTSTATUS DriverEntry(PDRIVER_OBJECT
DriverObject,PUNICODE_STRING RegistryPath)</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>DbgPrint(&quot;Vijay Mukhi2&quot;);</p>

<p class=MsoNormal>RtlInitUnicodeString(&amp;pname, L&quot;PacketDriver&quot;);</p>

<p class=MsoNormal>pchar.MajorNdisVersion = 3;</p>

<p class=MsoNormal>pchar.OpenAdapterCompleteHandler = NPF_OpenAdapterComplete;</p>

<p class=MsoNormal>pchar.RequestCompleteHandler = NPF_RequestComplete;</p>

<p class=MsoNormal>pchar.ReceiveHandler = NPF_tap;</p>

<p class=MsoNormal>pchar.ReceiveCompleteHandler = NPF_ReceiveComplete;</p>

<p class=MsoNormal>pchar.Name = pname;</p>

<p class=MsoNormal>NdisRegisterProtocol(&amp;Status,&amp;NdisProtocolHandle,&amp;pchar,sizeof(pchar));</p>

<p class=MsoNormal>DriverObject-&gt;MajorFunction[IRP_MJ_CREATE] = NPF_Open;</p>

<p class=MsoNormal>DriverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]<span
style="mso-spacerun: yes">  </span>= NPF_IoControl;</p>

<p class=MsoNormal>RtlInitUnicodeString(&amp;deviceName,
L&quot;\\Device\\NPF_{4CF02894-1CD0-420D-B69B-36983F508F1C}&quot;);</p>

<p class=MsoNormal>RtlInitUnicodeString(&amp;deviceSymLink,
L&quot;\\DosDevices\\NPF_{4CF02894-1CD0-420D-B69B-36983F508F1C}&quot;);</p>

<p class=MsoNormal>IoCreateDevice(DriverObject, 0,&amp;deviceName,
FILE_DEVICE_TRANSPORT,0 , FALSE,&amp;devObjP);</p>

<p class=MsoNormal>IoCreateSymbolicLink(&amp;deviceSymLink,&amp;deviceName);</p>

<p class=MsoNormal>return STATUS_SUCCESS;</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>z.bat</p>

<p class=MsoNormal>del y.exe</p>

<p class=MsoNormal>cl y.c<span style="mso-spacerun: yes">  </span>advapi32.lib</p>

<p class=MsoNormal>y</p>

<p class=MsoNormal>ping 70.0.0.2</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>y.c</p>

<p class=MsoNormal>#include &lt;windows.h&gt;</p>

<p class=MsoNormal>HANDLE hFile;</p>

<p class=MsoNormal>SC_HANDLE svcHandle,srvHandle,scmHandle;</p>

<p class=MsoNormal>ULONG BytesReturned;</p>

<p class=MsoNormal>main()</p>

<p class=MsoNormal>{</p>

<p class=MsoNormal>scmHandle = OpenSCManager(NULL, NULL,
SC_MANAGER_ALL_ACCESS);</p>

<p class=MsoNormal>svcHandle =
CreateService(scmHandle,&quot;NPF&quot;,&quot;Vijay&quot;,SERVICE_ALL_ACCESS,SERVICE_KERNEL_DRIVER,SERVICE_DEMAND_START,SERVICE_ERROR_NORMAL,&quot;C:\\winnt\\system32\\drivers\\npf.sys&quot;,NULL,
NULL, NULL, NULL, NULL);</p>

<p class=MsoNormal>srvHandle = OpenService(scmHandle, &quot;NPF&quot;,
SERVICE_START);</p>

<p class=MsoNormal>StartService(srvHandle, 0, NULL);</p>

<p class=MsoNormal>hFile=CreateFile(&quot;\\\\.\\Global\\NPF_{4CF02894-1CD0-420D-B69B-36983F508F1C}&quot;,GENERIC_WRITE
| GENERIC_READ,0,NULL,OPEN_EXISTING,0,0);</p>

<p class=MsoNormal>printf(&quot;lpAdapter-&gt;hFile=%x\n&quot;,hFile);</p>

<p class=MsoNormal>DeviceIoControl(hFile,(DWORD)4,0,0,0,0,&amp;BytesReturned,0);</p>

<p class=MsoNormal>}</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal>Vijay Mukhi2</p>

<p class=MsoNormal>NPF_Open Status=259 259</p>

<p class=MsoNormal>NPF_RequestComplete</p>

<p class=MsoNormal>NPF_IoControl</p>

<p class=MsoNormal>NPF_RequestComplete</p>

<p class=MsoNormal>NPF_OpenAdapterComplete MaxFrameSize=1514 i=32</p>

<p class=MsoNormal>00:00:e8:df:a4:66 --&gt; 00:00:e8:d7:5e:7c Type:0800</p>

<p class=MsoNormal>45 70.0.0.10 --&gt; 70.0.0.2 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:d7:5e:7c --&gt; 00:00:e8:df:a4:66 Type:0800</p>

<p class=MsoNormal>45 70.0.0.2 --&gt; 70.0.0.10 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:df:a4:66 --&gt; 00:00:e8:d7:5e:7c Type:0800</p>

<p class=MsoNormal>45 70.0.0.10 --&gt; 70.0.0.2 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:d7:5e:7c --&gt; 00:00:e8:df:a4:66 Type:0800</p>

<p class=MsoNormal>45 70.0.0.2 --&gt; 70.0.0.10 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:df:a4:66 --&gt; 00:00:e8:d7:5e:7c Type:0800</p>

<p class=MsoNormal>45 70.0.0.10 --&gt; 70.0.0.2 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:d7:5e:7c --&gt; 00:00:e8:df:a4:66 Type:0800</p>

<p class=MsoNormal>45 70.0.0.2 --&gt; 70.0.0.10 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:df:a4:66 --&gt; 00:00:e8:d7:5e:7c Type:0800</p>

<p class=MsoNormal>45 70.0.0.10 --&gt; 70.0.0.2 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal>00:00:e8:d7:5e:7c --&gt; 00:00:e8:df:a4:66 Type:0800</p>

<p class=MsoNormal>45 70.0.0.2 --&gt; 70.0.0.10 Len=60</p>

<p class=MsoNormal>NPF_ReceiveComplete</p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoNormal><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

</div>

</body>


<!-- Mirrored from www.vijaymukhi.com/seccourse/ndisdriver.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:42:11 GMT -->
</html>
