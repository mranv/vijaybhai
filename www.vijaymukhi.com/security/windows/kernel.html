<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">


<!-- Mirrored from www.vijaymukhi.com/security/windows/kernel.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:40:18 GMT -->
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 9">
<meta name=Originator content="Microsoft Word 9">
<link rel=File-List href="kernel_files/filelist.xml">
<title>Kernal32.dll</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Mr. Vijay Mukhi</o:Author>
  <o:LastAuthor>Mr. Vijay Mukhi</o:LastAuthor>
  <o:Revision>19</o:Revision>
  <o:TotalTime>116</o:TotalTime>
  <o:LastPrinted>2003-12-28T05:39:00Z</o:LastPrinted>
  <o:Created>2004-06-07T12:54:00Z</o:Created>
  <o:LastSaved>2004-03-29T11:50:00Z</o:LastSaved>
  <o:Pages>19</o:Pages>
  <o:Words>6941</o:Words>
  <o:Characters>39567</o:Characters>
  <o:Company>VMCI</o:Company>
  <o:Lines>329</o:Lines>
  <o:Paragraphs>79</o:Paragraphs>
  <o:CharactersWithSpaces>48591</o:CharactersWithSpaces>
  <o:Version>9.2720</o:Version>
 </o:DocumentProperties>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
@font-face
	{font-family:"MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"\FF2D\FF33 \660E\671D";
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:"\@MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:"Palatino Linotype";
	panose-1:2 4 5 2 5 5 5 3 3 4;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-536870009 1073741843 0 0 415 0;}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
h1
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:10.5pt;
	mso-bidi-font-size:12.0pt;
	font-family:"Times New Roman";
	mso-font-kerning:0pt;
	font-weight:normal;
	text-decoration:underline;
	text-underline:single;}
h6
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:3.0pt;
	margin-left:0in;
	mso-pagination:widow-orphan;
	mso-outline-level:6;
	font-size:11.0pt;
	font-family:"Times New Roman";}
p.MsoFooter, li.MsoFooter, div.MsoFooter
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	tab-stops:center 3.0in right 6.0in;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p.MsoPlainText, li.MsoPlainText, div.MsoPlainText
	{margin:0in;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";}
@page Section1
	{size:8.5in 11.0in;
	margin:1.0in 65.95pt 1.0in 65.95pt;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-page-numbers:183;
	mso-even-footer:url("kernel_files/header.html") ef1;
	mso-footer:url("kernel_files/header.html") f1;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="1027">
  <o:colormru v:ext="edit" colors="#fafaff"/>
  <o:colormenu v:ext="edit" fillcolor="#fafaff"/>
 </o:shapedefaults></xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body bgcolor="#fafaff" lang=EN-US link=blue vlink=purple style='tab-interval:
.5in'>

<div class=Section1>

<table border=1 cellspacing=0 cellpadding=0 width="99%" bgcolor="#eeeeff"
 style='width:99.54%;background:#EEEEFF;border-collapse:collapse;border:none;
 mso-border-alt:solid windowtext .5pt;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='height:15.1pt'>
  <td width="100%" valign=top style='width:100.0%;border:solid windowtext .5pt;
  padding:0in 5.4pt 0in 5.4pt;height:15.1pt'>
  <h6 align=center style='margin:0in;margin-bottom:.0001pt;text-align:center;
  page-break-after:avoid'><span style='mso-bidi-font-size:10.0pt;color:#000066;
  mso-text-raise:3.0pt;letter-spacing:1.0pt'>Locating Kernal32.dll in memory</span><sup><o:p></o:p></sup></h6>
  </td>
 </tr>
</table>

<p class=MsoNormal><sup><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></sup></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Windows programming
basically, is calling code from dlls. For this purpose, it is extremely
important to have the address of the function that is to be called. However,
before executing code at the address, we need to know the location of the dll
in memory. There are two functions in kernel32.dll, which simplify this task:
LoadLibrary to acquire the address of the dll in memory and GetProcAddress to
obtain the address of the function in the dll. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>However, to use these functions,
it is extremely important to know where kernel32.dll is loaded in memory.
Besides, anyone interested in writing shellcode must know the address of this
dll in memory. Once the location is identified, then the exports table of
various other dlls can be examined to expose the address of their functions. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>There are different ways to
tackle this issue, and this chapter touches on three simplest ways to do so. So
here we go, righto…<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>a.cpp<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>short fsregister;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov fsregister, fs<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;%x\n&quot;,fsregister);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>38<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>We have been in the computer
world way beyond the good old days of DOS. Therefore, we can make a statement
that Intel erred in the making of their 8086 processor. We will justify our
point. While accessing memory, the address or memory location must be put in a
register and therefore the register must be large enough to hold its address.
For this purpose, Intel closed on two 16-bit registers when it should have
given one 32-bit register instead. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thus, each pointer or memory
address was stored in two registers, one called the segment and the other the
offset. To get at the actual address, the segment register was to be multiplied
by 16 first and then added to the offset. The result would be a 20-bit address,
just enough to access 1 MB of RAM. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>This concept would be alien
to most programmers who started programming from 386 onwards as by then all
registers were 32 bits, thus forgoing the concept of segment-offset. The 80386
added two more segment registers to the four registers of 8086 (CS, DS, ES and
SS) viz, the FS and GS registers. These registers were to be used only by the
operating system internally. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The FS register is used to
point to an undocumented data structure that stores tons of useful information.
The cl compiler therefore restricts us from accessing this register. All
pointers are therefore with reference to the ds register, which points to the
data segment. Thus, we need some instructions in the assembler language to
reach the memory pointed by the fs segment register. The above program displays
the value of fsregister as 0x38. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Instead of returning a value
in the eax register, which is what we normally use, we create a variable of
type short called fsregister. Then, using the mov instruction the value of the
fs register is placed in it. This variable fsregister is then displayed using
the printf statement. If the data type of the variable was int and not short,
then an error would be seen since, the segment register is 16 bits wide. Also,
the assembler instruction of mov eax, fs, would show error since there would be
mismatch in size of the operands. Both operands of the mov must be of the same
size; register eax is 32 bits whereas fs is 16 bits large. Alternatively, the
mov could be given as mov ax, fs.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>We seriously hope that the
compiler in the next version allows accessing memory pointed to by the other
segment registers, then the assembler approach could be safely evaded.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes"> </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>a.cpp<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>short fsregister;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov fsregister, fs<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>//mov [fsregister], fs<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>//mov<span
style="mso-spacerun: yes">  </span>eax ,fs:[20h]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>unsigned long<span
style="mso-spacerun: yes">  </span>_stdcall abc(void *i)<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *pid = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Thread No %d
&quot;,i);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;fs=%x
Pid=%d\n&quot;,fsregister , pid);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>return 0;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)1,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)2,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)3,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>getchar();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 1 fs=38 Pid=1612<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 2 fs=38 Pid=1612<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 3 fs=38 Pid=1612<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Three threads are created
using the CreateThread function. This function takes 6 parameters and all are
given a value of 0 except two. The third parameter is for the name of the
function that is to be executed each time the thread is created and the fourth
parameter represents the parameter list. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>In abc, the RegisterValue
function plays a very important role. It returns the int stored at 20h bytes
from the start of the data structure pointed by the fs register. The syntax
fs:20h is similar to fs:[20h], where the square brackets denote a pointer
reference which is the default anyway. As a result of which if the brackets are
missing, the assembler does the needful. Ditto for variables.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The output displays three
statements since the abc function is called thrice. The pointer parameter i
shows the values 1,2 and 3 accordingly but the fs register has the same value. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Each program when executed
is given a unique pid or process id by the operating system. This can be easily
verified on pressing the keys Ctl-Alt-Del on the operating system and then
clicking on the button Task Manager. The tab Processes shows a list of programs
running on the system. The first column here is the name of the program
followed by its PID. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The above program does not
end unless the enter key is pressed as the system is waiting at the getchar()
function. Till then it is loaded in the memory and is assigned a unique pid.
The Task Manager, hence, shows program a.exe in memory with its pid 1612. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Clicking once on the name
tag sorts the program names alphabetically and then clicking once again
reverses the sort order. Not including the getchar() function would result in
the program quitting out thus not giving the threads a chance to complete. The
abc function would terminate without executing all the printfs.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>short fsregister;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov fsregister, fs<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>unsigned long<span
style="mso-spacerun: yes">  </span>_stdcall abc(void *i)<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *tibinfo =
RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Thread No %d
&quot;,i);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;fs=%x
tibinfo=%x\n&quot;,fsregister , tibinfo);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>return 0;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)1,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)2,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CreateThread(0,0,abc,(void
*)3,0,0);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>getchar();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 1 fs=38
tibinfo=7ffdd000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 2 fs=38
tibinfo=7ffdc000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thread No 3 fs=38
tibinfo=7ffdb000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The only variation here from
the previous one is that the value placed 18h from the fs register is
displayed. The earlier program displayed a value 20h away. The last program
displayed the same value for each thread as the process id of a thread is the
same. However here, the value displayed is that of a pointer that points to a
different area of memory for each thread.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>/*<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>typedef struct _NT_TIB {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>struct _EXCEPTION_REGISTRATION_RECORD *ExceptionList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>PVOID StackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>PVOID StackLimit;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>PVOID SubSystemTib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>union {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">        </span>PVOID FiberData;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">        </span>DWORD Version;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>PVOID ArbitraryUserPointer;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>struct _NT_TIB *Self;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>} NT_TIB;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>typedef struct _NT_TEB <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>NT_TIB
Tib;<span style="mso-spacerun: yes">                         </span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EnvironmentPointer;<span style="mso-spacerun: yes">           </span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>CLIENT_ID
Cid;<span style="mso-spacerun: yes">                      </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ActiveRpcInfo;<span style="mso-spacerun: yes">                </span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ThreadLocalStoragePointer;<span style="mso-spacerun: yes">    </span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PPEB
Peb;<span style="mso-spacerun: yes">                           </span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
LastErrorValue;<span style="mso-spacerun: yes">               </span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>ULONG CountOfOwnedCriticalSections; // 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
CsrClientThread;<span style="mso-spacerun: yes">             </span><span
style="mso-spacerun: yes"> </span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Win32ThreadInfo;<span style="mso-spacerun: yes">              </span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Win32ClientInfo[0x1F];<span style="mso-spacerun: yes">        </span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
WOW32Reserved;<span style="mso-spacerun: yes">                </span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
CurrentLocale;<span style="mso-spacerun: yes">                </span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
FpSoftwareStatusRegister;<span style="mso-spacerun: yes">     </span>// C8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID SystemReserved1[0x36];<span
style="mso-spacerun: yes">        </span>// CCh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Spare1;<span style="mso-spacerun: yes">                       </span>// 1A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LONG
ExceptionCode;<span style="mso-spacerun: yes">                 </span>// 1A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
SpareBytes1[0x28];<span style="mso-spacerun: yes">            </span>// 1ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SystemReserved2[0xA];<span style="mso-spacerun: yes">         </span>// 1D4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>GDI_TEB_BATCH GdiTebBatch;<span style="mso-spacerun: yes">         
</span>// 1FCh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
gdiRgn;<span style="mso-spacerun: yes">                       </span>// 6DCh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
gdiPen;<span style="mso-spacerun: yes">                       </span>// 6E0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
gdiBrush;<span style="mso-spacerun: yes">                     </span>// 6E4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>CLIENT_ID
RealClientId;<span style="mso-spacerun: yes">             </span>// 6E8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiCachedProcessHandle;<span style="mso-spacerun: yes">       </span>// 6F0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiClientPID;<span style="mso-spacerun: yes">                 </span>// 6F4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiClientTID;<span style="mso-spacerun: yes">                 </span>// 6F8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiThreadLocaleInfo;<span style="mso-spacerun: yes">          </span>// 6FCh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UserReserved[5];<span style="mso-spacerun: yes">              </span>// 700h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glDispatchTable[0x118];<span style="mso-spacerun: yes">       </span>// 714h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
glReserved1[0x1A];<span style="mso-spacerun: yes">            </span>// B74h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glReserved2;<span style="mso-spacerun: yes">                  </span>// BDCh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glSectionInfo;<span style="mso-spacerun: yes">                </span>// BE0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glSection;<span style="mso-spacerun: yes">                    </span>// BE4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glTable;<span style="mso-spacerun: yes">                      </span>// BE8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glCurrentRC;<span style="mso-spacerun: yes">  </span><span style="mso-spacerun:
yes">                </span>// BECh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
glContext;<span style="mso-spacerun: yes">                    </span>// BF0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>NTSTATUS
LastStatusValue;<span style="mso-spacerun: yes">           </span>// BF4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>UNICODE_STRING StaticUnicodeString; // BF8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>WCHAR
StaticUnicodeBuffer[0x105];<span style="mso-spacerun: yes">   </span>// C00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
DeallocationStack;<span style="mso-spacerun: yes">            </span>// E0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsSlots[0x40];<span style="mso-spacerun: yes">               </span>// E10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
TlsLinks;<span style="mso-spacerun: yes">                </span>// F10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Vdm;<span style="mso-spacerun: yes">                          </span>// F18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReservedForNtRpc;<span style="mso-spacerun: yes">             </span>// F1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
DbgSsReserved[0x2];<span style="mso-spacerun: yes">           </span>// F20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HardErrorDisabled;<span style="mso-spacerun: yes">            </span>// F28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Instrumentation[0x10];<span style="mso-spacerun: yes">        </span>// F2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
WinSockData;<span style="mso-spacerun: yes">                  </span>// F6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiBatchCount;<span style="mso-spacerun: yes">                </span>// F70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Spare2;<span style="mso-spacerun: yes">                       </span>// F74h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Spare3;<span style="mso-spacerun: yes">       </span><span style="mso-spacerun:
yes">                </span>// F78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Spare4;<span style="mso-spacerun: yes">                       </span>// F7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReservedForOle;<span style="mso-spacerun: yes">               </span>// F80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
WaitingOnLoaderLock;<span style="mso-spacerun: yes">          </span>// F84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
StackCommit;<span style="mso-spacerun: yes">                  </span>// F88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
StackCommitMax;<span style="mso-spacerun: yes">             </span><span
style="mso-spacerun: yes">  </span>// F8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
StackReserve;<span style="mso-spacerun: yes">                 </span>// F90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
MessageQueue;<span style="mso-spacerun: yes">                 </span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span>} NT_TEB, *PNT_TEB;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>*/<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;PEB=%x\n&quot;,peb);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB=7ffdf000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>From the little that we
learnt ourselves, we are very certain that the fs register points to a certain
structure in memory. As Microsoft refuses to divulge the internal structure
format, we can only assume what the format of this structure can be. However,
there are a large number of people on the net who have spent sleepless<span
style="mso-spacerun: yes">  </span>nights figuring out what these structures
could look like. Most people on the net give this structure a name, i.e. a Thread
Environment Block or TEB. So based on this structure, we have created a typedef
_NT_TEB for what the TEB would look like. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>This structure TEB starts
with another structure, which is presumed to be a Thread Information Block,
TIB. The last member of this internal structure positioned at 18h away from the
start is a pointer to a similar structure, that differs from thread to thread.
The member at 20h is the pid that was displayed earlier. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>As an exercise you can
display and decipher each of the members in the structure. These fields are
valid for Windows 2000 and are likely to be different for the 95/98 family. The
member at 30h is a pointer to a structure called the Process Environment Block
or PEB and on our machine, the PEB begins at memory location 7ffdf000.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, fs:[0xc4]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int CurrentLocale =
RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;CurrentLocale=%x\n&quot;,CurrentLocale);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>CurrentLocale=409<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The language that used with
the os on the computer is called the locale. The locale English has a value
0x409. The above program returns the member c4 from the start of the structure,
which stores the current locale.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB_LDR_DATA<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG Length;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>BOOLEAN
Initialized;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SsHandle;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InLoadOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InMemoryOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
InheritedAddressSpace;<span style="mso-spacerun: yes">                    
</span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
ReadImageFileExecOptions;<span style="mso-spacerun: yes">                 
</span>// 01h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
BeingDebugged;<span style="mso-spacerun: yes">                            
</span>// 02h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare;<span style="mso-spacerun: yes">                                    
</span>// 03h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Mutant;<span style="mso-spacerun: yes">                                   
</span>// 04h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ImageBaseAddress;<span style="mso-spacerun: yes">                         
</span>// 08h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>struct PEB_LDR_DATA *Ldr;<span style="mso-spacerun:
yes">                        </span>// 0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
ProcessParameters;<span style="mso-spacerun: yes">                       
</span>// 10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SubSystemData;<span style="mso-spacerun: yes">                            
</span>// 14h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessHeap;<span style="mso-spacerun: yes">      </span><span
style="mso-spacerun: yes">                         </span>// 18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
FastPebLock;<span style="mso-spacerun: yes">                              
</span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebLockRoutine;<span style="mso-spacerun: yes">              </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebUnlockRoutine;<span style="mso-spacerun: yes">            </span>// 24h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
EnvironmentUpdateCount;<span style="mso-spacerun: yes">                   
</span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes"> </span><span
style="mso-spacerun: yes">  </span>PVOID* KernelCallbackTable;<span
style="mso-spacerun: yes">                      </span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLogSection;<span style="mso-spacerun: yes">                          
</span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLog;<span style="mso-spacerun: yes">                                 
</span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FreeList;<span style="mso-spacerun: yes">                        </span>// 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsExpansionCounter;<span style="mso-spacerun: yes">                      
</span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsBitmap;<span style="mso-spacerun: yes">                                
</span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsBitmapBits[0x2];<span style="mso-spacerun: yes">                       
</span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryBase;<span style="mso-spacerun: yes">                 
</span>// 4Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryHeap;<span style="mso-spacerun: yes">        </span><span
style="mso-spacerun: yes">          </span>// 50h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
ReadOnlyStaticServerData;<span style="mso-spacerun: yes">                
</span>// 54h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
AnsiCodePageData;<span style="mso-spacerun: yes">                         
</span>// 58h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
OemCodePageData;<span style="mso-spacerun: yes">                          
</span>// 5Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UnicodeCaseTableData;<span style="mso-spacerun: yes">                     
</span>// 60h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfProcessors;<span style="mso-spacerun: yes">                       
</span>// 64h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NtGlobalFlag;<span style="mso-spacerun: yes">                             
</span>// 68h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare2[0x4];<span style="mso-spacerun: yes">                              
</span>// 6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>LARGE_INTEGER CriticalSectionTimeout;<span style="mso-spacerun:
yes">            </span>// 70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG HeapSegmentReserve;<span
style="mso-spacerun: yes">                        </span>// 78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentCommit;<span style="mso-spacerun: yes">                        
</span>// 7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitTotalFreeThreshold;<span style="mso-spacerun: yes">           
</span>// 80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitFreeBlockThreshold;<span style="mso-spacerun: yes">           
</span>// 84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfHeaps;<span style="mso-spacerun: yes">       </span><span
style="mso-spacerun: yes">                      </span>// 88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
MaximumNumberOfHeaps;<span style="mso-spacerun: yes">                     
</span>// 8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID**
ProcessHeaps;<span style="mso-spacerun: yes">                           
</span>// 90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiSharedHandleTable;<span style="mso-spacerun: yes">                     
</span>// 94h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessStarterHelper;<span style="mso-spacerun: yes">                </span><span
style="mso-spacerun: yes">      </span>// 98h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiDCAttributeList;<span style="mso-spacerun: yes">                       
</span>// 9Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
LoaderLock;<span style="mso-spacerun: yes">                               
</span>// A0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMajorVersion;<span style="mso-spacerun: yes">                           
</span>// A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMinorVersion;<span style="mso-spacerun: yes">                           
</span>// A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  </span><span
style="mso-spacerun: yes"> </span>ULONG OSBuildNumber;<span
style="mso-spacerun: yes">                             </span>// ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSPlatformId;<span style="mso-spacerun: yes">                             
</span>// B0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystem;<span style="mso-spacerun: yes">                           
</span>// B4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMajorVersion;<span style="mso-spacerun: yes">               
</span>// B8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG ImageSubSystemMinorVersion;<span
style="mso-spacerun: yes">                </span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiHandleBuffer[0x22];<span style="mso-spacerun: yes">                    
</span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessWindowStation;<span style="mso-spacerun: yes">                     
</span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB_LDR_DATA *ldr =
peb-&gt;Ldr;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;PEB=%x
Ldr=%x\n&quot;,peb,ldr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB=7ffdf000 Ldr=131e90<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>After the slight detour to
reach our destination, we decided to tell you that there exists a function
RegisterValue that gives the address of the PEB. This value is stored in a
variable peb. The structure PEB is once again undocumented. However our
interest lies in the member Ldr which is 0x1c from the start. This member is a
pointer to another structure PEB_LDR_DATA, again an undocumented one, with a
value of 0x131e90.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB_LDR_DATA<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Length;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>BOOLEAN
Initialized;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SsHandle;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>LIST_ENTRY InLoadOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>LIST_ENTRY InMemoryOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>LIST_ENTRY InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
InheritedAddressSpace;<span style="mso-spacerun: yes">                    
</span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
ReadImageFileExecOptions;<span style="mso-spacerun: yes">                 
</span>// 01h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>UCHAR BeingDebugged;<span style="mso-spacerun:
yes">                             </span>// 02h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR Spare;<span
style="mso-spacerun: yes">                                     </span>// 03h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Mutant;<span style="mso-spacerun: yes">                                   
</span>// 04h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>PVOID ImageBaseAddress;<span style="mso-spacerun:
yes">                          </span>// 08h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>struct PEB_LDR_DATA *Ldr;<span style="mso-spacerun:
yes">                        </span>// 0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>void * ProcessParameters;<span style="mso-spacerun:
yes">                        </span>// 10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SubSystemData;<span style="mso-spacerun: yes">                            
</span>// 14h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessHeap;<span style="mso-spacerun: yes">                              
</span>// 18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
FastPebLock;<span style="mso-spacerun: yes">                              
</span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebLockRoutine;<span style="mso-spacerun: yes">              </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebUnlockRoutine;<span style="mso-spacerun: yes">            </span>// 24h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
EnvironmentUpdateCount;<span style="mso-spacerun: yes">                   
</span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
KernelCallbackTable;<span style="mso-spacerun: yes">                     
</span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLogSection;<span style="mso-spacerun: yes">                          
</span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes"> </span><span
style="mso-spacerun: yes">  </span>PVOID EventLog;<span style="mso-spacerun:
yes">                                  </span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FreeList;<span style="mso-spacerun: yes">                        </span>// 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsExpansionCounter;<span style="mso-spacerun: yes">                      
</span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsBitmap;<span style="mso-spacerun: yes">                                
</span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsBitmapBits[0x2];<span style="mso-spacerun: yes">                       
</span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryBase;<span style="mso-spacerun: yes">                 
</span>// 4Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryHeap;<span style="mso-spacerun: yes">                 
</span>// 50h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
ReadOnlyStaticServerData;<span style="mso-spacerun: yes">                
</span>// 54h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
AnsiCodePageData;<span style="mso-spacerun: yes">                </span><span
style="mso-spacerun: yes">          </span>// 58h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
OemCodePageData;<span style="mso-spacerun: yes">                          
</span>// 5Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UnicodeCaseTableData;<span style="mso-spacerun: yes">                     
</span>// 60h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>ULONG NumberOfProcessors;<span style="mso-spacerun:
yes">                        </span>// 64h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NtGlobalFlag;<span style="mso-spacerun: yes">                             
</span>// 68h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare2[0x4];<span style="mso-spacerun: yes">                              
</span>// 6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>LARGE_INTEGER CriticalSectionTimeout;<span style="mso-spacerun:
yes">            </span>// 70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentReserve;<span style="mso-spacerun: yes">                       
</span>// 78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentCommit;<span style="mso-spacerun: yes">                        
</span>// 7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG HeapDeCommitTotalFreeThreshold;<span
style="mso-spacerun: yes">            </span>// 80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitFreeBlockThreshold;<span style="mso-spacerun: yes">           
</span>// 84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfHeaps;<span style="mso-spacerun: yes">                            
</span>// 88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
MaximumNumberOfHeaps;<span style="mso-spacerun: yes">                     
</span>// 8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID**
ProcessHeaps; <span style="mso-spacerun:
yes">                           </span>// 90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiSharedHandleTable;<span style="mso-spacerun: yes">                     
</span>// 94h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessStarterHelper;<span style="mso-spacerun: yes">                     
</span>// 98h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiDCAttributeList;<span style="mso-spacerun: yes">                       
</span>// 9Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
LoaderLock;<span style="mso-spacerun: yes">                     </span><span
style="mso-spacerun: yes">           </span>// A0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMajorVersion;<span style="mso-spacerun: yes">                           
</span>// A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMinorVersion;<span style="mso-spacerun: yes">                           
</span>// A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSBuildNumber;<span style="mso-spacerun: yes">                            
</span>// ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSPlatformId;<span style="mso-spacerun: yes">                             
</span>// B0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystem;<span style="mso-spacerun: yes">                           
</span>// B4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMajorVersion;<span style="mso-spacerun: yes">               
</span>// B8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMinorVersion;<span style="mso-spacerun: yes">               
</span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiHandleBuffer[0x22];<span style="mso-spacerun: yes">                    
</span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID ProcessWindowStation;<span
style="mso-spacerun: yes">                      </span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm int 3<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;BeingDebugged=%x\n&quot;,peb-&gt;BeingDebugged);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;ImageBaseAddress=%x\n&quot;,peb-&gt;ImageBaseAddress);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;NumberOfProcessors=%x\n&quot;,peb-&gt;NumberOfProcessors);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>BeingDebugged=1<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>ImageBaseAddress=400000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>NumberOfProcessors=1<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>This structure PEB has some
useful members so we decided to display some of them. The first is the
BeingDebugged member. This has a value of 1 or 0. The int 3 instruction
transports us to the debugger. Once we are in the debugger we step over all the
functions to get at the above output. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The member BeingDebugged now
has a value 1 since the program is being debugged otherwise the default is a
zero. The ImageBase member is 400000 as exe files in memory are loaded at that
location. As we are running on a single processor machine, the Number of
Processors is 1. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>You can take the benefit of
displaying the other members of the structure PEB at your leisure.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>/*<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct LIST_ENTRY {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>*/<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB_LDR_DATA<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Length;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>BOOLEAN
Initialized;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SsHandle;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InLoadOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InMemoryOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
InheritedAddressSpace;<span style="mso-spacerun: yes">                    
</span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
ReadImageFileExecOptions;<span style="mso-spacerun: yes">                 
</span>// 01h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
BeingDebugged;<span style="mso-spacerun: yes">                            
</span>// 02h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare;<span style="mso-spacerun: yes">                                    
</span>// 03h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Mutant;<span style="mso-spacerun: yes">                                   
</span>// 04h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ImageBaseAddress;<span style="mso-spacerun: yes">                         
</span>// 08h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>struct PEB_LDR_DATA *Ldr;<span style="mso-spacerun:
yes">                        </span>// 0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
ProcessParameters;<span style="mso-spacerun: yes">                       
</span>// 10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SubSystemData;<span style="mso-spacerun: yes">                            
</span>// 14h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessHeap;<span style="mso-spacerun: yes">                              
</span>// 18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
FastPebLock;<span style="mso-spacerun: yes">   </span><span
style="mso-spacerun: yes">                            </span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebLockRoutine;<span style="mso-spacerun: yes">              </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebUnlockRoutine;<span style="mso-spacerun: yes">            </span>// 24h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
EnvironmentUpdateCount;<span style="mso-spacerun: yes">                   
</span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
KernelCallbackTable;<span style="mso-spacerun: yes">                     
</span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLogSection;<span style="mso-spacerun: yes">                          
</span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLog;<span style="mso-spacerun: yes">                                 
</span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FreeList;<span style="mso-spacerun: yes">                        </span>// 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsExpansionCounter;<span style="mso-spacerun: yes">                      
</span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsBitmap;<span style="mso-spacerun: yes">    </span><span style="mso-spacerun:
yes">                             </span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsBitmapBits[0x2];<span style="mso-spacerun: yes">                       
</span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryBase;<span style="mso-spacerun: yes">                 
</span>// 4Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryHeap;<span style="mso-spacerun: yes">                 
</span>// 50h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
ReadOnlyStaticServerData;<span style="mso-spacerun: yes">    </span><span
style="mso-spacerun: yes">             </span>// 54h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
AnsiCodePageData;<span style="mso-spacerun: yes">                         
</span>// 58h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
OemCodePageData;<span style="mso-spacerun: yes">                          
</span>// 5Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UnicodeCaseTableData;<span style="mso-spacerun: yes">                     
</span>// 60h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfProcessors;<span style="mso-spacerun: yes">                       
</span>// 64h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NtGlobalFlag;<span style="mso-spacerun: yes">                             
</span>// 68h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare2[0x4];<span style="mso-spacerun: yes">                              
</span>// 6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>LARGE_INTEGER CriticalSectionTimeout;<span style="mso-spacerun:
yes">            </span>// 70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentReserve;<span style="mso-spacerun: yes">                       
</span>// 78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG HeapSegmentCommit;<span
style="mso-spacerun: yes">                         </span>// 7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitTotalFreeThreshold;<span style="mso-spacerun: yes">           
</span>// 80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitFreeBlockThreshold;<span style="mso-spacerun: yes">           
</span>// 84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfHeaps;<span style="mso-spacerun: yes">                            
</span>// 88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
MaximumNumberOfHeaps;<span style="mso-spacerun: yes">                     
</span>// 8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID**
ProcessHeaps;<span style="mso-spacerun: yes">                           
</span>// 90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiSharedHandleTable;<span style="mso-spacerun: yes">                     
</span>// 94h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessStarterHelper;<span style="mso-spacerun: yes">                     
</span>// 98h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiDCAttributeList;<span style="mso-spacerun: yes">               </span><span
style="mso-spacerun: yes">         </span>// 9Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
LoaderLock;<span style="mso-spacerun: yes">                               
</span>// A0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMajorVersion;<span style="mso-spacerun: yes">                           
</span>// A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMinorVersion;<span style="mso-spacerun: yes">                           
</span>// A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSBuildNumber;<span style="mso-spacerun: yes">                            
</span>// ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSPlatformId;<span style="mso-spacerun: yes">                             
</span>// B0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystem;<span style="mso-spacerun: yes">                           
</span>// B4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMajorVersion;<span style="mso-spacerun: yes">               
</span>// B8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMinorVersion;<span style="mso-spacerun: yes">               
</span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiHandleBuffer[0x22];<span style="mso-spacerun: yes">                    
</span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessWindowStation;<span style="mso-spacerun: yes">                     
</span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB_LDR_DATA *ldr =
peb-&gt;Ldr;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>LIST_ENTRY flist;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;PEB=%x
Ldr=%x\n&quot;,peb,ldr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>flist =
ldr-&gt;InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Flink=%p
Blink=%p Start=%p\n&quot;,flist.Flink,flist.Blink,&amp;flist);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Output<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB=7ffdf000 Ldr=131e90<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Flink=00131F38
Blink=00132470 Start=0012FF74<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Our goal of finding out the address
of kernel32.dll using undocumented structures is now reachable. The peb
variable points to a structure whose member ldr points to another structure
PEB_LDR_DATA as explained before. This structure has an internal structure
InInitializationOrderModuleList that is of tag LIST_ENTRY, it is not a pointer.
<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>There are two more
structures however, our interest lies only in the third such structure. This
structure is defined in winnt.h and in turn starts with two pointers to similar
structures LIST_ENTRY. These members are called Flink and Blink. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Whenever a list is to be
stored in memory, a linked-list is used where one member of the structure
points to a similar such structure in memory. Ours is a forward one-direction
linked-list, however it can be modified to be bi-directional also. In such a
case, the list can be traversed up and down, thus requiring two members, one
keeping track of a similar structure in memory in the forward direction and the
second member in the reverse direction. Two members, Flink and Blink can be
introduced where Flink is for forward and Blink for backwards.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The Flink member points to
memory location 00131F38 where one such structure begins. The Blink member has
an address value of 00132470 where the last structure begins. Also, the first
structure InInitializationOrderModuleList begins at memory location 0012FF74.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>/*<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct LIST_ENTRY {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>*/<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB_LDR_DATA<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG Length;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>BOOLEAN
Initialized;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SsHandle;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InLoadOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InMemoryOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
InheritedAddressSpace;<span style="mso-spacerun: yes">                    
</span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
ReadImageFileExecOptions;<span style="mso-spacerun: yes">                 
</span>// 01h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
BeingDebugged;<span style="mso-spacerun: yes">                            
</span>// 02h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare;<span style="mso-spacerun: yes">                                    
</span>// 03h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Mutant;<span style="mso-spacerun: yes">                                   
</span>// 04h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ImageBaseAddress;<span style="mso-spacerun: yes">                         
</span>// 08h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>struct PEB_LDR_DATA *Ldr;<span style="mso-spacerun:
yes">                        </span>// 0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
ProcessParameters;<span style="mso-spacerun: yes">                       
</span>// 10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SubSystemData;<span style="mso-spacerun: yes">                            
</span>// 14h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessHeap;<span style="mso-spacerun: yes">         </span><span
style="mso-spacerun: yes">                      </span>// 18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
FastPebLock;<span style="mso-spacerun: yes">                              
</span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebLockRoutine;<span style="mso-spacerun: yes">              </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebUnlockRoutine;<span style="mso-spacerun: yes">            </span>// 24h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
EnvironmentUpdateCount;<span style="mso-spacerun: yes">                   
</span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
KernelCallbackTable;<span style="mso-spacerun: yes">                     
</span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLogSection;<span style="mso-spacerun: yes">                          
</span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLog;<span style="mso-spacerun: yes">                                 
</span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FreeList;<span style="mso-spacerun: yes">                        </span>// 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsExpansionCounter;<span style="mso-spacerun: yes">                      
</span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsBitmap;<span style="mso-spacerun: yes">                                
</span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsBitmapBits[0x2];<span style="mso-spacerun: yes">                       
</span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryBase;<span style="mso-spacerun: yes">                 
</span>// 4Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryHeap;<span style="mso-spacerun: yes">           </span><span
style="mso-spacerun: yes">       </span>// 50h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
ReadOnlyStaticServerData;<span style="mso-spacerun: yes">                
</span>// 54h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
AnsiCodePageData;<span style="mso-spacerun: yes">                         
</span>// 58h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
OemCodePageData;<span style="mso-spacerun: yes">                          
</span>// 5Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UnicodeCaseTableData;<span style="mso-spacerun: yes">                     
</span>// 60h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes"> </span><span
style="mso-spacerun: yes">  </span>ULONG NumberOfProcessors;<span
style="mso-spacerun: yes">                        </span>// 64h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NtGlobalFlag;<span style="mso-spacerun: yes">                             
</span>// 68h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare2[0x4];<span style="mso-spacerun: yes">                              
</span>// 6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>LARGE_INTEGER CriticalSectionTimeout;<span style="mso-spacerun:
yes">            </span>// 70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentReserve;<span style="mso-spacerun: yes">                       
</span>// 78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentCommit;<span style="mso-spacerun: yes">                        
</span>// 7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitTotalFreeThreshold;<span style="mso-spacerun: yes">           
</span>// 80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitFreeBlockThreshold;<span style="mso-spacerun: yes">           
</span>// 84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfHeaps;<span style="mso-spacerun: yes">          </span><span
style="mso-spacerun: yes">                   </span>// 88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
MaximumNumberOfHeaps;<span style="mso-spacerun: yes">                     
</span>// 8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID**
ProcessHeaps;<span style="mso-spacerun: yes">                           
</span>// 90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiSharedHandleTable;<span style="mso-spacerun: yes">                     
</span>// 94h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessStarterHelper;<span style="mso-spacerun: yes">                   </span><span
style="mso-spacerun: yes">   </span>// 98h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiDCAttributeList;<span style="mso-spacerun: yes">                       
</span>// 9Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
LoaderLock;<span style="mso-spacerun: yes">                               
</span>// A0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMajorVersion;<span style="mso-spacerun: yes">                           
</span>// A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMinorVersion;<span style="mso-spacerun: yes">                           
</span>// A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSBuildNumber;<span style="mso-spacerun: yes">                            
</span>// ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSPlatformId;<span style="mso-spacerun: yes">                             
</span>// B0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystem;<span style="mso-spacerun: yes">                           
</span>// B4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMajorVersion;<span style="mso-spacerun: yes">               
</span>// B8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMinorVersion;<span style="mso-spacerun: yes">               
</span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiHandleBuffer[0x22];<span style="mso-spacerun: yes">                    
</span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessWindowStation;<span style="mso-spacerun: yes">                     
</span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB_LDR_DATA *ldr =
peb-&gt;Ldr;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>LIST_ENTRY
flist,slist,tlist;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;PEB=%x
Ldr=%x\n&quot;,peb,ldr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>flist =
ldr-&gt;InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;First Flink=%p
Blink=%p Start=%p\n&quot;,flist.Flink,flist.Blink,&amp;ldr-&gt;InInitializationOrderModuleList);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>slist = *flist.Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Second Flink=%p
Blink=%p Start=%p\n&quot;,slist.Flink,slist.Blink,flist.Flink);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>tlist = *flist.Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Third Flink=%p
Blink=%p Start=%p\n&quot;,tlist.Flink,tlist.Blink,flist.Blink);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB=7ffdf000 Ldr=131e90<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>First Flink=00131F38
Blink=00132470 Start=00131EAC<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Second Flink=00132470
Blink=00131EAC Start=00131F38<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Third Flink=00131EAC
Blink=00131F38 Start=00132470<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes"> </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Lets us now understand the
internals of this structure LIST_ENTRY. The first structure starts at 00131F38
denoted by the Flink member and the first LIST_ENTRY structure starts at
00131EAC. A structure slist is created that is pointed to by the Flink
variable. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The value displayed by the
Flink member is 00132470 thus telling the location of third structure. However
the Blink variable has a value 00131EAC as it points backwards to the previous
structure. The tlist structure starts at 00131F38. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Here the Flink member points
to 00131EAC, which is the first structure called
InInitializationOrderModuleList. This completes a full circle. The Blink
variable of tlist points to the previous structure at 00131f38. Thus using the
Flink members, we come a full circle in the forward direction. The Blink
members also take us through a full circle but in the reverse direction.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>/*<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct LIST_ENTRY {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">   </span>struct _LIST_ENTRY *Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>*/<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB_LDR_DATA <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
Length;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>BOOLEAN
Initialized;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SsHandle;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY InLoadOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InMemoryOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>LIST_ENTRY
InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
InheritedAddressSpace;<span style="mso-spacerun: yes">                    
</span>// 00h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
ReadImageFileExecOptions;<span style="mso-spacerun: yes">                 
</span>// 01h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
BeingDebugged;<span style="mso-spacerun: yes">                            
</span>// 02h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare;<span style="mso-spacerun: yes">                                    
</span>// 03h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
Mutant;<span style="mso-spacerun: yes">                                   
</span>// 04h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ImageBaseAddress;<span style="mso-spacerun: yes">                         
</span>// 08h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">         </span>struct PEB_LDR_DATA *Ldr;<span style="mso-spacerun:
yes">                        </span>// 0Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
ProcessParameters;<span style="mso-spacerun: yes">                       
</span>// 10h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
SubSystemData;<span style="mso-spacerun: yes">                            
</span>// 14h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessHeap;<span style="mso-spacerun: yes">                              
</span>// 18h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
FastPebLock;<span style="mso-spacerun: yes">              </span><span
style="mso-spacerun: yes">                 </span>// 1Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebLockRoutine;<span style="mso-spacerun: yes">              </span>// 20h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FastPebUnlockRoutine;<span style="mso-spacerun: yes">            </span>// 24h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
EnvironmentUpdateCount;<span style="mso-spacerun: yes">                   
</span>// 28h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
KernelCallbackTable;<span style="mso-spacerun: yes">                     
</span>// 2Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID EventLogSection;<span
style="mso-spacerun: yes">                           </span>// 30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
EventLog;<span style="mso-spacerun: yes">                                 
</span>// 34h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>void *
FreeList;<span style="mso-spacerun: yes">                        </span>// 38h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsExpansionCounter;<span style="mso-spacerun: yes">                      
</span>// 3Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
TlsBitmap;<span style="mso-spacerun: yes">               </span><span
style="mso-spacerun: yes">                  </span>// 40h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
TlsBitmapBits[0x2];<span style="mso-spacerun: yes">                       
</span>// 44h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryBase;<span style="mso-spacerun: yes">                 
</span>// 4Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ReadOnlySharedMemoryHeap;<span style="mso-spacerun: yes">                 
</span>// 50h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID*
ReadOnlyStaticServerData;<span style="mso-spacerun: yes">               </span><span
style="mso-spacerun: yes">  </span>// 54h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
AnsiCodePageData;<span style="mso-spacerun: yes">                         
</span>// 58h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
OemCodePageData;<span style="mso-spacerun: yes">                          
</span>// 5Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
UnicodeCaseTableData;<span style="mso-spacerun: yes">                     
</span>// 60h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfProcessors;<span style="mso-spacerun: yes">                       
</span>// 64h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NtGlobalFlag;<span style="mso-spacerun: yes">                             
</span>// 68h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>UCHAR
Spare2[0x4];<span style="mso-spacerun: yes">                              
</span>// 6Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">  
</span>LARGE_INTEGER CriticalSectionTimeout;<span style="mso-spacerun:
yes">            </span>// 70h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentReserve;<span style="mso-spacerun: yes">                       
</span>// 78h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapSegmentCommit;<span style="mso-spacerun: yes">                        
</span>// 7Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitTotalFreeThreshold;<span style="mso-spacerun: yes">           
</span>// 80h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
HeapDeCommitFreeBlockThreshold;<span style="mso-spacerun: yes">           
</span>// 84h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
NumberOfHeaps;<span style="mso-spacerun: yes">                            
</span>// 88h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
MaximumNumberOfHeaps;<span style="mso-spacerun: yes">        </span><span
style="mso-spacerun: yes">              </span>// 8Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID**
ProcessHeaps;<span style="mso-spacerun: yes">                           
</span>// 90h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiSharedHandleTable;<span style="mso-spacerun: yes">                     
</span>// 94h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessStarterHelper;<span style="mso-spacerun: yes">                     
</span>// 98h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
GdiDCAttributeList;<span style="mso-spacerun: yes">                       
</span>// 9Ch<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
LoaderLock;<span style="mso-spacerun: yes">                               
</span>// A0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMajorVersion;<span style="mso-spacerun: yes">                           
</span>// A4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSMinorVersion;<span style="mso-spacerun: yes">                           
</span>// A8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSBuildNumber;<span style="mso-spacerun: yes">                            
</span>// ACh<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
OSPlatformId;<span style="mso-spacerun: yes">                             
</span>// B0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystem;<span style="mso-spacerun: yes">                           
</span>// B4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMajorVersion;<span style="mso-spacerun: yes">               
</span>// B8h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
ImageSubSystemMinorVersion;<span style="mso-spacerun: yes">               
</span>// C0h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>ULONG
GdiHandleBuffer[0x22];<span style="mso-spacerun: yes">                    
</span>// C4h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style='mso-tab-count:
1'>                </span><span style="mso-spacerun: yes">   </span>PVOID
ProcessWindowStation;<span style="mso-spacerun: yes">                     
</span>// ???<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct PEB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax ,fs:30h<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB *peb = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB_LDR_DATA *ldr =
peb-&gt;Ldr;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>LIST_ENTRY
flist,slist,tlist;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>HMODULE ntdll,kernel32;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;PEB=%x
Ldr=%x\n&quot;,peb,ldr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>flist =
ldr-&gt;InInitializationOrderModuleList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;First Flink=%p
Blink=%p
Start=%p\n&quot;,flist.Flink,flist.Blink,&amp;ldr-&gt;InInitializationOrderModuleList);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>slist = *flist.Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Second Flink=%p
Blink=%p Start=%p\n&quot;,slist.Flink,slist.Blink,flist.Flink);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>tlist = *flist.Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Third Flink=%p
Blink=%p Start=%p\n&quot;,tlist.Flink,tlist.Blink,flist.Blink);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>ntdll =
LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>kernel32 =
LoadLibrary(&quot;kernel32.dll&quot;);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
ntdll=%p kernel32=%p\n&quot;,ntdll,kernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int **dummy;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy<span
style="mso-spacerun: yes">  </span>= (int **)flist.Flink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy++; dummy++;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Adress of
ntdll.dll=%x\n&quot;,*dummy);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy<span
style="mso-spacerun: yes">  </span>= (int **)flist.Blink;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy++; dummy++;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Adress of
kernel32.dll=%x\n&quot;,*dummy);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PEB=7ffdf000 Ldr=131e90<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>First Flink=00131F38
Blink=00132470 Start=00131EAC<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Second Flink=00132470
Blink=00131EAC Start=00131F38<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Third Flink=00131EAC
Blink=00131F38 Start=00132470<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Address of ntdll=77F80000
kernel32=77E80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Adress of ntdll.dll=77f80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Adress of
kernel32.dll=77e80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>This program finally helps
us meet our goal, i.e it prints out the address of kernel32 in memory. We start
as always by displaying the PEB pointer and the address of the three LIST_ENTRY
structures. Then using the function LoadLibrary, the address of kernel32.dll in
memory is obtained which on our version of Windows 2000 Service pack 2 is
77e80000. The address of ntdll.dll is also displayed which happens to be
77f80000. Both these dll’s are loaded before the user gains control of windows.
This is how important they are to the internals of windows. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Thereafter a pointer
variable dummy is created that points to the first LIST_ENTRY structure in
memory which is at 00131F38. This variable is incremented by 8 thus it moves
across the first two members Flink and Blink. The value stored here is the
address of ntdll.dll in memory. The second LIST_ENTRY structure gives the
address of the kernel32.dll in memory. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>To reach out to the second LIST_ENTRY
structure, either the Flink member can be moved ahead to another or the dummy
variable could point to the value of Blink which is the address of the previous
structure. Remember there are only three LIST_ENTRY structures, one of them is
part of the PEB_LDR_DATA structure. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The first member after the
Flink and Blink members is the address of the dll loaded in memory. The above
example declares that Windows only loads two dll’s in memory at the above
addresses. Remember all the above is undocumented thus the credit goes to
someone somewhere in the world who figured it out without Microsoft’s help.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>push esi<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">   </span>eax, fs:[0x30]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">   </span>eax, [eax + 0x0c]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">   </span>esi, [eax + 0x1c]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>lodsd <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">   </span>eax, [eax + 0x8]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pop esi<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *addr =
RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
kernel32=%p\n&quot;,addr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Address of kernel32=77E80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The above program performs
the same job as the previous one. It returns the address of kernel32.dll in
memory but uses pure assembler. Remember while using pure assembler to give us
the address of kernel32 in memory, we will be<span style="mso-spacerun: yes"> 
</span>using shellcode.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>In assembler, prior to using
any of the register, its value is first saved on the stack. Thus every assembler
function starts off by saving the registers it is going to use on the stack.
Since we are using only the esi register, its value is first pushed on the
stack. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The return value is always
stored in the eax register. Thus its value is bound to change if the function
returns a value, so we push eax on the stack. Tthe pointer at 30h from the fs
register or the PEB is placed in the eax register. Once done, we then need the
pointer to the LDR data stored 0ch bytes within the PEB. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Once again the pointer
called Ldr is placed in the eax register. Then the address of the third
LIST_ENTRY structure InInitializationOrderModuleList in the esi register is
required. The lodsd instruction takes 4 bytes pointed to by the esi register
and places it in the eax register. At this point in time the esi register
contains the value 131F38. This is where the second structure starts. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The lodsd instruction
increases the value of esi by 4 and the eax register now contains the value
132470. Thus the eax register takes the value of the Flink member or the
address of the second LIST_ENTRY structure. The first structure has the details
of ntdll.dll. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>An addition of 8 will skip
the Blink and Flink members and reach at the address of kernel32 in memory.
Thus, we add 8 to the address of the start of the structure. The pointer stored
in this address is placed in the eax register. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The assembler program is a
little more difficult to understand as it deals with offsets but is smaller and
more concise. The square brackets in assembler are the equivalent of a * or
pointers in C.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *tib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, fs:[0x18]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>ebx, fs:[0]<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov [tib] , ebx<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>void *tib1 =
RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;%x
%x\n&quot;,tib,tib1);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>12ffb0 7ffde000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>As mentioned earlier, there
is a structure that the fs register points to called TEB. This structure
starts<span style="mso-spacerun: yes">  </span>with another structure TIB that
starts with a pointer to some exception handling structures. The last member of
the TIB structure points to another similar structure. The address of this
structure is displayed. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>This had been seen in one of
the previous programs where the member had a unique value for each thread. The
next program uses this thread info to regain another method in order to reach
to the address of kernel32 in memory. Once again not documented.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes"> </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct NTTIB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct
_EXCEPTION_REGISTRATION_RECORD *ExceptionList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID StackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID StackLimit;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID SubSystemTib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>union<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID FiberData;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>DWORD Version;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID ArbitraryUserPointer;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct NTTIB *Self;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}; <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>NTTIB *RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, fs:[0x18]<span style="mso-spacerun:
yes">     </span>// Extract TEB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>NTTIB *ptib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>char *pkernel32;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>char *pStackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>long dummy;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>ptib =<span
style="mso-spacerun: yes">  </span>RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pStackBase = (char
*)ptib-&gt;StackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;TIB=%x
StackBase=%x\n&quot;,ptib,pStackBase);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pStackBase = pStackBase -
0x1c;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32 = *(char
**)pStackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;StackBase=%x
Initial Address of kernel32=%x\n&quot;,pStackBase,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>while (*pkernel32 != 'M' &amp;&amp;
*(pkernel32+1) != 'Z')<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32--;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Before
pkernel32=%x &quot;,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy = (long)pkernel32;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy = dummy &amp;
0xFFFF0000;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32 = (char *)dummy;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;After
pkernel32=%x \n&quot;,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
kernel32=%x\n&quot;,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>TIB=7ffde000
StackBase=130000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>StackBase=12ffe4 Initial
Address of kernel32=77e8615b<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Before pkernel32=77e8615a
After pkernel32=77e80000 <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Address of kernel32=77e80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The program starts by extracting
the pointer to the TEB stored at 18h as before. This is a pointer to a
structure NTTIB which is shown above. Thus the ptib variable contains the value
7ffde000. This pointer is then used to get at the member StackBase that gives
the base of where our stack starts. We get the StackBase as 130000. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Now undocumented research
has told us that there is a pointer 1c from the stack of the StackBase. We
therefore subtract 1ch from the StackBase variable to get a value of 12ffe4. At
this location is stored some address that points into kernel32. In our case
this initial address is 77e8615b. This information however is no help as what
we are interested in is the start of kernel32. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Now every PE file under
windows will start with the bytes M and Z and Windows loads a PE file at a
multiple of 64K. Armed with this knowledge we can now quickly get the starting
address of kernel32. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>We use a while loop where we
keep looping until the first two bytes that the variable pkernel32 point to are
not M and Z. We subtract 1 from this variable and then use bitwise anding to
zero out the first or lower 16 bits. This is because kernel32 or any dll will
be found at an address divisible by 64K. Thus there is no need to check all
memory for characters M and Z, except for checking chunks of 64K. As pkernel32
is a pointer we store its value into a long and then bit wise and it. In this
case the loop is not required. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes"> </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int abc()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>push esi<span
style="mso-spacerun: yes">               </span>// save esi as its value is
being overwritten<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>esi, fs:[0x18]<span style="mso-spacerun:
yes">    </span>// TEB is stored here<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>lodsd<span
style="mso-spacerun: yes">                  </span>// First pointer is not
used. ESI is incremented by 4<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>lodsd<span
style="mso-spacerun: yes">                  </span>// Stack base is second
member of structure<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, [eax - 0x1c] // A pointer is stored 1C
from stack base<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>loop_back: <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dec<span
style="mso-spacerun: yes">  </span>eax<span style="mso-spacerun:
yes">                      </span>// Move down by one page<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>xor<span
style="mso-spacerun: yes">  </span>ax, ax<span style="mso-spacerun:
yes">                   </span>// Zero out the first 16 bits<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>cmp<span
style="mso-spacerun: yes">  </span>word ptr [eax], 0x5a4d<span
style="mso-spacerun: yes">   </span>// Chaeck if bytes at page boundary are MZ<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>jne<span
style="mso-spacerun: yes">  </span>loop_back<span style="mso-spacerun: yes"> 
</span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pop esi<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int addr = abc();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
kernel32=%x\n&quot;,addr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Address of kernel32=77e80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The C program in given in
assembler. Remember it is an alternative method in acquiring the address of
kernel32.dll in memory. The next two programs showcase the third way of finding
the address of kernel32.dll in memory. Once again in C and then in assembler. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>All the registers to be used
are saved on the stack with the exception of eax. The address of the pointer
called Self is stored in the esi register. The structure TIB that it points to
starts with a pointer to a exception handling structure, explained in the
coming programs . Thus the first lodsd will load this structures address in the
eax register. After incrementing esi by 4, it will point to the second member
StackBase. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The second lodsd will load
this value into the eax register. We need a pointer 1Ch from this stack base
which we again store in the eax register. This pointer as mentioned earlier is
an address within kernel32.dll. We now decrement this location within kernel32
and also zero out the first 16 bits by xoring ax and not eax with itself. A
faster method of zeroing out a register is by xoring it with itself. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>A check is performed whether
the word at the memory denoted by eax is M and Z. If it is not equal to MZ, then
the jne or jump if not equal will loop back to the label loop_back. A label in
assembler is a word with a colon at the end. There are a trillion such<span
style="mso-spacerun: yes">  </span>opcodes like jne etc. Then again, this loop
is unnecessary like the while of the C code. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct NTTIB<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct
_EXCEPTION_REGISTRATION_RECORD *ExceptionList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID StackBase;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID StackLimit;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>PVOID SubSystemTib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>union {<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">        </span>PVOID FiberData;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">        </span>DWORD Version;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>PVOID ArbitraryUserPointer;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><span style="mso-spacerun:
yes">    </span>struct NTTIB *Self;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>};<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct NTTIB
*RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, fs:[0] <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>NTTIB *ptib;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>char *pkernel32;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int next;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int **pfn;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>struct
_EXCEPTION_REGISTRATION_RECORD *list;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>long dummy;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>ptib = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>list =
ptib-&gt;ExceptionList;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;tib=%x
list=%x\n&quot;,ptib,list);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>next = *(int *)list;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pfn = (int **)list;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Next handler=%x
pfn=%p\n&quot;,next,pfn);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pfn++;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32 = (char *)*pfn;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Initial Address
in kernel32=%x\n&quot;,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>while (*pkernel32 != 'M'
&amp;&amp; *(pkernel32+1) != 'Z')<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32--;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy = (long)pkernel32;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dummy = dummy &amp;
0xFFFF0000;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pkernel32 = (char *)dummy;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
kernel32=%x\n&quot;,pkernel32);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>tib=12ffb0 list=12ffe0<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Next handler=ffffffff
pfn=0012FFE4<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Initial Address in
kernel32=77e8615b<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>Address of kernel32=77e80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>In the third and final
method of finding the address of kernel32 in memory we use the exception
handling structures. We start with the address of the main TIB structure at
12ffb0. We then snag the first member ExceptionList which is pointer to a
documented structure _EXCEPTION_REGISTRATION_RECORD. Its internals are yet
undisclosed<span style="mso-spacerun: yes">  </span>but we know that this
structure begins at 12ffe0. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The first member of this
structure is a pointer to a similar structure whose value is stored in the
variable next. These structures are in a linked list and the last such
structure or handler has a value of 0xffffffff. In our case this structure is
the last. Generally we would need to loop the linked list and quit out on the
last one. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>The next variable displays
ffffffff. The list variable now points to the last exception handling
structure. We store its value in an int ** variable pfn as we are interested in
a value 4 bytes away or the second member. At this location is stored a pointer
into kernel32 in memory. We then use the same method that we used earlier to
get at the starting address of kernel32.dll. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>#include &lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int RegisterValue()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>__asm<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>push ecx<span
style="mso-spacerun: yes">                      </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>xor<span
style="mso-spacerun: yes">  </span>ecx, ecx<span style="mso-spacerun:
yes">                 </span>// Zero out ecx<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>esi, fs:[0]<span style="mso-spacerun: yes"> 
</span><span style="mso-spacerun: yes">            </span>// First Entry <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>not<span
style="mso-spacerun: yes">  </span>ecx<span style="mso-spacerun:
yes">                      </span>// ecx set to 0xffffffff last handler<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>lodsd<span
style="mso-spacerun: yes">                         </span>// First member is a
pointer<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>esi, eax<span style="mso-spacerun:
yes">                 </span>// Move into esi<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>cmp<span
style="mso-spacerun: yes">  </span>[eax], ecx<span style="mso-spacerun:
yes">               </span>// Our next-handler is 0xffffffff? so no loop<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>mov<span
style="mso-spacerun: yes">  </span>eax, [eax + 0x04]<span style="mso-spacerun:
yes">        </span>// A pointer is stored 4 bytes way<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>loop_again:<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>dec<span
style="mso-spacerun: yes">  </span>eax<span style="mso-spacerun:
yes">                      </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>xor<span
style="mso-spacerun: yes">  </span>ax, ax<span style="mso-spacerun:
yes">                   </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>cmp<span
style="mso-spacerun: yes">  </span>word ptr [eax], 0x5a4d<span
style="mso-spacerun: yes">   </span><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>jne<span
style="mso-spacerun: yes">  </span>loop_again <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>pop ecx<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>main()<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>{<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>int addr = RegisterValue();<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>printf(&quot;Address of
kernel32=%x\n&quot;,addr);<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'>}<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
mso-fareast-font-family:"MS Mincho";color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'>Address of kernel32=77e80000<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'>The same C program is now in assembler. Since the ecx register
is used, its value is first saved on the stack. We zero out not by storing 0 in
it but by xoring it to itself. We then store the pointer in esi. As the value
of ecx is zero, using the not instruction will change all the 0 to one’s and
thus making the registers value ffffffff. <o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'>This approach is faster than setting the value directly. T</span><span
style='font-family:"Palatino Linotype";mso-fareast-font-family:"MS Mincho";
color:#000066'>he lodsd instruction is used to load the pointer to the next
exception structure in eax. This value is then moved into esi. Then this first
member is checked to be all F’s or the last exception structure. If it is not
true then we jump back to the lodsd. There is no need for a loop. The pointer
stored 4 bytes away points inside kernel32.dll and using the same loop like
before, we reach the starting address of kernel32.dll in memory.<o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoPlainText style='text-align:justify'><b><a href="../../security.html">Back
to the main page<span style='font-weight:normal'><o:p></o:p></span></a></b></p>

<p class=MsoPlainText style='text-align:justify'><span style='font-family:"Palatino Linotype";
color:#000066'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

</div>

</body>


<!-- Mirrored from www.vijaymukhi.com/security/windows/kernel.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:40:20 GMT -->
</html>
